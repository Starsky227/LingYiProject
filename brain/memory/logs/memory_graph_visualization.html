<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ËÆ∞ÂøÜÂõæË∞±ÂèØËßÜÂåñ</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 10px;
            text-align: center;
        }
        
        .container {
            display: flex;
            height: calc(100vh - 50px);
        }
        
        .sidebar {
            width: 280px;
            background: white;
            padding: 15px;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            overflow-y: auto;
        }
        
        .menu-bar {
            flex: 1;
            position: relative;
        }
        
        #graph-container {
            width: 100%;
            height: 100%;
            background: white;
        }
        
        .stat-card {
            background: #f8f9fa;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 12px;
            border-left: 3px solid #667eea;
        }
        
        .stat-title {
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }
        
        .stat-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 14px;
        }
        
        .node-details {
            background: #fff;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            border: 1px solid #e0e0e0;
            display: none;
        }
        
        .detail-title {
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
            border-bottom: 1px solid #e0e0e0;
            padding-bottom: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .detail-title .close-detail-btn {
            background: none;
            border: none;
            color: #999;
            cursor: pointer;
            font-size: 18px;
            padding: 0;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        
        .detail-title .close-detail-btn:hover {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
        }
        
        .property-item {
            margin-bottom: 8px;
            font-size: 13px;
        }
        
        .property-key {
            font-weight: bold;
            color: #555;
        }
        
        .property-value {
            color: #777;
            margin-left: 10px;
        }
        
        .node {
            cursor: pointer;
        }
        
        .node:hover {
            stroke: #333 !important;
            stroke-width: 4px !important;
        }
        
        .link {
            /* strokeÈ¢úËâ≤Áî±JavaScriptÂä®ÊÄÅËÆæÁΩÆÔºå‰∏çÂú®CSS‰∏≠Âõ∫ÂÆö */
            stroke-opacity: 0.5;
            stroke-width: 2px;
        }
        
        .link:hover {
            /* hoverÊó∂Âä†Á≤óÊòæÁ§∫Ôºå‰øùÊåÅÂéüÊúâÈ¢úËâ≤ */
            stroke-opacity: 0.8;
            stroke-width: 2px;
        }
        
        .node-label {
            font-size: 11px;
            text-anchor: middle;
            pointer-events: none;
            fill: #333;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(255,255,255,0.8);
        }
        
        .link-label {
            font-size: 10px;
            text-anchor: middle;
            pointer-events: none;
            fill: #666;
            font-style: italic;
            background: rgba(255,255,255,0.8);
        }
        
        .controls {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .control-button {
            margin: 2px;
            padding: 5px 10px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .zoom-controls {
            background: #667eea;
            color: white;
        }
        
        .filter-controls {
            background: #28a745;
            color: white;
        }
        
        .edit-controls {
            background: #6f42c1;
            color: white;
        }
        
        .refresh-controls {
            background: #fd7e14;
            color: white;
        }
        
        .refresh-controls:hover {
            background: #e8590c;
        }
        
        .edit-controls:disabled {
            background: #cccccc;
            color: #666666;
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        .legend {
            position: absolute;
            top: 60px;
            left: 10px;
            background: rgba(255, 255, 255, 0.9);
            padding: 8px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            font-size: 11px;
            max-width: 120px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 3px;
        }
        
        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        /* ËäÇÁÇπÁºñËæëÈù¢ÊùøÊ†∑Âºè */
        .edit-panel {
            position: fixed;
            top: 0;
            right: -400px;
            width: 380px;
            height: 100vh;
            background: white;
            box-shadow: -2px 0 10px rgba(0,0,0,0.3);
            z-index: 1000;
            transition: right 0.3s ease;
            overflow-y: auto;
        }
        
        .edit-panel.show {
            right: 0;
        }
        
        /* ËäÇÁÇπÂàõÂª∫Ê®°Âºè‰∏ãÁöÑÊ†∑Âºè */
        .creating-node {
            cursor: crosshair !important;
        }
        
        .creating-node .graph-container {
            cursor: crosshair !important;
        }
        
        .edit-panel-header {
            background: #6f42c1;
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #5a2d91;
        }
        
        .edit-panel-header h3 {
            margin: 0;
            font-size: 18px;
        }
        
        .close-button {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .close-button:hover {
            background: rgba(255,255,255,0.2);
        }
        
        .edit-panel-content {
            padding: 20px;
        }
        
        .edit-buttons-row {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
        }
        
        .edit-function-button {
            flex: 1;
            padding: 12px 8px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            transition: all 0.2s ease;
            font-size: 12px;
            min-width: 0;
        }
        
        .edit-function-button:hover {
            border-color: #6f42c1;
            background: #f8f6ff;
            transform: translateY(-1px);
        }
        
        .edit-function-button.active {
            border-color: #6f42c1;
            background: #6f42c1;
            color: white;
        }
        
        .edit-function-button:disabled {
            background: #f5f5f5;
            color: #cccccc;
            border-color: #e0e0e0;
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        .edit-function-button:disabled:hover {
            background: #f5f5f5;
            border-color: #e0e0e0;
            transform: none;
        }
        
        .button-icon {
            font-size: 16px;
        }
        
        .button-text {
            font-weight: 500;
            font-size: 11px;
            text-align: center;
            white-space: nowrap;
        }
        
        .edit-forms {
            border-top: 1px solid #e0e0e0;
            padding-top: 20px;
            margin-top: 20px;
        }
        
        .edit-form {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
        }
        
        .edit-form h4 {
            margin: 0 0 15px 0;
            color: #333;
            font-size: 16px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
            font-size: 13px;
        }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 60px;
        }
        
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #6f42c1;
            box-shadow: 0 0 0 2px rgba(111, 66, 193, 0.1);
        }
        
        .warning-text {
            color: #dc3545;
            font-size: 13px;
            margin: 0;
            padding: 10px;
            background: #fff5f5;
            border: 1px solid #fed7d7;
            border-radius: 4px;
        }
        
        .form-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .action-btn {
            flex: 1;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        
        .confirm-btn {
            background: #28a745;
            color: white;
        }
        
        .confirm-btn:hover {
            background: #218838;
        }
        
        .danger-btn {
            background: #dc3545;
            color: white;
        }
        
        .danger-btn:hover {
            background: #c82333;
        }
        
        .cancel-btn {
            background: #6c757d;
            color: white;
        }
        
        .cancel-btn:hover {
            background: #5a6268;
        }
        
        /* ËäÇÁÇπÁ±ªÂûãÈÄâÊã©ÊåâÈíÆÊ†∑Âºè */
        .node-type-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }
        
        .node-type-button {
            flex: 1;
            padding: 15px 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            transition: all 0.2s ease;
            min-width: 0;
        }
        
        .node-type-button:hover {
            border-color: #4CAF50;
            background: #f8fff8;
            transform: translateY(-1px);
        }
        
        .node-type-button.selected {
            border-color: #4CAF50;
            background: #4CAF50;
            color: white;
        }
        
        .node-type-icon {
            font-size: 20px;
        }
        
        .node-type-text {
            font-weight: 500;
            font-size: 12px;
            text-align: center;
            white-space: nowrap;
        }
        
        /* Êó∂Èó¥ËäÇÁÇπË°®ÂçïÊ†∑Âºè */
        .time-node-form {
            padding: 20px;
            background: #f9f9f9;
            border-radius: 8px;
            margin-top: 15px;
        }
        
        .time-node-form h4 {
            margin: 0 0 15px 0;
            color: #333;
            font-size: 16px;
        }
        
        /* ÂÆû‰ΩìËäÇÁÇπË°®ÂçïÊ†∑Âºè */
        .entity-node-form {
            padding: 20px;
            background: #f9f9f9;
            border-radius: 8px;
            margin-top: 15px;
        }
        
        .entity-node-form h4 {
            margin: 0 0 15px 0;
            color: #333;
            font-size: 16px;
        }
        
        /* ËßíËâ≤ËäÇÁÇπË°®ÂçïÊ†∑Âºè */
        .character-node-form {
            padding: 20px;
            background: #f9f9f9;
            border-radius: 8px;
            margin-top: 15px;
        }
        
        .character-node-form h4 {
            margin: 0 0 15px 0;
            color: #333;
            font-size: 16px;
        }
        
        /* Âú∞ÁÇπËäÇÁÇπË°®ÂçïÊ†∑Âºè */
        .location-node-form {
            padding: 20px;
            background: #f9f9f9;
            border-radius: 8px;
            margin-top: 15px;
        }
        
        .location-node-form h4 {
            margin: 0 0 15px 0;
            color: #333;
            font-size: 16px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
        }
        
        .time-input {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }
        
        .time-input:focus {
            border-color: #4CAF50;
            outline: none;
        }
        
        .time-format-help {
            margin-top: 10px;
            padding: 10px;
            background: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            font-size: 12px;
            color: #666;
        }
        
        .time-format-help ul {
            margin: 5px 0 0 0;
            padding-left: 20px;
        }
        
        .time-format-help li {
            margin: 2px 0;
        }
        
        .form-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 15px;
        }
        
        .create-btn, .cancel-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        
        .create-btn {
            background: #4CAF50;
            color: white;
        }
        
        .create-btn:hover {
            background: #45a049;
        }
        
        .create-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .cancel-btn {
            background: #f44336;
            color: white;
        }
        
        .cancel-btn:hover {
            background: #da190b;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üß† ÂøÉÊô∫‰∫ëÂõæ</h1>
    </div>
    
    <div class="container">
        <div class="sidebar">
            <div class="stat-card">
                <div class="stat-title">üìä ÂõæË∞±ÁªüËÆ°</div>
                <div class="stat-item">
                    <span>ËäÇÁÇπÊÄªÊï∞:</span>
                    <span id="total-nodes">-</span>
                </div>
                <div class="stat-item">
                    <span>ÂÖ≥Á≥ªÊÄªÊï∞:</span>
                    <span id="total-links">-</span>
                </div>
                <div class="stat-item">
                    <span>Êõ¥Êñ∞Êó∂Èó¥:</span>
                    <span id="updated-time">-</span>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-title">üè∑Ô∏è ËäÇÁÇπÁ±ªÂûã</div>
                <div id="node-types"></div>
            </div>
            
            <div class="stat-card">
                <div class="stat-title">üîó ÂÖ≥Á≥ªÁ±ªÂûã</div>
                <div id="relation-types"></div>
            </div>
            
            <div class="node-details" id="node-details">
                <div class="detail-title" id="detail-title">
                    <span>ËäÇÁÇπËØ¶ÊÉÖ</span>
                    <button class="close-detail-btn" onclick="closeNodeDetails()">√ó</button>
                </div>
                <div id="node-properties"></div>
            </div>
        </div>
        
        <div class="menu-bar">
            <svg id="graph-container"></svg>
            
            <div class="controls">
                <button class="control-button refresh-controls" onclick="smartRefresh()">üîÑ Âà∑Êñ∞</button>
                <button class="control-button zoom-controls" onclick="resetZoom()">ÈáçÁΩÆ</button>
                <button class="control-button filter-controls" onclick="toggleNodeLabels()">ËäÇÁÇπÊ†áÁ≠æ</button>
                <button class="control-button filter-controls" onclick="toggleLinkLabels()">ÂÖ≥Á≥ªÊ†áÁ≠æ</button>
                <button class="control-button edit-controls" id="edit-button">ËäÇÁÇπÁºñËæë</button>
            </div>
            
            <div class="legend">
                <div style="font-weight: bold; margin-bottom: 6px; border-bottom: 1px solid #ccc; padding-bottom: 2px; font-size: 10px;">ËäÇÁÇπÁ±ªÂûã</div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #FF9800; width: 10px; height: 10px; margin-right: 6px;"></div>
                    <span style="font-size: 10px;">Âú∞ÁÇπ</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #2196F3; width: 10px; height: 10px; margin-right: 6px;"></div>
                    <span style="font-size: 10px;">ËßíËâ≤</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #FFD700; width: 10px; height: 10px; margin-right: 6px;"></div>
                    <span style="font-size: 10px;">ÂÆû‰Ωì</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #4CAF50; width: 10px; height: 10px; margin-right: 6px;"></div>
                    <span style="font-size: 10px;">Êó∂Èó¥</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #9E9E9E; width: 10px; height: 10px; margin-right: 6px;"></div>
                    <span style="font-size: 10px;">ÂÖ∂‰ªñ</span>
                </div>
                
                <div style="font-weight: bold; margin: 8px 0 6px 0; border-bottom: 1px solid #ccc; padding-bottom: 2px; font-size: 10px;">Êï∞ÊçÆ‰ΩçÁΩÆ</div>
                <div class="legend-item">
                    <div style="width: 8px; height: 8px; border: 2px solid #808080; border-radius: 50%; margin-right: 6px; background-color: #f0f0f0;"></div>
                    <span style="font-size: 10px;">Êú¨Âú∞</span>
                </div>
                <div class="legend-item">
                    <div style="width: 8px; height: 8px; border: 2px solid #00FF00; border-radius: 50%; margin-right: 6px; background-color: #f0f0f0;"></div>
                    <span style="font-size: 10px;">Neo4j</span>
                </div>
                <div class="legend-item">
                    <div style="width: 8px; height: 8px; border: 2px solid #0066FF; border-radius: 50%; margin-right: 6px; background-color: #f0f0f0;"></div>
                    <span style="font-size: 10px;">ÂèåÊ∫ê</span>
                </div>
            </div>
        </div>
        
        <!-- ËäÇÁÇπÁºñËæëÈù¢Êùø -->
        <div class="edit-panel" id="edit-panel">
            <div class="edit-panel-header">
                <h3>ËäÇÁÇπÁºñËæë</h3>
                <button class="close-button" onclick="toggleEditPanel()">√ó</button>
            </div>
            <div class="edit-panel-content">
                <div class="edit-buttons-row">
                    <button class="edit-function-button add-node-btn" onclick="showAddNodeForm()">
                        <span class="button-icon">‚ûï</span>
                        <span class="button-text">Ê∑ªÂä†</span>
                    </button>
                    <button class="edit-function-button modify-node-btn" onclick="showModifyNodeForm()">
                        <span class="button-icon">‚úèÔ∏è</span>
                        <span class="button-text">ÁºñËæë</span>
                    </button>
                    <button class="edit-function-button link-node-btn" onclick="showLinkNodeForm()">
                        <span class="button-icon">üîó</span>
                        <span class="button-text">ÈìæÊé•</span>
                    </button>
                    <button class="edit-function-button delete-node-btn" onclick="showDeleteNodeForm()">
                        <span class="button-icon">üóëÔ∏è</span>
                        <span class="button-text">Âà†Èô§</span>
                    </button>
                    <button class="edit-function-button quintuple-btn" onclick="showQuintupleForm()">
                        <span class="button-icon">üåê</span>
                        <span class="button-text">‰∫îÂÖÉÁªÑ</span>
                    </button>
                </div>
            </div>
            
            <!-- ÂäüËÉΩË°®ÂçïÂå∫Âüü -->
            <div class="edit-forms">
            </div>
        </div>
    </div>

    <script>
        // Â≠òÂÇ®Á±ªÂûãÈ¢úËâ≤ÈÖçÁΩÆÂ∏∏Èáè
        const STORAGE_TYPE_COLORS = {
            local: '#856404',    // ÈªÑËâ≤Ôºà‰ªÖÊú¨Âú∞Ôºâ
            neo4j: '#155724',    // ÁªøËâ≤Ôºà‰ªÖNeo4jÔºâ
            both: '#0c5460'      // ËìùËâ≤ÔºàÊú¨Âú∞+Neo4jÔºâ
        };
        
        // Ëé∑ÂèñÂ≠òÂÇ®Á±ªÂûãÂØπÂ∫îÁöÑÈ¢úËâ≤
        function getStorageTypeColor(sourceType) {
            return STORAGE_TYPE_COLORS[sourceType] || STORAGE_TYPE_COLORS.neo4j;
        }
        
        // Ëé∑ÂèñÂ≠òÂÇ®Á±ªÂûãÂØπÂ∫îÁöÑÁÆ≠Â§¥Ê†áËÆ∞ID
        function getStorageTypeArrow(sourceType) {
            return `url(#arrow-${sourceType || 'neo4j'})`;
        }
        
        // Ëé∑ÂèñUI‰∏≠Êï∞ÊçÆ‰ΩçÁΩÆÊåáÁ§∫Âô®ÁöÑËÉåÊôØËâ≤
        function getStorageUIBackground(sourceText) {
            if (sourceText === '‰ªÖNeo4j' || sourceText === 'Neo4j') {
                return '#d4edda';
            } else if (sourceText === '‰ªÖÊú¨Âú∞') {
                return '#fff3cd';
            } else {
                return '#d1ecf1';
            }
        }
        
        // Ëé∑ÂèñUI‰∏≠Êï∞ÊçÆ‰ΩçÁΩÆÊåáÁ§∫Âô®ÁöÑÊñáÂ≠óÈ¢úËâ≤
        function getStorageUIColor(sourceText) {
            if (sourceText === '‰ªÖNeo4j' || sourceText === 'Neo4j') {
                return STORAGE_TYPE_COLORS.neo4j;
            } else if (sourceText === '‰ªÖÊú¨Âú∞') {
                return STORAGE_TYPE_COLORS.local;
            } else {
                return STORAGE_TYPE_COLORS.both;
            }
        }
        
        // ÊéíÈô§Âú®ÁºñËæëË°®Âçï‰∏≠ÊòæÁ§∫ÂíåÊî∂ÈõÜÁöÑÁ≥ªÁªüÂ±ûÊÄß
        const EXCLUDED_PROPERTIES = ['significance', 'name', 'created_at', 'last_updated', 'node_type'];
        
        // ÂõæË∞±Êï∞ÊçÆÂç†‰ΩçÁ¨¶
        const graphData = {"nodes": [{"id": 0, "neo4j_id": "4:6ea3cedf-e5d0-43f4-b62f-4e98c69936e3:0", "label": "ÁîüÊó•", "group": "Entity", "labels": ["Entity"], "properties": {"significance": 1, "importance": 1, "name": "ÁîüÊó•", "context": "realityÁé∞ÂÆû", "created_at": "2026-01-15T14:36:11.551180", "last_updated": "2026-01-15T14:36:11.551180", "node_type": "Entity", "note": "Êó†"}, "size": 15, "color": "#FFD700", "strokeColor": "#00FF00", "strokeWidth": 3, "source": "neo4j"}, {"id": 1, "neo4j_id": "4:6ea3cedf-e5d0-43f4-b62f-4e98c69936e3:1", "label": "ÊòüÁ©∫", "group": "Entity", "labels": ["Entity"], "properties": {"significance": 0.99, "importance": 1.0, "name": "ÊòüÁ©∫", "context": "realityÁé∞ÂÆû", "created_at": "2026-01-15T14:38:52.253637", "last_updated": "2026-01-15T14:40:33.361509", "node_type": "Entity", "note": "ÂêçÁß∞ÔºåÁß∞Ë∞ì"}, "size": 15, "color": "#FFD700", "strokeColor": "#00FF00", "strokeWidth": 3, "source": "neo4j"}, {"id": 2, "neo4j_id": "4:6ea3cedf-e5d0-43f4-b62f-4e98c69936e3:2", "label": "ËçíÊòüÊÆñÊ∞ë", "group": "Entity", "labels": ["Entity"], "properties": {"significance": 0.99, "importance": 0.8, "name": "ËçíÊòüÊÆñÊ∞ë", "context": "realityÁé∞ÂÆû", "created_at": "2026-01-15T15:20:55.195990", "last_updated": "2026-01-15T15:22:07.572199", "node_type": "Entity", "note": "Á∫ø‰∏äË∑ëÂõ¢ÔºåÂâßÊú¨ÂêçÁß∞"}, "size": 15, "color": "#FFD700", "strokeColor": "#00FF00", "strokeWidth": 3, "source": "neo4j"}, {"id": 3, "neo4j_id": "4:6ea3cedf-e5d0-43f4-b62f-4e98c69936e3:3", "label": "ÁßçÊóè", "group": "Entity", "labels": ["Entity"], "properties": {"significance": 1, "importance": 0.5, "name": "ÁßçÊóè", "context": "ËçíÊòüÊÆñÊ∞ë", "created_at": "2026-01-15T15:24:02.129771", "last_updated": "2026-01-15T15:24:02.129771", "node_type": "Entity", "note": "ÁßçÊóè"}, "size": 15, "color": "#FFD700", "strokeColor": "#00FF00", "strokeWidth": 3, "source": "neo4j"}, {"id": 4, "neo4j_id": "4:6ea3cedf-e5d0-43f4-b62f-4e98c69936e3:4", "label": "Âåó‰∫¨", "group": "Location", "labels": ["Location"], "properties": {"name": "Âåó‰∫¨", "context": "reality", "created_at": "2026-01-04T14:47:58.570605", "last_updated": "2026-01-04T14:47:58.570605", "node_type": "Location"}, "size": 12, "color": "#FF9800", "strokeColor": "#00FF00", "strokeWidth": 3, "source": "neo4j"}, {"id": 5, "neo4j_id": "4:6ea3cedf-e5d0-43f4-b62f-4e98c69936e3:5", "label": "ÂàõÈÄ†ËÄÖ", "group": "Character", "labels": ["Character"], "properties": {"significance": 0.99, "importance": 1.0, "trust": 1, "name": "ÂàõÈÄ†ËÄÖ", "context": "reality", "created_at": "2026-01-04T14:53:33.225798", "last_updated": "2026-01-15T14:40:33.349635", "node_type": "Character"}, "size": 12, "color": "#2196F3", "strokeColor": "#00FF00", "strokeWidth": 3, "source": "neo4j"}, {"id": 6, "neo4j_id": "4:6ea3cedf-e5d0-43f4-b62f-4e98c69936e3:6", "label": "ÊòüÁ©∫ÈÄêÂ§ú", "group": "Entity", "labels": ["Entity"], "properties": {"significance": 0.99, "importance": 1, "name": "ÊòüÁ©∫ÈÄêÂ§ú", "context": "ÂêçÂ≠ó", "created_at": "2026-01-04T14:54:59.425698", "last_updated": "2026-01-15T15:23:02.948240", "node_type": "Entity", "note": "ÁΩëÂêçÔºåÁΩëÁªúË∫´‰ªΩ"}, "size": 15, "color": "#FFD700", "strokeColor": "#00FF00", "strokeWidth": 3, "source": "neo4j"}, {"id": 7, "neo4j_id": "4:6ea3cedf-e5d0-43f4-b62f-4e98c69936e3:7", "label": "‰∫∫Êóè", "group": "Entity", "labels": ["Entity"], "properties": {"significance": 0.99, "importance": 0.5, "name": "‰∫∫Êóè", "context": "ËçíÊòüÊÆñÊ∞ë", "created_at": "2026-01-15T15:25:18.274865", "last_updated": "2026-01-15T15:31:39.666255", "node_type": "Entity", "note": "Ê∏©Â∫¶Ôºö6Ôºå16Ôºå26Ôºå36\nÊäóÊÄßÔºöÊ≤°ÊúâÊäóÊÄß„ÄÇ\nÊàòÊñóÔºöÊ≤°ÊúâÂ§©ÁîüÊ≠¶Âô®Ôºå‰ΩÜÂèØ‰ª•‰ΩøÁî®Â§ßÂ§öÊï∞Ë£ÖÂ§á„ÄÇ\nÁâπÊÄßÔºöÊ≤°Êúâ‰ªÄ‰πàÁâπÂà´ÁöÑÂº∫È°πÊàñÂº±ÁÇπ„ÄÇ"}, "size": 15, "color": "#FFD700", "strokeColor": "#00FF00", "strokeWidth": 3, "source": "neo4j"}, {"id": 8, "neo4j_id": "4:6ea3cedf-e5d0-43f4-b62f-4e98c69936e3:8", "label": "ÊµãËØï", "group": "Entity", "labels": ["Entity"], "properties": {"significance": 0.99, "importance": 0.55, "name": "ÊµãËØï", "context": "realityÁé∞ÂÆû", "created_at": "2026-01-04T15:31:28.860958", "last_updated": "2026-01-15T15:12:58.698270", "node_type": "Entity", "note": "Êó†"}, "size": 15, "color": "#FFD700", "strokeColor": "#00FF00", "strokeWidth": 3, "source": "neo4j"}, {"id": 9, "neo4j_id": "4:6ea3cedf-e5d0-43f4-b62f-4e98c69936e3:9", "label": "Â§±Ê∏©Áóá", "group": "Entity", "labels": ["Entity"], "properties": {"significance": 0.99, "importance": 0.5, "name": "Â§±Ê∏©Áóá", "context": "ËçíÊòüÊÆñÊ∞ë", "created_at": "2026-01-15T15:32:38.633218", "last_updated": "2026-01-15T15:50:20.984391", "node_type": "Entity", "note": "‰∏ÄÁßçÁóÖÁóá„ÄÇ\nÂú®‰Ωé‰∫éÁâ©ÁßçÊúÄ‰ΩéÈÄÇÂ∫îÊ∏©Â∫¶Âêé‰ºöÈÄêÊ∏êÁ¥ØËÆ°Ôºå‰∏•ÈáçÊó∂ÂØºËá¥ÂÜª‰º§ÔºåÂπ∂ÊúÄÁªàÂØºËá¥Ê≠ª‰∫°„ÄÇ\nÂõûÂà∞Ê∏©ÊöñÁ©∫Èó¥Âç≥ÂàªÁºìÊÖ¢Ê∂àÈÄÄ„ÄÇ"}, "size": 15, "color": "#FFD700", "strokeColor": "#00FF00", "strokeWidth": 3, "source": "neo4j"}, {"id": 10, "neo4j_id": "4:6ea3cedf-e5d0-43f4-b62f-4e98c69936e3:10", "label": "Ëá™Êàë", "group": "Character", "labels": ["Character"], "properties": {"significance": 0.99, "importance": 1.0, "trust": 1, "name": "Ëá™Êàë", "context": "reality", "created_at": "2026-01-01T15:39:15.215369", "last_updated": "2026-01-15T15:12:58.708342", "node_type": "Character"}, "size": 12, "color": "#2196F3", "strokeColor": "#00FF00", "strokeWidth": 3, "source": "neo4j"}, {"id": 11, "neo4j_id": "4:6ea3cedf-e5d0-43f4-b62f-4e98c69936e3:11", "label": "Áé≤‰æù", "group": "Entity", "labels": ["Entity"], "properties": {"significance": 0.99, "importance": 1.0, "name": "Áé≤‰æù", "context": "Áß∞Ë∞ì", "created_at": "2026-01-01T15:40:03.551561", "last_updated": "2026-01-04T13:23:34.685583", "node_type": "Entity", "note": "Êó†"}, "size": 15, "color": "#FFD700", "strokeColor": "#00FF00", "strokeWidth": 3, "source": "neo4j"}, {"id": 12, "neo4j_id": "4:6ea3cedf-e5d0-43f4-b62f-4e98c69936e3:12", "label": "ÁîüÊó•", "group": "Entity", "labels": ["Entity"], "properties": {"significance": 0.99, "importance": 1, "name": "ÁîüÊó•", "context": "realityÁé∞ÂÆû", "created_at": "2026-01-01T19:13:56.344158", "last_updated": "2026-01-15T14:37:15.615402", "node_type": "Entity", "note": "Êó†"}, "size": 15, "color": "#FFD700", "strokeColor": "#00FF00", "strokeWidth": 3, "source": "neo4j"}, {"id": 13, "neo4j_id": "4:6ea3cedf-e5d0-43f4-b62f-4e98c69936e3:13", "label": "Êú∫Ê¢∞Êóè", "group": "Entity", "labels": ["Entity"], "properties": {"significance": 1, "importance": 0.5, "name": "Êú∫Ê¢∞Êóè", "context": "ËçíÊòüÊÆñÊ∞ë", "created_at": "2026-01-15T15:37:02.289013", "last_updated": "2026-01-15T15:37:02.289013", "node_type": "Entity", "note": "ÈÄöÂ∏∏Ë¢´Áß∞‰∏∫Â§±ÊéßÊú∫Ê¢∞ÔºåÂØπÊâÄÊúâÂºÇÊóèÊúâÊïåÊÑè„ÄÇ\nÊ∏©Â∫¶Ôºö-150Ôºå0Ôºå150Ôºå300„ÄÇ\nÊäóÊÄßÔºöÈí¢ÈìÅÊµáÁ≠ëÁöÑË∫Ø‰ΩìÂ∏¶Êù•‰∫ÜËæÉÂº∫ÁöÑÈîêÂô®/ÈíùÂô®ÊäóÊÄß„ÄÇ\nÊàòÊñóÔºöÈÄöÂ∏∏ÂÖ∑Â§áÊàòÂàÄ/ÂÖÖËÉΩÊ≠•Êû™/Êõ¥Âº∫ÂäõÁöÑÁßëÊäÄÊ≠¶Âô®„ÄÇ\nÁâπÊÄßÔºö‰ºöÂèóÂà∞empÁ±ªÁîµÁ£ÅËÑâÂÜ≤ÁöÑ‰∏•ÈáçÂΩ±ÂìçÔºå‰ΩÜÊ≥®ÊÑèÔºÅÁªèÂéÜËøûÁª≠ÁöÑËÑâÂÜ≤Â§±ËÉΩÊ¨ßÂèØËÉΩ‰ºöÁü≠ÊöÇÊÅ¢Â§çÊàòÊñóÂäõ„ÄÇ"}, "size": 15, "color": "#FFD700", "strokeColor": "#00FF00", "strokeWidth": 3, "source": "neo4j"}, {"id": 14, "neo4j_id": "4:6ea3cedf-e5d0-43f4-b62f-4e98c69936e3:14", "label": "Ëô´Êóè", "group": "Entity", "labels": ["Entity"], "properties": {"significance": 1, "importance": 0.5, "name": "Ëô´Êóè", "context": "ËçíÊòüÊÆñÊ∞ë", "created_at": "2026-01-15T15:42:52.887778", "last_updated": "2026-01-15T15:42:52.887778", "node_type": "Entity", "note": "Áæ§Â±ÖÂú®Âú∞Â∫ïÁöÑÁîüÁâ©ÔºåÂØπÊâÄÊúâÂú∞Ë°®ÁîüÁâ©ÊúâÊïåÊÑè„ÄÇ\nÊ∏©Â∫¶Ôºö-10Ôºå10Ôºå30Ôºå50Ôºå‰Ωé‰∫éÊúÄ‰ΩéÊ∏©Â∫¶Âè™‰ºöÂÜªÂÉµÔºå‰∏ç‰ºöËá¥Ê≠ª„ÄÇ\nÊäóÊÄßÔºöÂùöÁ°¨ÁöÑÁî≤Â£≥Êúâ‰∏çÈîôÁöÑÈîêÂô®ÊäóÊÄß/‰∏ÄÂÆöÁöÑÈíùÂô®ÊäóÊÄß„ÄÇ\nÊàòÊñóÔºöÈÄöÂ∏∏Áî®Âè£Âô®ÊàñÂà©Áà™ÊîªÂáªÔºåÂÅ∂Â∞îÊúâÂèòÂºÇËô´ÊóèÂÖ∑Â§áÂÖ∂‰ªñÊîªÂáªÊñπÂºè„ÄÇ\nÁâπÊÄßÔºöÂñúÊ¨¢ÁîüÊ¥ªÂú®Âú∞‰∏ãÔºåÊåñÊéòËÉΩÂäõÂæàÂº∫„ÄÇÊóèÁæ§Êã•ÊúâÁéãËô´È¢ÜË¢ñÔºåÁéãËô´Ê≠ª‰∫°ÂàôÊóèÁæ§Ê≠ª‰∫°„ÄÇ"}, "size": 15, "color": "#FFD700", "strokeColor": "#00FF00", "strokeWidth": 3, "source": "neo4j"}, {"id": 15, "neo4j_id": "4:6ea3cedf-e5d0-43f4-b62f-4e98c69936e3:15", "label": "ÁñæÁóÖ", "group": "Entity", "labels": ["Entity"], "properties": {"significance": 1, "importance": 0.5, "name": "ÁñæÁóÖ", "context": "ËçíÊòüÊÆñÊ∞ë", "created_at": "2026-01-15T15:47:03.326601", "last_updated": "2026-01-15T15:47:03.326601", "node_type": "Entity", "note": "‰ºö‰∫ßÁîüÂêÑËá™Ë¥üÈù¢ÊïàÊûúÔºåÈÄöÂ∏∏ÂΩìËøõÂ∫¶ÊäµËææ100%Êó∂‰ºöÂØºËá¥ÁîüÁâ©Ê≠ª‰∫°„ÄÇÈúÄË¶ÅË¢´Â∞ΩÂø´Â§ÑÁêÜ„ÄÇ"}, "size": 15, "color": "#FFD700", "strokeColor": "#00FF00", "strokeWidth": 3, "source": "neo4j"}, {"id": 16, "neo4j_id": "4:6ea3cedf-e5d0-43f4-b62f-4e98c69936e3:24", "label": "2024Âπ¥", "group": "Time", "labels": ["Time", "Year"], "properties": {"time": "2024Âπ¥", "name": "2024Âπ¥", "node_type": "Time", "type": "static"}, "size": 12, "color": "#4CAF50", "strokeColor": "#00FF00", "strokeWidth": 3, "source": "neo4j"}, {"id": 17, "neo4j_id": "4:6ea3cedf-e5d0-43f4-b62f-4e98c69936e3:25", "label": "3Êúà", "group": "Time", "labels": ["Time", "Month"], "properties": {"time": "2024Âπ¥3Êúà", "name": "3Êúà", "node_type": "Time", "type": "static"}, "size": 12, "color": "#4CAF50", "strokeColor": "#00FF00", "strokeWidth": 3, "source": "neo4j"}, {"id": 18, "neo4j_id": "4:6ea3cedf-e5d0-43f4-b62f-4e98c69936e3:26", "label": "28Êó•", "group": "Time", "labels": ["Time", "Day"], "properties": {"significance": 0.99, "time": "2024Âπ¥3Êúà28Êó•", "importance": 0.55, "name": "28Êó•", "last_updated": "2026-01-04T13:23:03.373774", "node_type": "Time", "type": "static"}, "size": 12, "color": "#4CAF50", "strokeColor": "#00FF00", "strokeWidth": 3, "source": "neo4j"}], "links": [{"source": 0, "target": 5, "type": "HAS_PROPERTY", "properties": {"source": ["manual_input"], "predicate": "HAS_PROPERTY", "evidence": "user manual input", "created_at": "2026-01-15T14:41:14.425255", "last_updated": "2026-01-15T14:41:14.425255", "confidence": 1}, "neo4j_id": "5:6ea3cedf-e5d0-43f4-b62f-4e98c69936e3:1155263464374009856", "source_type": "neo4j"}, {"source": 2, "target": 6, "type": "‰∏ªÊåÅ‰∫∫ÊòØ", "properties": {"source": ["manual_input"], "predicate": "‰∏ªÊåÅ‰∫∫ÊòØ", "evidence": "user manual input", "created_at": "2026-01-15T15:21:41.310416", "last_updated": "2026-01-15T15:21:41.310416", "confidence": 0.75}, "neo4j_id": "5:6ea3cedf-e5d0-43f4-b62f-4e98c69936e3:1153016062606835714", "source_type": "neo4j"}, {"source": 3, "target": 2, "type": "BELONGS_TO", "properties": {"source": ["manual_input"], "predicate": "BELONGS_TO", "evidence": "user manual input", "created_at": "2026-01-15T15:24:33.540616", "last_updated": "2026-01-15T15:24:33.540616", "confidence": 0.75}, "neo4j_id": "5:6ea3cedf-e5d0-43f4-b62f-4e98c69936e3:1152958888002191363", "source_type": "neo4j"}, {"source": 5, "target": 10, "type": "ÂàõÈÄ†‰∫Ü", "properties": {"source": ["manual_input"], "predicate": "ÂàõÈÄ†‰∫Ü", "evidence": "user manual input", "created_at": "2026-01-04T14:54:21.705497", "last_updated": "2026-01-04T14:54:21.705497", "confidence": 1}, "neo4j_id": "5:6ea3cedf-e5d0-43f4-b62f-4e98c69936e3:1153012764071952389", "source_type": "neo4j"}, {"source": 5, "target": 6, "type": "HAS_NAME", "properties": {"source": ["manual_input"], "predicate": "HAS_IDENTITY", "evidence": "user manual input", "created_at": "2026-01-04T14:55:21.424978", "last_updated": "2026-01-04T14:57:53.776205", "confidence": 1}, "neo4j_id": "5:6ea3cedf-e5d0-43f4-b62f-4e98c69936e3:6917621386617815046", "source_type": "neo4j"}, {"source": 5, "target": 1, "type": "Â∏åÊúõË¢´Áß∞‰Ωú", "properties": {"source": ["manual_input"], "predicate": "Â∏åÊúõË¢´Áß∞‰Ωú", "evidence": "user manual input", "created_at": "2026-01-15T14:40:24.115163", "last_updated": "2026-01-15T14:40:33.307150", "confidence": 0.75}, "neo4j_id": "5:6ea3cedf-e5d0-43f4-b62f-4e98c69936e3:6919874285943128065", "source_type": "neo4j"}, {"source": 7, "target": 3, "type": "BELONGS_TO", "properties": {"source": ["manual_input"], "predicate": "BELONGS_TO", "evidence": "user manual input", "created_at": "2026-01-15T15:25:40.108073", "last_updated": "2026-01-15T15:25:40.108073", "confidence": 0.75}, "neo4j_id": "5:6ea3cedf-e5d0-43f4-b62f-4e98c69936e3:1152958888002191367", "source_type": "neo4j"}, {"source": 9, "target": 15, "type": "BELONGS_TO", "properties": {"source": ["manual_input"], "predicate": "BELONGS_TO", "evidence": "user manual input", "created_at": "2026-01-15T15:47:40.606497", "last_updated": "2026-01-15T15:47:40.606497", "confidence": 0.75}, "neo4j_id": "5:6ea3cedf-e5d0-43f4-b62f-4e98c69936e3:1152958888002191369", "source_type": "neo4j"}, {"source": 10, "target": 8, "type": "ÊµãËØï2", "properties": {"source": ["manual_input"], "predicate": "ÊµãËØï2", "evidence": "user manual input", "created_at": "2026-01-15T15:10:54.953592", "last_updated": "2026-01-15T15:12:58.547609", "confidence": 0.75}, "neo4j_id": "5:6ea3cedf-e5d0-43f4-b62f-4e98c69936e3:1157502070048161802", "source_type": "neo4j"}, {"source": 10, "target": 11, "type": "ÂêçÂ≠óÊòØ", "properties": {"source": "manual_input", "predicate": "HAS_NAME", "evidence": "", "created_at": "2026-01-01T19:11:42.935970", "last_updated": "2026-01-04T13:23:34.618450", "confidence": 1.0}, "neo4j_id": "5:6ea3cedf-e5d0-43f4-b62f-4e98c69936e3:1155261265350754314", "source_type": "neo4j"}, {"source": 10, "target": 12, "type": "HAS_PROPERTY", "properties": {"source": "manual_input", "predicate": "HAS_PROPERTY", "evidence": "", "created_at": "2026-01-01T19:14:57.769047", "last_updated": "2026-01-04T13:23:17.921610", "confidence": 1.0}, "neo4j_id": "5:6ea3cedf-e5d0-43f4-b62f-4e98c69936e3:6917619187594559500", "source_type": "neo4j"}, {"source": 12, "target": 18, "type": "HAPPENED_AT", "properties": {"source": "manual_input", "predicate": "HAPPENED_AT", "evidence": "", "created_at": "2026-01-01T19:15:50.886438", "last_updated": "2026-01-04T13:23:03.009395", "confidence": 1.0}, "neo4j_id": "5:6ea3cedf-e5d0-43f4-b62f-4e98c69936e3:6917532326175965210", "source_type": "neo4j"}, {"source": 13, "target": 3, "type": "BELONGS_TO", "properties": {"source": ["manual_input"], "predicate": "BELONGS_TO", "evidence": "user manual input", "created_at": "2026-01-15T15:37:18.899041", "last_updated": "2026-01-15T15:37:18.899041", "confidence": 0.75}, "neo4j_id": "5:6ea3cedf-e5d0-43f4-b62f-4e98c69936e3:1152958888002191373", "source_type": "neo4j"}, {"source": 14, "target": 3, "type": "BELONGS_TO", "properties": {"source": ["manual_input"], "predicate": "BELONGS_TO", "evidence": "user manual input", "created_at": "2026-01-15T15:43:07.011087", "last_updated": "2026-01-15T15:43:07.011087", "confidence": 0.75}, "neo4j_id": "5:6ea3cedf-e5d0-43f4-b62f-4e98c69936e3:1152958888002191374", "source_type": "neo4j"}, {"source": 15, "target": 2, "type": "BELONGS_TO", "properties": {"source": ["manual_input"], "predicate": "BELONGS_TO", "evidence": "user manual input", "created_at": "2026-01-15T15:47:20.207632", "last_updated": "2026-01-15T15:47:20.207632", "confidence": 0.75}, "neo4j_id": "5:6ea3cedf-e5d0-43f4-b62f-4e98c69936e3:1152958888002191375", "source_type": "neo4j"}, {"source": 17, "target": 16, "type": "BELONGS_TO", "properties": {"hierarchy_type": "month_to_year"}, "neo4j_id": "5:6ea3cedf-e5d0-43f4-b62f-4e98c69936e3:1152958888002191385", "source_type": "neo4j"}, {"source": 18, "target": 17, "type": "BELONGS_TO", "properties": {"hierarchy_type": "day_to_month"}, "neo4j_id": "5:6ea3cedf-e5d0-43f4-b62f-4e98c69936e3:1152958888002191386", "source_type": "neo4j"}], "stats": {"total_nodes": 19, "total_links": 17, "node_types": {"Entity": 13, "Location": 1, "Character": 2, "Time": 3}, "relation_types": {"HAS_PROPERTY": 2, "‰∏ªÊåÅ‰∫∫ÊòØ": 1, "BELONGS_TO": 8, "ÂàõÈÄ†‰∫Ü": 1, "HAS_NAME": 1, "Â∏åÊúõË¢´Áß∞‰Ωú": 1, "ÊµãËØï2": 1, "ÂêçÂ≠óÊòØ": 1, "HAPPENED_AT": 1}, "updated_at": "2026-01-16T00:28:51.595879"}, "metadata": {}, "neo4j_connected": true};
        
        // ÂÖ®Â±ÄÂèòÈáèË∑üË∏™ÊúÄËøëÈÄâ‰∏≠ÁöÑÈ°πÁõÆÂàóË°®ÔºàËäÇÁÇπÂíåÂÖ≥Á≥ªÔºâÔºåÊúÄÂ§ö‰øùÁïô10‰∏™
        let recentSelectedNodes = [];
        
        // Âà†Èô§Ê®°ÂºèÁä∂ÊÄÅÂèòÈáè
        let deleteMode = false;
        
        // ËÆæÁΩÆÁîªÂ∏É
        const svg = d3.select("#graph-container");
        const width = svg.node().getBoundingClientRect().width;
        const height = svg.node().getBoundingClientRect().height;
        
        svg.attr("width", width).attr("height", height);
        
        // ÂàõÂª∫Áº©ÊîæË°å‰∏∫
        const zoom = d3.zoom()
            .scaleExtent([0.1, 3])
            .on("zoom", function(event) {
                container.attr("transform", event.transform);
            });
        
        svg.call(zoom);
        
        // ÂàõÂª∫ÂÆπÂô®ÁªÑ
        const container = svg.append("g");
        
        // ÂàõÂª∫ÂäõÂØºÂêëÂõæ
        const simulation = d3.forceSimulation(graphData.nodes)
            .force("link", d3.forceLink(graphData.links).id(d => d.id).distance(100))
            .force("charge", d3.forceManyBody().strength(-300))
            .force("center", d3.forceCenter(width / 2, height / 2))
            .force("collision", d3.forceCollide().radius(d => d.size + 5));
        
        // ÂàõÂª∫ÁÆ≠Â§¥Ê†áËÆ∞Ôºà‰∏∫‰∏çÂêåÂ≠òÂÇ®‰ΩçÁΩÆÂàõÂª∫‰∏çÂêåÈ¢úËâ≤ÁöÑÁÆ≠Â§¥Ôºâ
        const defs = container.append("defs");
        
        // ÂàõÂª∫Â≠òÂÇ®Á±ªÂûãÁÆ≠Â§¥Ê†áËÆ∞Ôºà‰ΩøÁî®Â∏∏ÈáèÈ¢úËâ≤Ôºâ
        Object.keys(STORAGE_TYPE_COLORS).forEach(storageType => {
            defs.append("marker")
                .attr("id", `arrow-${storageType}`)
                .attr("viewBox", "0 -5 10 10")
                .attr("refX", 25)
                .attr("refY", 0)
                .attr("markerWidth", 4)
                .attr("markerHeight", 4)
                .attr("orient", "auto")
                .append("path")
                .attr("d", "M0,-5L10,0L0,5")
                .attr("fill", STORAGE_TYPE_COLORS[storageType]);
        });
        
        // Ê£ÄÊµãÂèåÂêëÂÖ≥Á≥ªÂπ∂ËÆæÁΩÆÂÅèÁßª
        function detectBidirectionalLinks(links) {
            const linkPairs = new Map();
            
            // ‰∏∫ÊØè‰∏™ËøûÊé•ÂàõÂª∫Ê†áËØÜÁ¨¶ÔºåÊ£ÄÊµãÂèåÂêëÂÖ≥Á≥ª
            links.forEach((link, index) => {
                const sourceId = link.source.id || link.source;
                const targetId = link.target.id || link.target;
                const pairKey1 = `${sourceId}-${targetId}`;
                const pairKey2 = `${targetId}-${sourceId}`;
                
                // Ê£ÄÊü•ÊòØÂê¶Â∑≤ÁªèÊúâÂèçÂêëËøûÊé•
                if (linkPairs.has(pairKey2)) {
                    // ÂèëÁé∞ÂèåÂêëÂÖ≥Á≥ª
                    const reverseLink = linkPairs.get(pairKey2);
                    
                    // ËÆæÁΩÆÂÅèÁßªÊ†áËØÜ
                    link.isBidirectional = true;
                    link.offsetDirection = 1; // Ê≠£ÂÅèÁßª
                    reverseLink.isBidirectional = true;
                    reverseLink.offsetDirection = 1; // Ë¥üÂÅèÁßª
                    
                    console.log('Ê£ÄÊµãÂà∞ÂèåÂêëÂÖ≥Á≥ª:', sourceId, '<->', targetId);
                } else {
                    linkPairs.set(pairKey1, link);
                    link.isBidirectional = false;
                    link.offsetDirection = 0; // Êó†ÂÅèÁßª
                }
            });
            
            return links;
        }
        
        // ËÆ°ÁÆóÂÅèÁßªÂêéÁöÑËøûÁ∫ø‰ΩçÁΩÆ
        function calculateOffsetPosition(source, target, offset = 10, direction = 0) {
            if (direction === 0) {
                // Êó†ÂÅèÁßªÔºåËøîÂõûÂéüÂßã‰ΩçÁΩÆ
                return { x1: source.x, y1: source.y, x2: target.x, y2: target.y };
            }
            
            // ËÆ°ÁÆóËøûÁ∫øÁöÑÂûÇÁõ¥ÂêëÈáèÁî®‰∫éÂÅèÁßª
            const dx = target.x - source.x;
            const dy = target.y - source.y;
            const length = Math.sqrt(dx * dx + dy * dy);
            
            if (length === 0) {
                return { x1: source.x, y1: source.y, x2: target.x, y2: target.y };
            }
            
            // ÂûÇÁõ¥ÂêëÈáèÔºàÈÄÜÊó∂ÈíàÊóãËΩ¨90Â∫¶Ôºâ
            const perpX = -dy / length * offset * direction;
            const perpY = dx / length * offset * direction;
            
            return {
                x1: source.x + perpX,
                y1: source.y + perpY,
                x2: target.x + perpX,
                y2: target.y + perpY
            };
        }
        
        // Â§ÑÁêÜÂèåÂêëÂÖ≥Á≥ª
        detectBidirectionalLinks(graphData.links);
        
        // ÂàõÂª∫ÈìæÊé•
        let link = container.append("g")
            .selectAll("line")
            .data(graphData.links)
            .enter().append("line")
            .attr("class", "link")
            .attr("marker-end", d => getStorageTypeArrow(d.source_type))
            .attr("stroke", d => {
                // Ë∞ÉËØïÔºöÊâìÂç∞ÂÖ≥Á≥ªÁöÑsource_type
                console.log('ÂÖ≥Á≥ªÈ¢úËâ≤ËÆæÁΩÆ - ID:', d.neo4j_id, 'Type:', d.type, 'Source_type:', d.source_type);
                
                // Ê†πÊçÆÂ≠òÂÇ®‰ΩçÁΩÆËÆæÁΩÆÈ¢úËâ≤Ôºà‰ΩøÁî®Áªü‰∏ÄÁöÑÈ¢úËâ≤ÂáΩÊï∞Ôºâ
                if (!d.source_type || !STORAGE_TYPE_COLORS[d.source_type]) {
                    console.warn('ÂÖ≥Á≥ªÊú™Áü•Â≠òÂÇ®‰ΩçÁΩÆ:', d.source_type, 'ÂÖ≥Á≥ª:', d);
                }
                return getStorageTypeColor(d.source_type);
            })
            .attr("stroke-width", "2")
            .on("click", showLinkDetails);
        
        // ÂàõÂª∫ËäÇÁÇπ
        let node = container.append("g")
            .selectAll("circle")
            .data(graphData.nodes)
            .enter().append("circle")
            .attr("class", "node")
            .attr("r", d => d.size)
            .attr("fill", d => d.color)
            .attr("stroke", d => d.strokeColor)
            .attr("stroke-width", d => d.strokeWidth)
            .on("click", showNodeDetails)
            .call(d3.drag()
                .on("start", dragstarted)
                .on("drag", dragged)
                .on("end", dragended));
        
        // ÂàõÂª∫ËäÇÁÇπÊ†áÁ≠æÔºàÊòæÁ§∫Âú®ËäÇÁÇπ‰∏äÔºâ
        let nodeLabels = container.append("g")
            .selectAll("text")
            .data(graphData.nodes)
            .enter().append("text")
            .attr("class", "node-label")
            .text(d => d.label.length > 8 ? d.label.substring(0, 8) + "..." : d.label)
            .style("display", "block");
        
        // ÂàõÂª∫ÂÖ≥Á≥ªÊ†áÁ≠æËÉåÊôØ
        let linkLabelBgs = container.append("g")
            .selectAll("rect")
            .data(graphData.links)
            .enter().append("rect")
            .attr("class", "link-label-bg")
            .attr("fill", "rgba(255,255,255,0.8)")
            .attr("stroke", "rgba(200,200,200,0.5)")
            .attr("stroke-width", 0.5)
            .attr("rx", 3)
            .attr("ry", 3);
        
        // ÂàõÂª∫ÂÖ≥Á≥ªÊ†áÁ≠æÔºàÊòæÁ§∫Âú®ËøûÊé•Á∫ø‰∏äÔºâ
        let linkLabels = container.append("g")
            .selectAll("text")
            .data(graphData.links)
            .enter().append("text")
            .attr("class", "link-label")
            .text(d => {
                // ÊòæÁ§∫ÂÖ≥Á≥ªÁ±ªÂûãÔºö‰ºòÂÖàÊòæÁ§∫predicate > action > type
                if (d.properties && d.properties.predicate) {
                    return d.properties.predicate;
                } else if (d.properties && d.properties.action) {
                    return d.properties.action;
                } else {
                    return d.type;
                }
            })
            .style("display", "block");
        
        // Êõ¥Êñ∞‰ΩçÁΩÆ
        simulation.on("tick", () => {
            // Êõ¥Êñ∞ËøûÁ∫ø‰ΩçÁΩÆÔºàÊîØÊåÅÂèåÂêëÂÖ≥Á≥ªÂÅèÁßªÔºâ
            link.each(function(d) {
                const offset = d.isBidirectional ? calculateOffsetPosition(d.source, d.target, 8, d.offsetDirection) : 
                              { x1: d.source.x, y1: d.source.y, x2: d.target.x, y2: d.target.y };
                
                d3.select(this)
                    .attr("x1", offset.x1)
                    .attr("y1", offset.y1)
                    .attr("x2", offset.x2)
                    .attr("y2", offset.y2);
            });
            
            node
                .attr("cx", d => d.x)
                .attr("cy", d => d.y);
            
            // ËäÇÁÇπÊ†áÁ≠æË∑üÈöèËäÇÁÇπ
            nodeLabels
                .attr("x", d => d.x)
                .attr("y", d => d.y + 4); // Á®çÂæÆÂêë‰∏ãÂÅèÁßªÔºåËÆ©ÊñáÂ≠óÂú®ËäÇÁÇπ‰∏≠ÂøÉÂÅè‰∏ã
            
            // ÂÖ≥Á≥ªÊ†áÁ≠æÊòæÁ§∫Âú®ËøûÊé•Á∫øÁöÑ‰∏≠ÁÇπÔºàÊîØÊåÅÂèåÂêëÂÖ≥Á≥ªÂÅèÁßªÔºâ
            linkLabels.each(function(d) {
                let labelX, labelY;
                
                if (d.isBidirectional) {
                    const offset = calculateOffsetPosition(d.source, d.target, 8, d.offsetDirection);
                    labelX = (offset.x1 + offset.x2) / 2;
                    labelY = (offset.y1 + offset.y2) / 2 - 5;
                } else {
                    labelX = (d.source.x + d.target.x) / 2;
                    labelY = (d.source.y + d.target.y) / 2 - 5;
                }
                
                d3.select(this)
                    .attr("x", labelX)
                    .attr("y", labelY);
            });
            
            // ÂÖ≥Á≥ªÊ†áÁ≠æËÉåÊôØË∑üÈöèÊ†áÁ≠æ‰ΩçÁΩÆ
            linkLabelBgs.each(function(d) {
                const text = linkLabels.filter(data => data === d).node();
                if (text) {
                    const bbox = text.getBBox();
                    d3.select(this)
                        .attr("x", bbox.x - 2)
                        .attr("y", bbox.y - 1)
                        .attr("width", bbox.width + 4)
                        .attr("height", bbox.height + 2);
                }
            });
        });
        
        // ÊãñÊãΩÂáΩÊï∞
        function dragstarted(event, d) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            d.fx = d.x;
            d.fy = d.y;
        }
        
        function dragged(event, d) {
            d.fx = event.x;
            d.fy = event.y;
        }
        
        function dragended(event, d) {
            if (!event.active) simulation.alphaTarget(0);
            d.fx = null;
            d.fy = null;
        }
        
        // ÊòæÁ§∫ËäÇÁÇπËØ¶ÊÉÖ
        function showNodeDetails(event, d) {
            const detailsDiv = document.getElementById("node-details");
            const propertiesDiv = document.getElementById("node-properties");
            const titleDiv = document.getElementById("detail-title");
            
            detailsDiv.style.display = "block";
            titleDiv.querySelector('span').textContent = "ËäÇÁÇπËØ¶ÊÉÖ";
            
            // Ë∑üË∏™ÈÄâ‰∏≠ÁöÑËäÇÁÇπ
            const selectedItemData = {
                type: 'node',
                data: d,
                elementId: d.neo4j_id
            };
            
            // Êõ¥Êñ∞ÊúÄËøëÈÄâ‰∏≠ÁöÑÈ°πÁõÆÂàóË°®
            updateRecentSelectedNodes(selectedItemData);
            
            // Â¶ÇÊûúÂà†Èô§ÁïåÈù¢Â∑≤ÊâìÂºÄÔºåÂÆûÊó∂Êõ¥Êñ∞Âà†Èô§ÂÜÖÂÆπ
            updateDeleteFormIfVisible();
            
            // Â¶ÇÊûú‰øÆÊîπÁïåÈù¢Â∑≤ÊâìÂºÄÔºåÂÆûÊó∂Êõ¥Êñ∞‰øÆÊîπÂÜÖÂÆπ
            updateModifyFormIfVisible();
            
            // Â¶ÇÊûúÈìæÊé•ÁïåÈù¢Â∑≤ÊâìÂºÄÔºåÂÆûÊó∂Êõ¥Êñ∞ÈìæÊé•ÂÜÖÂÆπ
            updateLinkFormIfVisible();
            
            let sourceText = '';
            if (d.source === 'local') {
                sourceText = '‰ªÖÊú¨Âú∞';
            } else if (d.source === 'neo4j') {
                sourceText = '‰ªÖNeo4j';
            } else if (d.source === 'both') {
                sourceText = 'Êú¨Âú∞+Neo4j';
            } else {
                sourceText = 'Êú™Áü•';
            }
            
            let html = `
                <div class="property-item">
                    <span class="property-key">ËäÇÁÇπID:</span>
                    <span class="property-value">${d.neo4j_id}</span>
                </div>
                <div class="property-item">
                    <span class="property-key">Êï∞ÊçÆ‰ΩçÁΩÆ:</span>
                    <span class="property-value">${sourceText}</span>
                </div>
                <div class="property-item">
                    <span class="property-key">Ê†áÁ≠æ:</span>
                    <span class="property-value">${d.labels.join(", ")}</span>
                </div>
                <div class="property-item">
                    <span class="property-key">ÂêçÁß∞:</span>
                    <span class="property-value">${d.label}</span>
                </div>
            `;
            
            // ÊòæÁ§∫ÊâÄÊúâÂ±ûÊÄß
            for (const [key, value] of Object.entries(d.properties)) {
                html += `
                    <div class="property-item">
                        <span class="property-key">${key}:</span>
                        <span class="property-value">${JSON.stringify(value)}</span>
                    </div>
                `;
            }
            
            propertiesDiv.innerHTML = html;
        }
        
        // ÊòæÁ§∫ÂÖ≥Á≥ªËØ¶ÊÉÖ
        function showLinkDetails(event, d) {
            console.log('ÊòæÁ§∫ÂÖ≥Á≥ªËØ¶ÊÉÖ - ÂéüÂßãÊï∞ÊçÆ:', d);
            console.log('ÂÖ≥Á≥ªsource_type:', d.source_type);
            
            // Ê£ÄÊü•ÊòØÂê¶ÊúâÂ§ö‰∏™ÂêåÂêëÂÖ≥Á≥ª
            const sameDirectionLinks = graphData.links.filter(link => 
                (link.source.id === d.source.id && link.target.id === d.target.id) ||
                (link.source.id === d.target.id && link.target.id === d.source.id)
            );
            
            if (sameDirectionLinks.length > 1) {
                // ÊúâÂ§ö‰∏™ÂêåÂêëÂÖ≥Á≥ªÔºåÊòæÁ§∫ÈÄâÊã©Ê°Ü
                showMultiRelationSelector(event, sameDirectionLinks);
                return;
            }
            
            // Âè™Êúâ‰∏Ä‰∏™ÂÖ≥Á≥ªÔºåÁõ¥Êé•ÊòæÁ§∫ËØ¶ÊÉÖ
            showSingleRelationDetails(d);
        }
        
        // ÊòæÁ§∫Â§öÂÖ≥Á≥ªÈÄâÊã©Ê°Ü
        function showMultiRelationSelector(event, relations) {
            // ÁßªÈô§Â∑≤Â≠òÂú®ÁöÑÈÄâÊã©Ê°Ü
            d3.select('.multi-relation-selector').remove();
            
            const mouseX = event.pageX;
            const mouseY = event.pageY;
            
            // ÂàõÂª∫ÈÄâÊã©Ê°ÜÂÆπÂô®
            const selectorDiv = d3.select('body')
                .append('div')
                .attr('class', 'multi-relation-selector')
                .style('position', 'fixed')
                .style('left', Math.min(mouseX + 10, window.innerWidth - 420) + 'px')
                .style('top', Math.min(mouseY - 10, window.innerHeight - 320) + 'px')
                .style('background', '#fff')
                .style('border', '2px solid #007bff')
                .style('border-radius', '8px')
                .style('box-shadow', '0 4px 12px rgba(0,0,0,0.3)')
                .style('z-index', '10000')
                .style('min-width', '300px')
                .style('max-width', '400px')
                .style('max-height', '300px')
                .style('overflow-y', 'auto')
                .style('font-family', 'Arial, sans-serif');
            
            // Ê∑ªÂä†Ê†áÈ¢òÊ†è
            const headerDiv = selectorDiv.append('div')
                .style('background', '#f8f9fa')
                .style('padding', '8px 12px')
                .style('border-bottom', '1px solid #dee2e6')
                .style('display', 'flex')
                .style('justify-content', 'space-between')
                .style('align-items', 'center');
            
            headerDiv.append('span')
                .style('font-weight', 'bold')
                .style('font-size', '14px')
                .style('color', '#495057')
                .text(`ÈÄâÊã©ÂÖ≥Á≥ª (${relations.length}‰∏™)`);
            
            // Ê∑ªÂä†ÂÖ≥Èó≠ÊåâÈíÆ
            headerDiv.append('button')
                .style('background', 'none')
                .style('border', 'none')
                .style('font-size', '18px')
                .style('color', '#6c757d')
                .style('cursor', 'pointer')
                .style('padding', '0')
                .style('width', '24px')
                .style('height', '24px')
                .style('display', 'flex')
                .style('align-items', 'center')
                .style('justify-content', 'center')
                .text('√ó')
                .on('click', function(event) {
                    event.stopPropagation();
                    closeMutliRelationSelector();
                })
                .on('mouseover', function() {
                    d3.select(this).style('background', '#e9ecef').style('border-radius', '4px');
                })
                .on('mouseout', function() {
                    d3.select(this).style('background', 'none');
                });
            
            // Ê∑ªÂä†ÂÖ≥Á≥ªÂàóË°®
            const listDiv = selectorDiv.append('div')
                .style('padding', '8px 0');
            
            relations.forEach((relation, index) => {
                const relationDiv = listDiv.append('div')
                    .style('padding', '8px 12px')
                    .style('cursor', 'pointer')
                    .style('border-bottom', index < relations.length - 1 ? '1px solid #f1f3f4' : 'none')
                    .style('display', 'flex')
                    .style('flex-direction', 'column')
                    .style('transition', 'background-color 0.2s')
                    .on('click', function(event) {
                        event.stopPropagation();
                        selectRelationFromList(relation);
                    })
                    .on('mouseover', function() {
                        d3.select(this).style('background', '#f8f9fa');
                        // È´ò‰∫ÆÂØπÂ∫îÁöÑÂÖ≥Á≥ªÁ∫ø
                        highlightRelation(relation, true);
                    })
                    .on('mouseout', function() {
                        d3.select(this).style('background', '#fff');
                        // ÂèñÊ∂àÈ´ò‰∫Æ
                        highlightRelation(relation, false);
                    });
                
                // ÂÖ≥Á≥ªÁ±ªÂûãÂíåÊñπÂêë
                const typeDiv = relationDiv.append('div')
                    .style('font-weight', 'bold')
                    .style('color', '#495057')
                    .style('margin-bottom', '4px')
                    .style('font-size', '14px');
                
                const sourceNode = graphData.nodes.find(n => n.id === relation.source.id);
                const targetNode = graphData.nodes.find(n => n.id === relation.target.id);
                
                let directionIcon = '‚Üí';
                if (relation.properties?.directivity === 'bidirectional') {
                    directionIcon = '‚Üî';
                } else if (relation.properties?.directivity === 'to_startNode') {
                    directionIcon = '‚Üê';
                }
                
                typeDiv.text(`${relation.type} (${sourceNode?.label || 'Unknown'} ${directionIcon} ${targetNode?.label || 'Unknown'})`);
                
                // ÂÖ≥Á≥ªËØ¶ÁªÜ‰ø°ÊÅØ
                const detailsDiv = relationDiv.append('div')
                    .style('font-size', '12px')
                    .style('color', '#6c757d');
                
                let details = [];
                if (relation.properties?.source) {
                    details.push(`Êù•Ê∫ê: ${relation.properties.source}`);
                }
                if (relation.properties?.confidence) {
                    const confidence = parseFloat(relation.properties.confidence);
                    details.push(`ÁΩÆ‰ø°Â∫¶: ${(confidence * 100).toFixed(1)}%`);
                }
                if (relation.properties?.created_at) {
                    const date = new Date(relation.properties.created_at);
                    details.push(`ÂàõÂª∫: ${date.toLocaleDateString()}`);
                }
                
                if (details.length > 0) {
                    detailsDiv.text(details.join(' ‚Ä¢ '));
                }
            });
            
            // ÁÇπÂáªÂÖ∂‰ªñÂú∞ÊñπÂÖ≥Èó≠ÈÄâÊã©Ê°Ü
            setTimeout(() => {
                d3.select('body').on('click.multiRelationSelector', function(event) {
                    if (!event.target.closest('.multi-relation-selector')) {
                        closeMutliRelationSelector();
                    }
                });
            }, 100);
            
            // ESCÈîÆÂÖ≥Èó≠ÈÄâÊã©Ê°Ü
            d3.select('body').on('keydown.multiRelationSelector', function(event) {
                if (event.key === 'Escape') {
                    closeMutliRelationSelector();
                }
            });
        }
        
        // ÂÖ≥Èó≠Â§öÂÖ≥Á≥ªÈÄâÊã©Ê°Ü
        function closeMutliRelationSelector() {
            d3.select('.multi-relation-selector').remove();
            d3.select('body').on('click.multiRelationSelector', null);
            d3.select('body').on('keydown.multiRelationSelector', null);
            // ÂèñÊ∂àÊâÄÊúâÂÖ≥Á≥ªÁöÑÈ´ò‰∫Æ
            container.selectAll('.link')
                .style('stroke-width', function(d) { return d.properties?.directivity === 'bidirectional' ? '3px' : '2px'; })
                .style('stroke', null);
        }
        
        // ‰ªéÂàóË°®‰∏≠ÈÄâÊã©ÂÖ≥Á≥ª
        function selectRelationFromList(relation) {
            // ÂÖ≥Èó≠ÈÄâÊã©Ê°Ü
            closeMutliRelationSelector();
            
            // ÊòæÁ§∫ÈÄâ‰∏≠ÂÖ≥Á≥ªÁöÑËØ¶ÊÉÖ
            showSingleRelationDetails(relation);
        }
        
        // È´ò‰∫Æ/ÂèñÊ∂àÈ´ò‰∫ÆÂÖ≥Á≥ª
        function highlightRelation(relation, highlight) {
            container.selectAll('.link')
                .filter(d => d === relation)
                .style('stroke-width', highlight ? '5px' : function(d) { return d.properties?.directivity === 'bidirectional' ? '3px' : '2px'; })
                .style('stroke', highlight ? '#ff6b6b' : null);
        }
        
        // ÊòæÁ§∫Âçï‰∏™ÂÖ≥Á≥ªËØ¶ÊÉÖ
        function showSingleRelationDetails(d) {
            const detailsDiv = document.getElementById("node-details");
            const propertiesDiv = document.getElementById("node-properties");
            const titleDiv = document.getElementById("detail-title");
            
            detailsDiv.style.display = "block";
            titleDiv.querySelector('span').textContent = "ÂÖ≥Á≥ªËØ¶ÊÉÖ";
            
            // Ë∑üË∏™ÈÄâ‰∏≠ÁöÑÂÖ≥Á≥ª
            const selectedItemData = {
                type: 'relationship',
                data: d,
                elementId: d.neo4j_id
            };
            
            // Êõ¥Êñ∞ÊúÄËøëÈÄâ‰∏≠ÁöÑÈ°πÁõÆÂàóË°®
            updateRecentSelectedNodes(selectedItemData);
            
            // Â¶ÇÊûúÂà†Èô§ÁïåÈù¢Â∑≤ÊâìÂºÄÔºåÂÆûÊó∂Êõ¥Êñ∞Âà†Èô§ÂÜÖÂÆπ
            updateDeleteFormIfVisible();
            
            // Â¶ÇÊûú‰øÆÊîπÁïåÈù¢Â∑≤ÊâìÂºÄÔºåÂÆûÊó∂Êõ¥Êñ∞‰øÆÊîπÂÜÖÂÆπ
            updateModifyFormIfVisible();
            
            // Â¶ÇÊûúÈìæÊé•ÁïåÈù¢Â∑≤ÊâìÂºÄÔºåÂÆûÊó∂Êõ¥Êñ∞ÈìæÊé•ÂÜÖÂÆπ
            updateLinkFormIfVisible();
            
            // Ëé∑ÂèñËµ∑ÂßãÂíåÁõÆÊ†áËäÇÁÇπÁöÑÂêçÁß∞
            const sourceNode = graphData.nodes.find(node => node.id === d.source.id);
            const targetNode = graphData.nodes.find(node => node.id === d.target.id);
            
            // Á°ÆÂÆöÂ≠òÂÇ®‰ΩçÁΩÆÊñáÊú¨
            let sourceText = '';
            if (d.source_type === 'local') {
                sourceText = '‰ªÖÊú¨Âú∞';
            } else if (d.source_type === 'neo4j') {
                sourceText = '‰ªÖNeo4j';
            } else if (d.source_type === 'both') {
                sourceText = 'Êú¨Âú∞+Neo4j';
            } else {
                sourceText = 'Êú™Áü•';
            }
            
            let html = `
                <div class="property-item">
                    <span class="property-key">ÂÖ≥Á≥ªID:</span>
                    <span class="property-value">${d.neo4j_id}</span>
                </div>
                <div class="property-item">
                    <span class="property-key">Êï∞ÊçÆ‰ΩçÁΩÆ:</span>
                    <span class="property-value">${sourceText}</span>
                </div>
                <div class="property-item">
                    <span class="property-key">ÂÖ≥Á≥ªÁ±ªÂûã:</span>
                    <span class="property-value">${d.type}</span>
                </div>
                <div class="property-item">
                    <span class="property-key">Ëµ∑ÂßãËäÇÁÇπ:</span>
                    <span class="property-value">${sourceNode ? sourceNode.label : 'Unknown'}</span>
                </div>
                <div class="property-item">
                    <span class="property-key">ÁõÆÊ†áËäÇÁÇπ:</span>
                    <span class="property-value">${targetNode ? targetNode.label : 'Unknown'}</span>
                </div>
            `;
            
            // ÊòæÁ§∫ÊâÄÊúâÂÖ≥Á≥ªÂ±ûÊÄß
            for (const [key, value] of Object.entries(d.properties)) {
                html += `
                    <div class="property-item">
                        <span class="property-key">${key}:</span>
                        <span class="property-value">${JSON.stringify(value)}</span>
                    </div>
                `;
            }
            
            propertiesDiv.innerHTML = html;
        }
        
        // ÊéßÂà∂ÂáΩÊï∞
        function resetZoom() {
            svg.transition().call(zoom.transform, d3.zoomIdentity);
        }
        
        let nodeLabelsVisible = true;
        let linkLabelsVisible = true;
        
        function toggleNodeLabels() {
            nodeLabelsVisible = !nodeLabelsVisible;
            nodeLabels.style("display", nodeLabelsVisible ? "block" : "none");
        }
        
        function toggleLinkLabels() {
            linkLabelsVisible = !linkLabelsVisible;
            linkLabels.style("display", linkLabelsVisible ? "block" : "none");
            linkLabelBgs.style("display", linkLabelsVisible ? "block" : "none");
        }
        
        // Âä®ÊÄÅÊõ¥Êñ∞ÂõæË∞±Êï∞ÊçÆÔºàÊó†ÈúÄÈ°µÈù¢Âà∑Êñ∞Ôºâ
        function updateGraphData() {
            console.log('Ê≠£Âú®Âä®ÊÄÅÊõ¥Êñ∞ÂõæË∞±Êï∞ÊçÆ...');
            
            return fetch('/api/get_graph_data', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('ÂõæË∞±Êï∞ÊçÆÊõ¥Êñ∞ÊàêÂäü:', data.data);
                    
                    // Êõ¥Êñ∞ÂÖ®Â±ÄÊï∞ÊçÆ
                    const newGraphData = data.data;
                    
                    // ‰øùÂ≠òÊóßÊï∞ÊçÆ‰ª•‰æøÂØπÊØî
                    const oldNodesCount = graphData.nodes.length;
                    const oldLinksCount = graphData.links.length;
                    
                    // Êõ¥Êñ∞graphData
                    graphData.nodes = newGraphData.nodes || [];
                    graphData.links = newGraphData.links || [];
                    graphData.stats = newGraphData.stats || graphData.stats;
                    
                    // Êõ¥Êñ∞ÂèØËßÜÂåñ
                    updateVisualization();
                    
                    // Êõ¥Êñ∞ÁªüËÆ°‰ø°ÊÅØ
                    updateStats(newGraphData.stats);
                    
                    // ÊòæÁ§∫Êõ¥Êñ∞‰ø°ÊÅØ
                    const newNodesCount = graphData.nodes.length;
                    const newLinksCount = graphData.links.length;
                    const nodesDiff = newNodesCount - oldNodesCount;
                    const linksDiff = newLinksCount - oldLinksCount;
                    
                    if (nodesDiff !== 0 || linksDiff !== 0) {
                        console.log(`ÂõæË∞±Â∑≤Êõ¥Êñ∞: ËäÇÁÇπÂèòÂåñ${nodesDiff > 0 ? '+' : ''}${nodesDiff}, ÂÖ≥Á≥ªÂèòÂåñ${linksDiff > 0 ? '+' : ''}${linksDiff}`);
                    }
                    
                    return true;
                } else {
                    console.error('Âä®ÊÄÅÊõ¥Êñ∞Â§±Ë¥•:', data.error);
                    return false;
                }
            })
            .catch(error => {
                console.error('Âä®ÊÄÅÊõ¥Êñ∞ÈîôËØØ:', error);
                return false;
            });
        }
        
        // Êõ¥Êñ∞ÁªüËÆ°‰ø°ÊÅØÊòæÁ§∫
        function updateStats(stats) {
            if (!stats) return;
            
            document.getElementById("total-nodes").textContent = stats.total_nodes || 0;
            document.getElementById("total-links").textContent = stats.total_links || 0;
            document.getElementById("updated-time").textContent = new Date(stats.updated_at).toLocaleString();
            
            // Êõ¥Êñ∞ËäÇÁÇπÁ±ªÂûãÁªüËÆ°
            const nodeTypesDiv = document.getElementById("node-types");
            let nodeTypesHtml = "";
            for (const [type, count] of Object.entries(stats.node_types || {})) {
                nodeTypesHtml += `
                    <div class="stat-item">
                        <span>${type}:</span>
                        <span>${count}</span>
                    </div>
                `;
            }
            nodeTypesDiv.innerHTML = nodeTypesHtml;
            
            // Êõ¥Êñ∞ÂÖ≥Á≥ªÁ±ªÂûãÁªüËÆ°
            const relationTypesDiv = document.getElementById("relation-types");
            let relationTypesHtml = "";
            for (const [type, count] of Object.entries(stats.relation_types || {})) {
                relationTypesHtml += `
                    <div class="stat-item">
                        <span>${type}:</span>
                        <span>${count}</span>
                    </div>
                `;
            }
            relationTypesDiv.innerHTML = relationTypesHtml;
        }
        
        // Êô∫ËÉΩÂà∑Êñ∞Ôºö‰ºòÂÖà‰ΩøÁî®Âä®ÊÄÅÊõ¥Êñ∞ÔºåÂ§±Ë¥•Êó∂‰ΩøÁî®È°µÈù¢Âà∑Êñ∞
        function smartRefresh() {
            console.log('ÊâßË°åÊô∫ËÉΩÂà∑Êñ∞...');
            
            // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
            const refreshBtn = document.querySelector('.refresh-controls');
            const originalText = refreshBtn.innerHTML;
            refreshBtn.innerHTML = '‚è≥ Êõ¥Êñ∞‰∏≠...';
            refreshBtn.disabled = true;
            
            // Â∞ùËØïÂä®ÊÄÅÊõ¥Êñ∞
            updateGraphData().then(success => {
                if (success) {
                    // Âä®ÊÄÅÊõ¥Êñ∞ÊàêÂäü
                    console.log('Âä®ÊÄÅÊõ¥Êñ∞ÊàêÂäü');
                    refreshBtn.innerHTML = '‚úÖ Â∑≤Êõ¥Êñ∞';
                    setTimeout(() => {
                        refreshBtn.innerHTML = originalText;
                        refreshBtn.disabled = false;
                    }, 2000);
                } else {
                    // Âä®ÊÄÅÊõ¥Êñ∞Â§±Ë¥•ÔºåËØ¢ÈóÆÊòØÂê¶È°µÈù¢Âà∑Êñ∞
                    refreshBtn.innerHTML = originalText;
                    refreshBtn.disabled = false;
                    
                    if (confirm('Âä®ÊÄÅÊõ¥Êñ∞Â§±Ë¥•ÔºåÊòØÂê¶ÈáçÊñ∞Âä†ËΩΩÈ°µÈù¢‰ª•Ëé∑ÂèñÊúÄÊñ∞Êï∞ÊçÆÔºü\n\nÁÇπÂáª"Á°ÆÂÆö"ÈáçÊñ∞Âä†ËΩΩÈ°µÈù¢\nÁÇπÂáª"ÂèñÊ∂à"‰øùÊåÅÂΩìÂâçÁä∂ÊÄÅ')) {
                        refreshData(); // ‰ΩøÁî®È°µÈù¢Âà∑Êñ∞
                    }
                }
            }).catch(error => {
                console.error('Êô∫ËÉΩÂà∑Êñ∞Â§±Ë¥•:', error);
                refreshBtn.innerHTML = originalText;
                refreshBtn.disabled = false;
                
                if (confirm('ÂõæË∞±Êõ¥Êñ∞Â§±Ë¥•ÔºåÊòØÂê¶ÈáçÊñ∞Âä†ËΩΩÈ°µÈù¢Ôºü\n\nÁÇπÂáª"Á°ÆÂÆö"ÈáçÊñ∞Âä†ËΩΩÈ°µÈù¢\nÁÇπÂáª"ÂèñÊ∂à"‰øùÊåÅÂΩìÂâçÁä∂ÊÄÅ')) {
                    refreshData(); // ‰ΩøÁî®È°µÈù¢Âà∑Êñ∞
                }
            });
        }
        
        // Âà∑Êñ∞Êï∞ÊçÆÂäüËÉΩÔºàÈ°µÈù¢ÈáçÊñ∞Âä†ËΩΩÊñπÂºèÔºâ
        function refreshData() {
            console.log('Ê≠£Âú®Âà∑Êñ∞Êï∞ÊçÆ...');
            
            // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
            const refreshBtn = document.querySelector('.refresh-controls');
            const originalText = refreshBtn.innerHTML;
            refreshBtn.innerHTML = '‚è≥ Âà∑Êñ∞‰∏≠...';
            refreshBtn.disabled = true;
            
            fetch('/api/refresh_data', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                console.log('Âà∑Êñ∞ÁªìÊûú:', data);
                if (data.success) {
                    // ÈÄöÁü•ÊúçÂä°Âô®Âç≥Â∞ÜÂà∑Êñ∞ÔºåÁÑ∂ÂêéÈáçÊñ∞Âä†ËΩΩÈ°µÈù¢
                    notifyRefreshAndReload();
                } else {
                    alert('Âà∑Êñ∞Â§±Ë¥•: ' + (data.error || 'Êú™Áü•ÈîôËØØ'));
                    refreshBtn.innerHTML = originalText;
                    refreshBtn.disabled = false;
                }
            })
            .catch(error => {
                console.error('Âà∑Êñ∞ÈîôËØØ:', error);
                alert('Âà∑Êñ∞Â§±Ë¥•: ' + error.message);
                refreshBtn.innerHTML = originalText;
                refreshBtn.disabled = false;
            });
        }
        
        // ÂàùÂßãÂåñÁªüËÆ°‰ø°ÊÅØ
        function initStats() {
            document.getElementById("total-nodes").textContent = graphData.stats.total_nodes;
            document.getElementById("total-links").textContent = graphData.stats.total_links;
            document.getElementById("updated-time").textContent = new Date(graphData.stats.updated_at).toLocaleString();
            
            // ËäÇÁÇπÁ±ªÂûãÁªüËÆ°
            const nodeTypesDiv = document.getElementById("node-types");
            let nodeTypesHtml = "";
            for (const [type, count] of Object.entries(graphData.stats.node_types)) {
                nodeTypesHtml += `
                    <div class="stat-item">
                        <span>${type}:</span>
                        <span>${count}</span>
                    </div>
                `;
            }
            nodeTypesDiv.innerHTML = nodeTypesHtml;
            
            // ÂÖ≥Á≥ªÁ±ªÂûãÁªüËÆ°
            const relationTypesDiv = document.getElementById("relation-types");
            let relationTypesHtml = "";
            for (const [type, count] of Object.entries(graphData.stats.relation_types)) {
                relationTypesHtml += `
                    <div class="stat-item">
                        <span>${type}:</span>
                        <span>${count}</span>
                    </div>
                `;
            }
            relationTypesDiv.innerHTML = relationTypesHtml;
        }
        
        function updateNodeSelectionLists() {
            const modifySelect = document.getElementById('modify-node-select');
            const deleteSelect = document.getElementById('delete-node-select');
            const linkSourceSelect = document.getElementById('link-source-select');
            const linkTargetSelect = document.getElementById('link-target-select');
            
            // Âè™Êõ¥Êñ∞Â≠òÂú®ÁöÑÈÄâÊã©Ê°Ü
            if (modifySelect) {
                modifySelect.innerHTML = '<option value="">ËØ∑ÈÄâÊã©Ë¶Å‰øÆÊîπÁöÑËäÇÁÇπ</option>';
                graphData.nodes.forEach(node => {
                    const option = document.createElement('option');
                    option.value = node.id;
                    option.textContent = `${node.label} (${node.group})`;
                    modifySelect.appendChild(option);
                });
            }
            
            if (deleteSelect) {
                deleteSelect.innerHTML = '<option value="">ËØ∑ÈÄâÊã©Ë¶ÅÂà†Èô§ÁöÑËäÇÁÇπ</option>';
                graphData.nodes.forEach(node => {
                    const option = document.createElement('option');
                    option.value = node.id;
                    option.textContent = `${node.label} (${node.group})`;
                    deleteSelect.appendChild(option);
                });
            }
            
            if (linkSourceSelect) {
                linkSourceSelect.innerHTML = '<option value="">ËØ∑ÈÄâÊã©Ëµ∑ÂßãËäÇÁÇπ</option>';
                graphData.nodes.forEach(node => {
                    const option = document.createElement('option');
                    option.value = node.id;
                    option.textContent = `${node.label} (${node.group})`;
                    linkSourceSelect.appendChild(option);
                });
            }
            
            if (linkTargetSelect) {
                linkTargetSelect.innerHTML = '<option value="">ËØ∑ÈÄâÊã©ÁõÆÊ†áËäÇÁÇπ</option>';
                graphData.nodes.forEach(node => {
                    const option = document.createElement('option');
                    option.value = node.id;
                    option.textContent = `${node.label} (${node.group})`;
                    linkTargetSelect.appendChild(option);
                });
            }
        }
        
        function showAddNodeForm() {
            hideEditForms();
            
            // ÂàõÂª∫ËäÇÁÇπÁ±ªÂûãÈÄâÊã©ÁïåÈù¢
            const editForms = document.querySelector('.edit-forms');
            editForms.innerHTML = `
                <div class="node-type-buttons">
                    <button class="node-type-button" onclick="selectNodeType('Entity')">
                        <span class="node-type-icon">üè∑Ô∏è</span>
                        <span class="node-type-text">ÂÆû‰ΩìËäÇÁÇπ</span>
                    </button>
                    <button class="node-type-button" onclick="selectNodeType('Time')">
                        <span class="node-type-icon">‚è∞</span>
                        <span class="node-type-text">Êó∂Èó¥ËäÇÁÇπ</span>
                    </button>
                    <button class="node-type-button" onclick="selectNodeType('Character')">
                        <span class="node-type-icon">üë§</span>
                        <span class="node-type-text">ËßíËâ≤ËäÇÁÇπ</span>
                    </button>
                    <button class="node-type-button" onclick="selectNodeType('Location')">
                        <span class="node-type-icon">üìç</span>
                        <span class="node-type-text">Âú∞ÁÇπËäÇÁÇπ</span>
                    </button>
                </div>
                <!-- Áî®Êà∑ËæìÂÖ•Ë°®ÂçïÂå∫Âüü -->
                <div class="user-input-form" id="user-input-form" style="display: none;">
                </div>
            `;
            
            // ÈáçÁΩÆÊåâÈíÆÁä∂ÊÄÅ
            resetButtonStates();
            document.querySelector('.add-node-btn').classList.add('active');
        }
        
        function showModifyNodeForm() {
            hideEditForms();
            
            // Êõ¥Êñ∞‰øÆÊîπË°®ÂçïÂÜÖÂÆπ
            updateModifyFormContent();
            
            // ËÆæÁΩÆÊåâÈíÆÁä∂ÊÄÅ
            resetButtonStates();
            document.querySelector('.modify-node-btn').classList.add('active');
        }
        
        function showLinkNodeForm() {
            hideEditForms();
            
            // Êõ¥Êñ∞ÈìæÊé•Ë°®ÂçïÂÜÖÂÆπ
            updateLinkFormContent();
            
            // ËÆæÁΩÆÊåâÈíÆÁä∂ÊÄÅ
            resetButtonStates();
            document.querySelector('.link-node-btn').classList.add('active');
        }
        
        // Ëé∑ÂèñÈÄâ‰∏≠È°πÁõÆÁöÑ‰ø°ÊÅØÊòæÁ§∫ÊñáÊú¨
        function getSelectedItemInfo() {
            const selectedItem = recentSelectedNodes[0];
            if (!selectedItem) {
                return 'Êó†ÈÄâ‰∏≠È°πÁõÆ';
            }
            
            if (selectedItem.type === 'node') {
                const node = selectedItem.data;
                return `
                    <strong>ËäÇÁÇπÔºö</strong>${node.label}<br>
                    <strong>Á±ªÂûãÔºö</strong>${node.labels.join(", ")}<br>
                    <strong>IDÔºö</strong>${node.neo4j_id}
                `;
            } else if (selectedItem.type === 'relationship') {
                const rel = selectedItem.data;
                const sourceNode = graphData.nodes.find(node => node.id === rel.source.id);
                const targetNode = graphData.nodes.find(node => node.id === rel.target.id);
                return `
                    <strong>ÂÖ≥Á≥ªÔºö</strong>${rel.type}<br>
                    <strong>‰ªéÔºö</strong>${sourceNode ? sourceNode.label : 'Unknown'}<br>
                    <strong>Âà∞Ôºö</strong>${targetNode ? targetNode.label : 'Unknown'}<br>
                    <strong>IDÔºö</strong>${rel.neo4j_id}
                `;
            }
            
            return 'Êú™Áü•È°πÁõÆÁ±ªÂûã';
        }
        
        // Ëé∑ÂèñÁõ∏ÂÖ≥È°πÁõÆÊï∞ÈáèÔºà‰ªÖÂØπËäÇÁÇπÊúâÊÑè‰πâÔºâ
        function getRelatedItemsCount() {
            const selectedItem = recentSelectedNodes[0];
            if (!selectedItem || selectedItem.type !== 'node') {
                return 0;
            }
            
            const nodeId = selectedItem.data.id;
            return graphData.links.filter(link => 
                link.source.id === nodeId || link.target.id === nodeId
            ).length;
        }
        
        // Ê£ÄÊü•Âà†Èô§ÁïåÈù¢ÊòØÂê¶ÂèØËßÅÔºåÂ¶ÇÊûúÂèØËßÅÂàôÊõ¥Êñ∞ÂÜÖÂÆπ
        function updateDeleteFormIfVisible() {
            const deleteBtn = document.querySelector('.delete-node-btn');
            if (deleteBtn && deleteBtn.classList.contains('active')) {
                // Âà†Èô§ÁïåÈù¢Â∑≤ÊâìÂºÄÔºåÊõ¥Êñ∞ÂÜÖÂÆπ‰ΩÜ‰∏çÈáçÁΩÆÊåâÈíÆÁä∂ÊÄÅ
                updateDeleteFormContent();
            }
        }
        
        // Ê£ÄÊü•‰øÆÊîπÁïåÈù¢ÊòØÂê¶ÂèØËßÅÔºåÂ¶ÇÊûúÂèØËßÅÂàôÊõ¥Êñ∞ÂÜÖÂÆπ
        function updateModifyFormIfVisible() {
            const modifyBtn = document.querySelector('.modify-node-btn');
            if (modifyBtn && modifyBtn.classList.contains('active')) {
                // ‰øÆÊîπÁïåÈù¢Â∑≤ÊâìÂºÄÔºåÊõ¥Êñ∞ÂÜÖÂÆπ‰ΩÜ‰∏çÈáçÁΩÆÊåâÈíÆÁä∂ÊÄÅ
                updateModifyFormContent();
            }
        }
        
        // Ê£ÄÊü•ÈìæÊé•ÁïåÈù¢ÊòØÂê¶ÂèØËßÅÔºåÂ¶ÇÊûúÂèØËßÅÂàôÊõ¥Êñ∞ÂÜÖÂÆπ
        function updateLinkFormIfVisible() {
            const linkBtn = document.querySelector('.link-node-btn');
            if (linkBtn && linkBtn.classList.contains('active')) {
                // ÈìæÊé•ÁïåÈù¢Â∑≤ÊâìÂºÄÔºåÊõ¥Êñ∞ÂÜÖÂÆπ‰ΩÜ‰∏çÈáçÁΩÆÊåâÈíÆÁä∂ÊÄÅ
                updateLinkFormContent();
            }
        }
        
        // Êõ¥Êñ∞ÊúÄËøëÈÄâ‰∏≠ÁöÑÈ°πÁõÆÂàóË°®ÔºàËäÇÁÇπÂíåÂÖ≥Á≥ªÔºâ
        function updateRecentSelectedNodes(itemData) {
            // Ê£ÄÊü•ÂèÇÊï∞
            if (!itemData) return;
            
            // Ê£ÄÊü•ÊòØÂê¶Â∑≤ÁªèÂú®ÂàóË°®‰∏≠
            const existingIndex = recentSelectedNodes.findIndex(item => 
                item.elementId === itemData.elementId && item.type === itemData.type);
            
            if (existingIndex !== -1) {
                // Â¶ÇÊûúÂ∑≤Â≠òÂú®ÔºåÁßªÈô§ÂêéÈáçÊñ∞Ê∑ªÂä†Âà∞ÊúÄÂâçÈù¢
                recentSelectedNodes.splice(existingIndex, 1);
            }
            
            // Ê∑ªÂä†Âà∞ÂàóË°®ÂºÄÂ§¥
            recentSelectedNodes.unshift(itemData);
            
            // Âè™‰øùÁïôÊúÄËøëÁöÑ10‰∏™È°πÁõÆ
            if (recentSelectedNodes.length > 10) {
                recentSelectedNodes = recentSelectedNodes.slice(0, 10);
            }
            
            // Â¶ÇÊûúÂú®Âà†Èô§Ê®°Âºè‰∏ãÔºåÊõ¥Êñ∞Ê†∑Âºè
            if (deleteMode) {
                updateSelectedItemsStyle();
            }
        }
        
        // Êõ¥Êñ∞ÈÄâ‰∏≠È°πÁõÆÁöÑÊ†∑ÂºèÔºàÂà†Èô§Ê®°Âºè‰∏ãÊòæÁ§∫Á∫¢Ëâ≤ÊèèËæπÔºâ
        function updateSelectedItemsStyle() {
            // ÈáçÁΩÆÊâÄÊúâËäÇÁÇπÁöÑÊ†∑Âºè
            container.selectAll(".node")
                .attr("stroke", d => d.strokeColor)
                .attr("stroke-width", d => d.strokeWidth);
            
            // ÈáçÁΩÆÊâÄÊúâÂÖ≥Á≥ªÁöÑÊ†∑Âºè
            container.selectAll(".link")
                .attr("stroke", d => getStorageTypeColor(d.source_type))
                .attr("stroke-width", "2");
            
            // Â¶ÇÊûúÂú®Âà†Èô§Ê®°Âºè‰∏ãÔºå‰∏∫ÈÄâ‰∏≠ÁöÑÈ°πÁõÆÊ∑ªÂä†Á∫¢Ëâ≤ÊèèËæπ
            if (deleteMode) {
                recentSelectedNodes.forEach(item => {
                    if (item.type === 'node') {
                        // ‰∏∫ÈÄâ‰∏≠ÁöÑËäÇÁÇπÊ∑ªÂä†Á∫¢Ëâ≤ÊèèËæπ
                        container.selectAll(".node")
                            .filter(d => d.id === item.data.id)
                            .attr("stroke", "#ff0000")
                            .attr("stroke-width", "4");
                    } else if (item.type === 'relationship') {
                        // ‰∏∫ÈÄâ‰∏≠ÁöÑÂÖ≥Á≥ªÊ∑ªÂä†Á∫¢Ëâ≤ÊèèËæπ
                        container.selectAll(".link")
                            .filter(d => d.neo4j_id === item.data.neo4j_id)
                            .attr("stroke", "#ff0000")
                            .attr("stroke-width", "4");
                    }
                });
            }
        }
        
        // Êõ¥Êñ∞Âà†Èô§Ë°®ÂçïÂÜÖÂÆπ
        function updateDeleteFormContent() {
            const editForms = document.querySelector('.edit-forms');
            
            if (recentSelectedNodes.length === 0) {
                // Êú™ÈÄâ‰∏≠‰ªª‰ΩïÈ°πÁõÆ
                editForms.innerHTML = `
                    <div class="edit-form">
                        <h4>Âà†Èô§È°πÁõÆ</h4>
                        <div class="warning-text">
                            ËØ∑ÂÖàÁÇπÂáªÈÄâ‰∏≠‰∏Ä‰∏™ÊàñÂ§ö‰∏™ËäÇÁÇπÊàñÂÖ≥Á≥ªÂêéÂÜçËøõË°åÂà†Èô§Êìç‰Ωú„ÄÇ
                        </div>
                    </div>
                `;
            } else {
                // ËÆ°ÁÆóÂ∞ÜË¶ÅÂà†Èô§ÁöÑÊâÄÊúâÈ°πÁõÆ
                let totalNodeCount = 0;
                let totalRelationshipCount = 0;
                let itemsList = [];
                
                recentSelectedNodes.forEach((item, index) => {
                    if (item.type === 'node') {
                        totalNodeCount += 1;
                        // ËÆ°ÁÆóÊØè‰∏™ËäÇÁÇπÁöÑÁõ∏ÂÖ≥ÂÖ≥Á≥ªÊï∞Èáè
                        const relatedCount = graphData.links.filter(link => 
                            link.source.id === item.data.id || link.target.id === item.data.id
                        ).length;
                        totalRelationshipCount += relatedCount;
                        itemsList.push(`<strong>ËäÇÁÇπ${index + 1}:</strong> ${item.data.label} (ËäÇÁÇπ, Â∞ÜÂà†Èô§${relatedCount}‰∏™ÂÖ≥Á≥ª)`);
                    } else if (item.type === 'relationship') {
                        totalRelationshipCount += 1;
                        const sourceNode = graphData.nodes.find(node => node.id === item.data.source.id);
                        const targetNode = graphData.nodes.find(node => node.id === item.data.target.id);
                        itemsList.push(`<strong>ÂÖ≥Á≥ª${index + 1}:</strong> ${item.data.type} (‰ªé "${sourceNode ? sourceNode.label : 'Unknown'}" Âà∞ "${targetNode ? targetNode.label : 'Unknown'}")`);
                    }
                });
                
                let warningText = '';
                if (totalNodeCount > 0 && totalRelationshipCount > 0) {
                    warningText = `
                        <div class="warning-text">
                            Ë≠¶ÂëäÔºöÊ≠§Ê¨°Êìç‰ΩúÂ∞ÜÂà†Èô§ ${totalNodeCount} ‰∏™ËäÇÁÇπÂíå ${totalRelationshipCount} ‰∏™ÂÖ≥Á≥ªÔºÅ
                        </div>
                    `;
                } else if (totalNodeCount > 0) {
                    warningText = `
                        <div class="warning-text">
                            Ë≠¶ÂëäÔºöÊ≠§Ê¨°Êìç‰ΩúÂ∞ÜÂà†Èô§ ${totalNodeCount} ‰∏™ËäÇÁÇπÂíåÂÖ∂Áõ∏ÂÖ≥ÁöÑ ${totalRelationshipCount} ‰∏™ÂÖ≥Á≥ªÔºÅ
                        </div>
                    `;
                } else if (totalRelationshipCount > 0) {
                    warningText = `
                        <div class="warning-text">
                            Ë≠¶ÂëäÔºöÊ≠§Ê¨°Êìç‰ΩúÂ∞ÜÂà†Èô§ ${totalRelationshipCount} ‰∏™ÂÖ≥Á≥ªÔºÅ
                        </div>
                    `;
                }
                
                editForms.innerHTML = `
                    <div class="edit-form">
                        <h4>Âç≥Â∞ÜÂà†Èô§ (ÂÖ±${recentSelectedNodes.length}‰∏™È°πÁõÆ)</h4>
                        <div class="form-group">
                            <label>ÈÄâ‰∏≠ÁöÑÈ°πÁõÆÂàóË°®Ôºö</label>
                            <div style="padding: 8px; background: #f8f9fa; border-radius: 4px; margin-top: 5px; max-height: 200px; overflow-y: auto;">
                                ${itemsList.join('<br>')}
                            </div>
                        </div>
                        ${warningText}
                        <div class="form-group">
                            <label>Âà†Èô§ÁªüËÆ°Ôºö</label>
                            <div style="padding: 8px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px; margin-top: 5px;">
                                ‚Ä¢ ËäÇÁÇπÔºö${totalNodeCount} ‰∏™<br>
                                ‚Ä¢ ÂÖ≥Á≥ªÔºö${totalRelationshipCount} ‰∏™<br>
                                ‚Ä¢ ÊÄªËÆ°Ôºö${totalNodeCount + totalRelationshipCount} ‰∏™È°πÁõÆ
                            </div>
                        </div>
                        <div class="form-actions">
                            <button class="action-btn danger-btn" onclick="confirmDelete()">Á°ÆËÆ§Âà†Èô§</button>
                            <button class="action-btn" onclick="clearRecentNodes()" style="background-color: #6c757d; color: white;">Ê∏ÖÁ©∫Â∑≤ÈÄâ</button>
                            <button class="action-btn cancel-btn" onclick="hideEditForms()">ÂèñÊ∂à</button>
                        </div>
                    </div>
                `;
            }
        }
        
        // Êõ¥Êñ∞‰øÆÊîπË°®ÂçïÂÜÖÂÆπ
        function updateModifyFormContent() {
            const editForms = document.querySelector('.edit-forms');
            const selectedItem = recentSelectedNodes[0];
            
            if (!selectedItem) {
                // Êú™ÈÄâ‰∏≠‰ªª‰ΩïÈ°πÁõÆ
                editForms.innerHTML = `
                    <div class="edit-form">
                        <h4>‰øÆÊîπÈ°πÁõÆ</h4>
                        <div class="warning-text">
                            ËØ∑ÂÖàÁÇπÂáªÈÄâ‰∏≠‰∏Ä‰∏™ËäÇÁÇπÊàñÂÖ≥Á≥ªÂêéÂÜçËøõË°å‰øÆÊîπÊìç‰Ωú„ÄÇ
                        </div>
                    </div>
                `;
            } else {
                // ÊòæÁ§∫ÈÄâ‰∏≠È°πÁõÆÁöÑËØ¶ÁªÜ‰ø°ÊÅØÔºàËäÇÁÇπÊàñÂÖ≥Á≥ªÔºâ
                const item = selectedItem.data;
                
                // Ëé∑ÂèñÂΩìÂâçËäÇÁÇπÁöÑ‰∏ªË¶ÅÁ±ªÂûãÔºàÂú®ÂáΩÊï∞ÂºÄÂ§¥ÂÆö‰πâÔºåÁ°Æ‰øù‰ΩúÁî®ÂüüÊ≠£Á°ÆÔºâ
                let currentType = 'Entity';
                if (selectedItem.type === 'node') {
                    currentType = item.labels.find(label => label === 'Character' || label === 'Entity' || label === 'Location') || 'Entity';
                }
                
                // Ê£ÄÊü•ÊòØÂê¶‰∏∫Êó∂Èó¥ËäÇÁÇπ
                if (selectedItem.type === 'node' && item.labels && item.labels.includes('Time')) {
                    // Êó∂Èó¥ËäÇÁÇπÁâπÊÆäÂ§ÑÁêÜ
                    editForms.innerHTML = `
                        <div class="edit-form">
                            <h4>Êó∂Èó¥ËäÇÁÇπ‰ø°ÊÅØ</h4>
                            <div class="form-group">
                                <div style="padding: 15px; background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 6px; margin-bottom: 15px;">
                                    <div style="display: flex; align-items: center; margin-bottom: 8px;">
                                        <span style="font-size: 18px; margin-right: 8px;">‚ö†Ô∏è</span>
                                        <span style="font-weight: 600; color: #721c24;">‰∏çÊîØÊåÅ‰øÆÊîπÊó∂Èó¥ËäÇÁÇπ</span>
                                    </div>
                                    <div style="color: #721c24; font-size: 14px; line-height: 1.4;">
                                        Êó∂Èó¥ËäÇÁÇπÊòØÁ≥ªÁªüËá™Âä®ÁÆ°ÁêÜÁöÑËäÇÁÇπÔºå‰∏çÊîØÊåÅÁõ¥Êé•‰øÆÊîπ„ÄÇ<br>
                                        Â¶ÇÈúÄ‰øÆÊîπÂÆû‰ΩìÂØπÂ∫îÁöÑÊó∂Èó¥ÔºåËØ∑‰ªéÁõ∏ÂÖ≥ÁöÑÂÆû‰ΩìËäÇÁÇπËøõË°å‰øÆÊîπ„ÄÇ
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-actions">
                                <button class="action-btn cancel-btn" onclick="hideEditForms()">ÂÖ≥Èó≠</button>
                            </div>
                        </div>
                    `;
                    return; // Áõ¥Êé•ËøîÂõûÔºå‰∏çÊâßË°åÂêéÁª≠Â§ÑÁêÜ
                }
                
                // Ê£ÄÊü•ÊòØÂê¶‰∏∫Êó∂Èó¥ËäÇÁÇπ‰πãÈó¥ÁöÑÂÖ≥Á≥ª
                if (selectedItem.type === 'relationship') {
                    // Ëé∑ÂèñÂÖ≥Á≥ªÁöÑËµ∑ÂßãÂíåÁªìÊùüËäÇÁÇπ
                    const startNode = graphData.nodes.find(n => n.id === selectedItem.data.source.id);
                    const endNode = graphData.nodes.find(n => n.id === selectedItem.data.target.id);
                    
                    // Ê£ÄÊü•ÊòØÂê¶‰∏§‰∏™ËäÇÁÇπÈÉΩÊòØÊó∂Èó¥ËäÇÁÇπ
                    if ((startNode && startNode.labels && startNode.labels.includes('Time')) && 
                        (endNode && endNode.labels && endNode.labels.includes('Time'))) {
                        editForms.innerHTML = `
                            <div class="edit-form">
                                <h4>Êó∂Èó¥ËäÇÁÇπÂÖ≥Á≥ª‰ø°ÊÅØ</h4>
                                <div class="form-group">
                                    <div style="padding: 15px; background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 6px; margin-bottom: 15px;">
                                        <div style="display: flex; align-items: center; margin-bottom: 8px;">
                                            <span style="font-size: 18px; margin-right: 8px;">‚ö†Ô∏è</span>
                                            <span style="font-weight: 600; color: #721c24;">‰∏çÊîØÊåÅ‰øÆÊîπÊó∂Èó¥ËäÇÁÇπÂÖ≥Á≥ª</span>
                                        </div>
                                        <div style="color: #721c24; font-size: 14px; line-height: 1.4;">
                                            Êó∂Èó¥ËäÇÁÇπ‰πãÈó¥ÁöÑÂÖ≥Á≥ªÁî±Á≥ªÁªüËá™Âä®ÁÆ°ÁêÜÔºå‰∏çÊîØÊåÅÁõ¥Êé•‰øÆÊîπ„ÄÇ<br>
                                            Ëøô‰∫õÂÖ≥Á≥ªÁî®‰∫éÁª¥Êä§Êó∂Èó¥ÁöÑÂ±ÇÊ¨°ÁªìÊûÑÔºàÂπ¥-Êúà-Êó•-Êó∂Á≠âÔºâÔºåËØ∑ÂãøÊâãÂä®‰øÆÊîπ„ÄÇ
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="form-actions">
                                    <button class="action-btn cancel-btn" onclick="hideEditForms()">ÂÖ≥Èó≠</button>
                                </div>
                            </div>
                        `;
                        return; // Áõ¥Êé•ËøîÂõûÔºå‰∏çÊâßË°åÂêéÁª≠Â§ÑÁêÜ
                    }
                }
                
                // Â§ÑÁêÜ‰∏çÂêåÁ±ªÂûãÈ°πÁõÆÁöÑÊòæÁ§∫
                let itemTypeText = '';
                let itemNameText = '';
                let sourceText = '';
                let propertiesHtml = '';
                
                if (selectedItem.type === 'node') {
                    itemTypeText = 'ËäÇÁÇπ';
                    itemNameText = item.label;
                    
                    if (item.source === 'local') {
                        sourceText = '‰ªÖÊú¨Âú∞';
                    } else if (item.source === 'neo4j') {
                        sourceText = '‰ªÖNeo4j';
                    } else if (item.source === 'both') {
                        sourceText = 'Êú¨Âú∞+Neo4j';
                    } else {
                        sourceText = 'Êú™Áü•';
                    }
                } else if (selectedItem.type === 'relationship') {
                    itemTypeText = 'ÂÖ≥Á≥ª';
                    itemNameText = item.type;
                    sourceText = 'Neo4j'; // ÂÖ≥Á≥ªÈÄöÂ∏∏Êù•Ëá™Neo4j
                }
                
                // ÊòæÁ§∫ÂèØÁºñËæëÁöÑÈ°πÁõÆÂ±ûÊÄßÔºàËøáÊª§ÊéâÁ≥ªÁªüÁÆ°ÁêÜÁöÑÂ±ûÊÄßÔºâ
                for (const [key, value] of Object.entries(item.properties)) {
                    if (!EXCLUDED_PROPERTIES.includes(key)) {
                        const valueStr = typeof value === 'string' ? value : JSON.stringify(value);
                        propertiesHtml += `
                            <div class="property-item" style="margin: 8px 0; padding: 6px; background: #f8f9fa; border-radius: 4px; border-left: 3px solid #007bff;">
                                <div style="font-weight: 500; color: #495057; font-size: 13px; margin-bottom: 4px;">${key}:</div>
                                <input type="text" id="edit-property-${key}" value="${valueStr}" style="width: 100%; padding: 4px 8px; border: 1px solid #ddd; border-radius: 3px; font-size: 12px; color: #495057;" placeholder="ËØ∑ËæìÂÖ•${key}ÁöÑÂÄº">
                            </div>
                        `;
                    }
                }
                
                // ‰∏∫ÂÖ≥Á≥ªÁ±ªÂûãÊ∑ªÂä†È¢ùÂ§ñ‰ø°ÊÅØ
                let extraInfo = '';
                if (selectedItem.type === 'relationship') {
                    const sourceNode = graphData.nodes.find(node => node.id === item.source.id);
                    const targetNode = graphData.nodes.find(node => node.id === item.target.id);
                    extraInfo = `
                        <div class="property-item" style="margin: 6px 0; display: flex; justify-content: space-between;">
                            <span style="font-weight: 600; color: #0c5460;">Ëµ∑ÂßãËäÇÁÇπ:</span>
                            <span style="font-weight: 500; color: #495057; max-width: 200px; word-break: break-all;">${sourceNode ? sourceNode.label : 'Unknown'}</span>
                        </div>
                        <div class="property-item" style="margin: 6px 0; display: flex; justify-content: space-between;">
                            <span style="font-weight: 600; color: #0c5460;">ÁõÆÊ†áËäÇÁÇπ:</span>
                            <span style="font-weight: 500; color: #495057; max-width: 200px; word-break: break-all;">${targetNode ? targetNode.label : 'Unknown'}</span>
                        </div>
                    `;
                } else {
                    // ‰∏∫ËäÇÁÇπÁ±ªÂûãÊ∑ªÂä†È¢ùÂ§ñ‰ø°ÊÅØÔºàcurrentTypeÂ∑≤Âú®ÂáΩÊï∞ÂºÄÂ§¥ÂÆö‰πâÔºâ
                    extraInfo = `
                        <div class="property-item" style="margin: 6px 0; display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-weight: 600; color: #0c5460;">ËäÇÁÇπÁ±ªÂûãÔºö</span>
                            <div style="display: flex; gap: 8px;">
                                <button type="button" id="btn-entity" onclick="selectNodeTypeInEdit('Entity')" style="padding: 4px 12px; border: 1px solid #ddd; border-radius: 4px; background: ${currentType === 'Entity' ? '#007bff' : '#fff'}; color: ${currentType === 'Entity' ? '#fff' : '#495057'}; cursor: pointer; font-size: 12px; font-weight: 500;">Entity</button>
                                <button type="button" id="btn-character" onclick="selectNodeTypeInEdit('Character')" style="padding: 4px 12px; border: 1px solid #ddd; border-radius: 4px; background: ${currentType === 'Character' ? '#007bff' : '#fff'}; color: ${currentType === 'Character' ? '#fff' : '#495057'}; cursor: pointer; font-size: 12px; font-weight: 500;">Character</button>
                                <button type="button" id="btn-location" onclick="selectNodeTypeInEdit('Location')" style="padding: 4px 12px; border: 1px solid #ddd; border-radius: 4px; background: ${currentType === 'Location' ? '#007bff' : '#fff'}; color: ${currentType === 'Location' ? '#fff' : '#495057'}; cursor: pointer; font-size: 12px; font-weight: 500;">Location</button>
                            </div>
                            <input type="hidden" id="edit-node-type" value="${currentType}">
                        </div>
                    `;
                }
                
                editForms.innerHTML = `
                    <div class="edit-form">
                        <h4>${itemTypeText}ËØ¶ÁªÜ‰ø°ÊÅØ</h4>
                        <div class="form-group">
                            <div style="padding: 12px; background: #e8f4fd; border-radius: 6px; border: 1px solid #bee5eb; margin-bottom: 15px;">
                                <div class="property-item" style="margin: 6px 0; display: flex; justify-content: space-between;">
                                    <span style="font-weight: 600; color: #0c5460;">${itemTypeText}ID:</span>
                                    <span style="font-family: monospace; background: #fff; padding: 2px 6px; border-radius: 3px; border: 1px solid #ddd;">${item.neo4j_id}</span>
                                </div>
                                <div class="property-item" style="margin: 6px 0; display: flex; justify-content: space-between;">
                                    <span style="font-weight: 600; color: #0c5460;">Êï∞ÊçÆ‰ΩçÁΩÆ:</span>
                                    <span style="padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 500; background: ${getStorageUIBackground(sourceText)}; color: ${getStorageUIColor(sourceText)};">${sourceText}</span>
                                </div>
                                ${extraInfo}
                            </div>
                            
                            <!-- Âä®ÊÄÅÂ±ûÊÄßÂå∫Âüü -->
                            <div id="dynamic-properties-container">
                                <!-- ËøôÈáå‰ºöÊ†πÊçÆËäÇÁÇπÁ±ªÂûãÂä®ÊÄÅÊèíÂÖ•Áõ∏Â∫îÁöÑÂ±ûÊÄßË°®Âçï -->
                            </div>

                        </div>
                        
                        <div class="form-actions">
                            <button class="action-btn primary-btn" onclick="confirmNodeModification()">‰øùÂ≠ò‰øÆÊîπ</button>
                            <button class="action-btn cancel-btn" onclick="hideEditForms()">ÂèñÊ∂à</button>
                        </div>
                    </div>
                `;
                
                // ÂàùÂßãÂåñÂä®ÊÄÅÂ±ûÊÄßÊòæÁ§∫
                setTimeout(() => {
                    if (selectedItem.type === 'relationship') {
                        updateDynamicProperties('relationship');
                    } else {
                        updateDynamicProperties(currentType);
                    }
                }, 50);
            }
        }
        
        // Êõ¥Êñ∞ÈìæÊé•Ë°®ÂçïÂÜÖÂÆπ
        function updateLinkFormContent() {
            const editForms = document.querySelector('.edit-forms');
            
            if (recentSelectedNodes.length < 2) {
                // ÈÄâ‰∏≠ÁöÑËäÇÁÇπ‰∏çË∂≥‰∏§‰∏™
                editForms.innerHTML = `
                    <div class="edit-form">
                        <h4>ÈìæÊé•ËäÇÁÇπ</h4>
                        <div class="warning-text">
                            ËØ∑ÁÇπÂáªÈÄâÊã©‰∏§‰∏™‰∏çÂêåÁöÑËäÇÁÇπËøõË°åÈìæÊé•„ÄÇ<br>
                            ÂΩìÂâçÂ∑≤ÈÄâÊã© ${recentSelectedNodes.length} ‰∏™ËäÇÁÇπ„ÄÇ
                        </div>
                        ${recentSelectedNodes.length > 0 ? `
                            <div class="form-group">
                                <label>Â∑≤ÈÄâÊã©ÁöÑËäÇÁÇπÔºö</label>
                                <div style="padding: 8px; background: #f8f9fa; border-radius: 4px; margin-top: 5px;">
                                    <strong>ËäÇÁÇπ1Ôºö</strong>${recentSelectedNodes[0].data.label}<br>
                                    <strong>Á±ªÂûãÔºö</strong>${recentSelectedNodes[0].data.labels.join(", ")}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            } else {
                // Â∑≤ÈÄâÊã©‰∏§‰∏™È°πÁõÆÔºåÈ¶ñÂÖàÊ£ÄÊü•ÊòØÂê¶ÈÉΩÊòØËäÇÁÇπÁ±ªÂûã
                const item1 = recentSelectedNodes[1];
                const item2 = recentSelectedNodes[0];
                
                // Ê£ÄÊü•ÊòØÂê¶ÊúâÈùûËäÇÁÇπÁ±ªÂûãÁöÑÈ°πÁõÆ
                if (item1.type !== 'node' || item2.type !== 'node') {
                    // ÊúâÂÖ≥Á≥ªÊàñÂÖ∂‰ªñÁ±ªÂûãÔºå‰∏çÂÖÅËÆ∏ÈìæÊé•
                    const nonNodeItems = [];
                    if (item1.type !== 'node') nonNodeItems.push(`È°πÁõÆ1: ${item1.type === 'relationship' ? 'ÂÖ≥Á≥ª' : 'Êú™Áü•Á±ªÂûã'}`);
                    if (item2.type !== 'node') nonNodeItems.push(`È°πÁõÆ2: ${item2.type === 'relationship' ? 'ÂÖ≥Á≥ª' : 'Êú™Áü•Á±ªÂûã'}`);
                    
                    editForms.innerHTML = `
                        <div class="edit-form">
                            <h4>ÈìæÊé•ËäÇÁÇπ</h4>
                            <div class="form-group">
                                <label>ÂΩìÂâçÈÄâ‰∏≠ÁöÑÈ°πÁõÆÔºö</label>
                                <div style="padding: 8px; background: #f8f9fa; border-radius: 4px; margin-top: 5px;">
                                    <strong>È°πÁõÆ1Ôºö</strong>${item1.type === 'node' ? item1.data.label + ' (ËäÇÁÇπ)' : (item1.type === 'relationship' ? item1.data.type + ' (ÂÖ≥Á≥ª)' : 'Êú™Áü•Á±ªÂûã')}<br>
                                    <strong>È°πÁõÆ2Ôºö</strong>${item2.type === 'node' ? item2.data.label + ' (ËäÇÁÇπ)' : (item2.type === 'relationship' ? item2.data.type + ' (ÂÖ≥Á≥ª)' : 'Êú™Áü•Á±ªÂûã')}
                                </div>
                            </div>
                            <div style="padding: 15px; background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 6px; margin-bottom: 15px;">
                                <div style="display: flex; align-items: center; margin-bottom: 8px;">
                                    <span style="font-size: 18px; margin-right: 8px;">‚ö†Ô∏è</span>
                                    <span style="font-weight: 600; color: #721c24;">ËØ∑ÈÄâÊã©‰∏§‰∏™ËäÇÁÇπ</span>
                                </div>
                                <div style="color: #721c24; font-size: 14px; line-height: 1.4;">
                                    ÈìæÊé•ÂäüËÉΩÂè™ËÉΩÂú®‰∏§‰∏™ËäÇÁÇπ‰πãÈó¥ÂàõÂª∫ÂÖ≥Á≥ª„ÄÇ<br>
                                    ÂΩìÂâçÈÄâÊã©ÂåÖÂê´ÈùûËäÇÁÇπÁ±ªÂûãÈ°πÁõÆÔºö${nonNodeItems.join('„ÄÅ')}<br>
                                    ËØ∑ÈáçÊñ∞ÈÄâÊã©‰∏§‰∏™ËäÇÁÇπËøõË°åÈìæÊé•„ÄÇ
                                </div>
                            </div>
                            <div class="form-actions">
                                <button class="action-btn cancel-btn" onclick="clearRecentNodes()">ÈáçÊñ∞ÈÄâÊã©</button>
                            </div>
                        </div>
                    `;
                    return;
                }
                
                // ‰∏§‰∏™ÈÉΩÊòØËäÇÁÇπÔºåÁªßÁª≠Ê£ÄÊü•ÊòØÂê¶ÈÉΩÊòØÊó∂Èó¥ËäÇÁÇπ
                const node1 = item1.data;
                const node2 = item2.data;
                
                const isNode1Time = node1.labels && node1.labels.includes('Time');
                const isNode2Time = node2.labels && node2.labels.includes('Time');
                
                if (isNode1Time && isNode2Time) {
                    // ‰∏§‰∏™ËäÇÁÇπÈÉΩÊòØÊó∂Èó¥ËäÇÁÇπÔºå‰∏çÂÖÅËÆ∏ÈìæÊé•
                    editForms.innerHTML = `
                        <div class="edit-form">
                            <h4>ÈìæÊé•ËäÇÁÇπ</h4>
                            <div class="form-group">
                                <label>ÈÄâ‰∏≠ÁöÑËäÇÁÇπÔºö</label>
                                <div style="padding: 8px; background: #f8f9fa; border-radius: 4px; margin-top: 5px;">
                                    <strong>ËäÇÁÇπ1Ôºö</strong>${node1.label} (${node1.labels.join(", ")})<br>
                                    <strong>ËäÇÁÇπ2Ôºö</strong>${node2.label} (${node2.labels.join(", ")})
                                </div>
                            </div>
                            <div style="padding: 15px; background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 6px; margin-bottom: 15px;">
                                <div style="display: flex; align-items: center; margin-bottom: 8px;">
                                    <span style="font-size: 18px; margin-right: 8px;">‚ö†Ô∏è</span>
                                    <span style="font-weight: 600; color: #721c24;">‰∏çÊîØÊåÅÈìæÊé•‰∏§‰∏™Êó∂Èó¥ËäÇÁÇπ</span>
                                </div>
                                <div style="color: #721c24; font-size: 14px; line-height: 1.4;">
                                    Êó∂Èó¥ËäÇÁÇπ‰πãÈó¥ÁöÑÂÖ≥Á≥ªÁî±Á≥ªÁªüËá™Âä®Áª¥Êä§Ôºå‰∏çÊîØÊåÅÊâãÂä®ÂàõÂª∫ÈìæÊé•„ÄÇ<br>
                                    ËØ∑ÈÄâÊã©Ëá≥Â∞ë‰∏Ä‰∏™ÈùûÊó∂Èó¥Á±ªÂûãÁöÑËäÇÁÇπËøõË°åÈìæÊé•„ÄÇ
                                </div>
                            </div>
                            <div class="form-actions">
                                <button class="action-btn cancel-btn" onclick="clearRecentNodes()">ÈáçÊñ∞ÈÄâÊã©</button>
                            </div>
                        </div>
                    `;
                } else {
                    // Ê£ÄÊü•ÊòØÂê¶ÊúâÊó∂Èó¥ËäÇÁÇπÔºåÂ¶ÇÊûúÊúâÂàôËá™Âä®ËÆæÁΩÆÂÖ≥Á≥ª
                    let defaultPredicate = "";
                    let defaultDirection = "to_endNode";
                    let isTimeRelation = false;
                    let timeNodeLabel = "";
                    let nonTimeNodeLabel = "";
                    
                    if (node1.labels.includes('Time') && node2.labels.includes('Entity')) {
                        // ËäÇÁÇπ1ÊòØÊó∂Èó¥ËäÇÁÇπÔºåËäÇÁÇπ2‰∏çÊòØ
                        defaultPredicate = "HAPPENED_AT";
                        defaultDirection = "to_startNode"; // ËäÇÁÇπ2 ‚Üí ËäÇÁÇπ1ÔºàÊó∂Èó¥ËäÇÁÇπÔºâ
                        isTimeRelation = true;
                        timeNodeLabel = node1.label;
                        nonTimeNodeLabel = node2.label;
                    } else if (node1.labels.includes('Entity') && node2.labels.includes('Time')) {
                        // ËäÇÁÇπ2ÊòØÊó∂Èó¥ËäÇÁÇπÔºåËäÇÁÇπ1‰∏çÊòØ
                        defaultPredicate = "HAPPENED_AT";
                        defaultDirection = "to_endNode"; // ËäÇÁÇπ1 ‚Üí ËäÇÁÇπ2ÔºàÊó∂Èó¥ËäÇÁÇπÔºâ
                        isTimeRelation = true;
                        timeNodeLabel = node2.label;
                        nonTimeNodeLabel = node1.label;
                    } else if (node1.labels.includes('Location') && node2.labels.includes('Entity')) {
                        // ËäÇÁÇπ1ÊòØÊó∂Èó¥ËäÇÁÇπÔºåËäÇÁÇπ2ÊòØËßíËâ≤ËäÇÁÇπ
                        defaultPredicate = "HAPPENED_IN";
                        defaultDirection = "to_startNode"; // ËäÇÁÇπ2 ‚Üí ËäÇÁÇπ1ÔºàÊó∂Èó¥ËäÇÁÇπÔºâ
                        isTimeRelation = true;
                        timeNodeLabel = node1.label;
                        nonTimeNodeLabel = node2.label;
                    } else if (node1.labels.includes('Entity') && node2.labels.includes('Location')) {
                        // ËäÇÁÇπ2ÊòØÊó∂Èó¥ËäÇÁÇπÔºåËäÇÁÇπ1ÊòØËßíËâ≤ËäÇÁÇπ
                        defaultPredicate = "HAPPENED_IN";
                        defaultDirection = "to_endNode"; // ËäÇÁÇπ1 ‚Üí ËäÇÁÇπ2ÔºàÊó∂Èó¥ËäÇÁÇπÔºâ
                        isTimeRelation = true;
                        timeNodeLabel = node2.label;
                        nonTimeNodeLabel = node1.label;
                    }
                    
                    // ÂèØ‰ª•ËøõË°åÈìæÊé•ÔºåÊòæÁ§∫ÈìæÊé•Ë°®Âçï
                    let directionOptions = '';
                    let predicateField = '';
                    
                    if (isTimeRelation) {
                        // Êó∂Èó¥ÂÖ≥Á≥ªÁöÑÁâπÊÆäÂ§ÑÁêÜ
                        directionOptions = `
                            <option value="to_endNode" ${defaultDirection === 'to_endNode' ? 'selected' : ''}>${node1.label} ‚Üí ${node2.label}</option>
                            <option value="to_startNode" ${defaultDirection === 'to_startNode' ? 'selected' : ''}>${node2.label} ‚Üí ${node1.label}</option>
                            <option value="bidirectional">ÂèåÂêëÂÖ≥Á≥ª</option>
                        `;
                        predicateField = `
                            <input type="text" id="link-predicate" value="${defaultPredicate}" placeholder="ÈªòËÆ§ÔºöHAPPENED_AT" required>
                            <small style="color: #6c757d; font-style: italic;">ÈªòËÆ§‰∏∫ HAPPENED_ATÔºåÂèØËá™ÂÆö‰πâÂÖ∂‰ªñÂÖ≥Á≥ªÁ±ªÂûã</small>
                        `;
                    } else {
                        // ÊôÆÈÄöÂÖ≥Á≥ª
                        directionOptions = `
                            <option value="to_endNode">${node1.label} ‚Üí ${node2.label}</option>
                            <option value="to_startNode">${node2.label} ‚Üí ${node1.label}</option>
                            <option value="bidirectional">ÂèåÂêëÂÖ≥Á≥ª</option>
                        `;
                        predicateField = `
                            <input type="text" id="link-predicate" placeholder="‰æãÂ¶ÇÔºöËÆ§ËØÜ„ÄÅÊúãÂèã„ÄÅÂêå‰∫ãÁ≠â" required>
                        `;
                    }
                    
                    editForms.innerHTML = `
                        <div class="edit-form">
                            <h4>ÈìæÊé•ËäÇÁÇπ</h4>
                            <div class="form-group">
                                <label>Âç≥Â∞ÜÈìæÊé•ÁöÑËäÇÁÇπÔºö</label>
                                <div style="padding: 8px; background: #f8f9fa; border-radius: 4px; margin-top: 5px;">
                                    <strong>ËäÇÁÇπ1Ôºö</strong>${node1.label} (${node1.labels.join(", ")})<br>
                                    <strong>ËäÇÁÇπ2Ôºö</strong>${node2.label} (${node2.labels.join(", ")})
                                </div>
                                ${isTimeRelation ? `
                                    <div style="padding: 8px; background: #d4edda; border: 1px solid #c3e6cb; border-radius: 4px; margin-top: 8px;">
                                        <small style="color: #155724;">
                                            <strong>Ëá™Âä®Ê£ÄÊµãÔºö</strong>Êó∂Èó¥ÂÖ≥Á≥ªÔºåÂ∑≤È¢ÑÂ°´ÈªòËÆ§ÂÄºÔºåÂèØÊ†πÊçÆÈúÄË¶ÅËá™ÂÆö‰πâ
                                        </small>
                                    </div>
                                ` : ''}
                            </div>
                            <div class="form-group">
                                <label for="link-predicate">ÂÖ≥Á≥ªÁ±ªÂûãÔºö</label>
                                ${predicateField}
                            </div>
                            <div class="form-group">
                                <label for="link-confidence">ÁΩÆ‰ø°Â∫¶Ôºö</label>
                                <input type="number" id="link-confidence" min="0" max="1" step="0.1" value="0.75" required>
                            </div>
                            <div class="form-group">
                                <label for="link-evidence">ÂÖ≥Á≥ªËØÅÊçÆÔºö</label>
                                <textarea id="link-evidence" style="min-height: 60px; resize: vertical;" placeholder="ËØ∑ËæìÂÖ•ÂÖ≥Á≥ªËØÅÊçÆÔºà‰∏∫‰ªÄ‰πàËÆæÁΩÆËøô‰∏™ÁΩÆ‰ø°Â∫¶Ôºâ">user manual input</textarea>
                            </div>
                            <div class="form-group">
                                <label for="link-direction">ÂÖ≥Á≥ªÊñπÂêëÔºö</label>
                                <select id="link-direction" required>
                                    ${directionOptions}
                                </select>
                                ${isTimeRelation ? '<small style="color: #6c757d; font-style: italic;">ÈªòËÆ§ÊñπÂêëÊåáÂêëÊó∂Èó¥ËäÇÁÇπÔºå‰∏çÂª∫ËÆÆË∞ÉÊï¥</small>' : ''}
                            </div>
                            <div class="form-actions">
                                <button class="action-btn primary-btn" onclick="confirmLink()">Á°ÆËÆ§ÈìæÊé•</button>
                                <button class="action-btn cancel-btn" onclick="clearRecentNodes()">ÈáçÊñ∞ÈÄâÊã©</button>
                            </div>
                        </div>
                    `;
                }
            }
        }
        
        // Ê∏ÖÁ©∫ÊúÄËøëÈÄâÊã©ÁöÑËäÇÁÇπ
        function clearRecentNodes() {
            recentSelectedNodes = [];
            // Êõ¥Êñ∞ÊâÄÊúâÂèØËÉΩÊâìÂºÄÁöÑÁïåÈù¢
            updateLinkFormContent();
            updateDeleteFormContent();
            updateModifyFormContent();
            
            // Êõ¥Êñ∞Ê†∑ÂºèÔºàÊ∏ÖÈô§Âà†Èô§Ê®°ÂºèÁöÑÁ∫¢Ëâ≤ÊèèËæπÔºâ
            updateSelectedItemsStyle();
        }
        
        function showDeleteNodeForm() {
            hideEditForms();
            
            // ÂêØÁî®Âà†Èô§Ê®°Âºè
            deleteMode = true;
            
            // Êõ¥Êñ∞Âà†Èô§Ë°®ÂçïÂÜÖÂÆπ
            updateDeleteFormContent();
            
            // ËÆæÁΩÆÊåâÈíÆÁä∂ÊÄÅ
            resetButtonStates();
            document.querySelector('.delete-node-btn').classList.add('active');
            
            // Êõ¥Êñ∞ÊâÄÊúâÈÄâ‰∏≠È°πÁõÆÁöÑÊ†∑Âºè
            updateSelectedItemsStyle();
        }
        
        function showQuintupleForm() {
            hideEditForms();
            
            // ÂàõÂª∫‰∫îÂÖÉÁªÑËæìÂÖ•Ë°®Âçï
            const editForms = document.querySelector('.edit-forms');
            editForms.innerHTML = `
                <div class="edit-form">
                    <h4>ÂàõÂª∫‰∫îÂÖÉÁªÑ</h4>
                    <div class="form-group">
                        <label>‰∏ª‰ΩìÔºàSubjectÔºâÔºö</label>
                        <input type="text" id="quintuple-subject" placeholder="ËØ∑ËæìÂÖ•‰∏ª‰Ωì" required>
                    </div>
                    <div class="form-group">
                        <label>Âä®‰ΩúÔºàActionÔºâÔºö</label>
                        <input type="text" id="quintuple-action" placeholder="ËØ∑ËæìÂÖ•Âä®‰Ωú" required>
                    </div>
                    <div class="form-group">
                        <label>ÂÆ¢‰ΩìÔºàObjectÔºâÔºö</label>
                        <input type="text" id="quintuple-object" placeholder="ËØ∑ËæìÂÖ•ÂÆ¢‰Ωì" required>
                    </div>
                    <div class="form-group">
                        <label>Êó∂Èó¥ÔºàTimeÔºâÔºö</label>
                        <input type="text" id="quintuple-time" placeholder="ËØ∑ËæìÂÖ•Êó∂Èó¥ÔºàÂèØÈÄâÔºâ">
                    </div>
                    <div class="form-group">
                        <label>Âú∞ÁÇπÔºàLocationÔºâÔºö</label>
                        <input type="text" id="quintuple-location" placeholder="ËØ∑ËæìÂÖ•Âú∞ÁÇπÔºàÂèØÈÄâÔºâ">
                    </div>
                    <div class="form-actions">
                        <button class="action-btn primary-btn" onclick="confirmQuintuple()">Á°ÆËÆ§ÂàõÂª∫</button>
                        <button class="action-btn cancel-btn" onclick="hideEditForms()">ÂèñÊ∂à</button>
                    </div>
                </div>
            `;
            
            // ËÆæÁΩÆÊåâÈíÆÁä∂ÊÄÅ
            resetButtonStates();
            document.querySelector('.quintuple-btn').classList.add('active');
        }
        
        function confirmQuintuple() {
            // TODO: ‰∫îÂÖÉÁªÑÂàõÂª∫ÈÄªËæëÔºåÊöÇÊú™ÂÆûË£Ö
            alert('‰∫îÂÖÉÁªÑÂäüËÉΩÊ≠£Âú®ÂºÄÂèë‰∏≠ÔºåÊï¨ËØ∑ÊúüÂæÖÔºÅ');
        }
        
        function hideEditForms() {
            // Ê∏ÖÁ©∫ÂäüËÉΩË°®ÂçïÂå∫Âüü
            const editForms = document.querySelector('.edit-forms');
            editForms.innerHTML = '';
            resetButtonStates();
            
            // Á¶ÅÁî®Âà†Èô§Ê®°Âºè
            deleteMode = false;
            
            // ÊÅ¢Â§çÊâÄÊúâÈÄâ‰∏≠È°πÁõÆÁöÑÊ≠£Â∏∏Ê†∑Âºè
            updateSelectedItemsStyle();
            
            // Â¶ÇÊûúÊ≠£Âú®ÂàõÂª∫ËäÇÁÇπÔºåÂèñÊ∂àÂàõÂª∫
            if (isCreatingNode) {
                cleanupNodeCreation();
            }
        }
        
        // Á°ÆËÆ§Âà†Èô§ÂáΩÊï∞
        async function confirmDelete() {
            if (recentSelectedNodes.length === 0) {
                alert('ËØ∑ÂÖàÈÄâÊã©Ë¶ÅÂà†Èô§ÁöÑËäÇÁÇπÊàñÂÖ≥Á≥ª');
                return;
            }
            
            // ËÆ°ÁÆóÂ∞ÜË¶ÅÂà†Èô§ÁöÑÊâÄÊúâÂÜÖÂÆπ
            let totalNodeCount = 0;
            let totalRelationshipCount = 0;
            let itemDescriptions = [];
            
            recentSelectedNodes.forEach((item, index) => {
                if (item.type === 'node') {
                    totalNodeCount += 1;
                    const relatedCount = graphData.links.filter(link => 
                        link.source.id === item.data.id || link.target.id === item.data.id
                    ).length;
                    totalRelationshipCount += relatedCount;
                    itemDescriptions.push(`ËäÇÁÇπ"${item.data.label}"ÔºàÂåÖÂê´${relatedCount}‰∏™ÂÖ≥Á≥ªÔºâ`);
                } else if (item.type === 'relationship') {
                    totalRelationshipCount += 1;
                    const sourceNode = graphData.nodes.find(node => node.id === item.data.source.id);
                    const targetNode = graphData.nodes.find(node => node.id === item.data.target.id);
                    itemDescriptions.push(`ÂÖ≥Á≥ª"${item.data.type}" (‰ªé"${sourceNode ? sourceNode.label : 'Unknown'}"Âà∞"${targetNode ? targetNode.label : 'Unknown'}")`);
                }
            });
            
            // ÊûÑÂª∫Á°ÆËÆ§Âà†Èô§Ê∂àÊÅØ
            let confirmMessage = `Á°ÆËÆ§Âà†Èô§‰ª•‰∏ã${recentSelectedNodes.length}‰∏™È°πÁõÆÔºü\n\n`;
            confirmMessage += `Âà†Èô§ÂàóË°®Ôºö\n`;
            itemDescriptions.forEach((desc, index) => {
                confirmMessage += `${index + 1}. ${desc}\n`;
            });
            confirmMessage += `\nÊ≠§Êìç‰ΩúÂ∞ÜÊÄªÂÖ±Âà†Èô§Ôºö\n`;
            if (totalNodeCount > 0) {
                confirmMessage += `‚Ä¢ ${totalNodeCount} ‰∏™ËäÇÁÇπ\n`;
            }
            if (totalRelationshipCount > 0) {
                confirmMessage += `‚Ä¢ ${totalRelationshipCount} ‰∏™ÂÖ≥Á≥ª\n`;
            }
            confirmMessage += `\nÊ≠§Êìç‰Ωú‰∏çÂèØÊí§ÈîÄÔºåÁ°ÆÂÆöË¶ÅÁªßÁª≠ÂêóÔºü`;
            
            // ËøõË°åÂà†Èô§Á°ÆËÆ§
            if (!confirm(confirmMessage)) {
                return;
            }
            
            try {
                // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
                const confirmBtn = document.querySelector('.danger-btn');
                const originalText = confirmBtn.textContent;
                confirmBtn.textContent = 'Âà†Èô§‰∏≠...';
                confirmBtn.disabled = true;
                
                // ÊåâÁ±ªÂûãÂàÜÁªÑÂà†Èô§È°πÁõÆ
                const nodesToDelete = recentSelectedNodes.filter(item => item.type === 'node');
                const relationshipsToDelete = recentSelectedNodes.filter(item => item.type === 'relationship');
                
                let deleteResults = [];
                
                // Âà†Èô§ËäÇÁÇπ
                for (const nodeItem of nodesToDelete) {
                    try {
                        const response = await fetch('/api/delete_item', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                element_id: nodeItem.data.neo4j_id
                            })
                        });
                        
                        const result = await response.json();
                        deleteResults.push({
                            type: 'node',
                            name: nodeItem.data.label,
                            success: result.success,
                            error: result.error
                        });
                    } catch (error) {
                        deleteResults.push({
                            type: 'node',
                            name: nodeItem.data.label,
                            success: false,
                            error: error.message
                        });
                    }
                }
                
                // Âà†Èô§ÂÖ≥Á≥ª
                for (const relationshipItem of relationshipsToDelete) {
                    try {
                        const response = await fetch('/api/delete_item', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                element_id: relationshipItem.data.neo4j_id
                            })
                        });
                        
                        const result = await response.json();
                        deleteResults.push({
                            type: 'relationship',
                            name: relationshipItem.data.type,
                            success: result.success,
                            error: result.error
                        });
                    } catch (error) {
                        deleteResults.push({
                            type: 'relationship',
                            name: relationshipItem.data.type,
                            success: false,
                            error: error.message
                        });
                    }
                }
                
                // ÁªüËÆ°ÁªìÊûú
                const successCount = deleteResults.filter(r => r.success).length;
                const failCount = deleteResults.filter(r => !r.success).length;
                
                if (successCount > 0) {
                    // Ê∏ÖÁ©∫ÊúÄËøëÈÄâÊã©ÁöÑÈ°πÁõÆ
                    recentSelectedNodes = [];
                    // ÈöêËóèÁºñËæëË°®Âçï
                    hideEditForms();
                    // ÈöêËóèËØ¶ÊÉÖÈù¢Êùø
                    document.getElementById("node-details").style.display = "none";
                    
                    // ‰ΩøÁî®Âä®ÊÄÅÊõ¥Êñ∞‰ª£ÊõøÈ°µÈù¢Âà∑Êñ∞
                    const updateSuccess = await updateGraphData();
                    
                    let resultMessage = `ÊâπÈáèÂà†Èô§ÂÆåÊàêÔºÅ\n\n`;
                    resultMessage += `ÊàêÂäüÂà†Èô§Ôºö${successCount} ‰∏™È°πÁõÆ\n`;
                    if (failCount > 0) {
                        resultMessage += `Âà†Èô§Â§±Ë¥•Ôºö${failCount} ‰∏™È°πÁõÆ\n\nÂ§±Ë¥•È°πÁõÆÔºö\n`;
                        deleteResults.filter(r => !r.success).forEach(r => {
                            resultMessage += `- ${r.type === 'node' ? 'ËäÇÁÇπ' : 'ÂÖ≥Á≥ª'} "${r.name}": ${r.error}\n`;
                        });
                    }
                    
                    if (updateSuccess) {
                        resultMessage += `\nÂõæË∞±Â∑≤Ëá™Âä®Êõ¥Êñ∞ÊòæÁ§∫ÊúÄÊñ∞Êï∞ÊçÆ„ÄÇ`;
                    } else {
                        resultMessage += `\nÂõæË∞±Êï∞ÊçÆÊõ¥Êñ∞Â§±Ë¥•ÔºåËØ∑ÊâãÂä®Âà∑Êñ∞È°µÈù¢„ÄÇ`;
                    }
                    
                    alert(resultMessage);
                } else {
                    let errorMessage = `ÊâÄÊúâÈ°πÁõÆÂà†Èô§Â§±Ë¥•Ôºö\n\n`;
                    deleteResults.forEach(r => {
                        errorMessage += `- ${r.type === 'node' ? 'ËäÇÁÇπ' : 'ÂÖ≥Á≥ª'} "${r.name}": ${r.error || 'Êú™Áü•ÈîôËØØ'}\n`;
                    });
                    alert(errorMessage);
                }
                
            } catch (error) {
                console.error('ÊâπÈáèÂà†Èô§Êìç‰ΩúÂ§±Ë¥•:', error);
                alert(`ÊâπÈáèÂà†Èô§Êìç‰ΩúÂ§±Ë¥•Ôºö${error.message}`);
            } finally {
                // ÊÅ¢Â§çÊåâÈíÆÁä∂ÊÄÅ
                const confirmBtn = document.querySelector('.danger-btn');
                if (confirmBtn) {
                    confirmBtn.textContent = originalText;
                    confirmBtn.disabled = false;
                }
            }
        }
        
        // Âú®ÁºñËæëÁïåÈù¢‰∏≠ÈÄâÊã©ËäÇÁÇπÁ±ªÂûã
        function selectNodeTypeInEdit(nodeType) {
            // Êõ¥Êñ∞ÈöêËóèÁöÑËæìÂÖ•Ê°Ü
            document.getElementById('edit-node-type').value = nodeType;
            
            // Êõ¥Êñ∞ÊåâÈíÆÊ†∑Âºè
            const entityBtn = document.getElementById('btn-entity');
            const characterBtn = document.getElementById('btn-character');
            const locationBtn = document.getElementById('btn-location');
            
            // ÈáçÁΩÆÊâÄÊúâÊåâÈíÆÊ†∑Âºè
            const buttons = [entityBtn, characterBtn, locationBtn];
            buttons.forEach(btn => {
                if (btn) {
                    btn.style.background = '#fff';
                    btn.style.color = '#495057';
                }
            });
            
            // ËÆæÁΩÆÈÄâ‰∏≠ÊåâÈíÆÊ†∑Âºè
            if (nodeType === 'Entity' && entityBtn) {
                entityBtn.style.background = '#007bff';
                entityBtn.style.color = '#fff';
            } else if (nodeType === 'Character' && characterBtn) {
                characterBtn.style.background = '#007bff';
                characterBtn.style.color = '#fff';
            } else if (nodeType === 'Location' && locationBtn) {
                locationBtn.style.background = '#007bff';
                locationBtn.style.color = '#fff';
            }
            
            // Êõ¥Êñ∞Âä®ÊÄÅÂ±ûÊÄßÊòæÁ§∫
            updateDynamicProperties(nodeType);
        }
        
        // Êõ¥Êñ∞Âä®ÊÄÅÂ±ûÊÄßÊòæÁ§∫Âå∫Âüü
        function updateDynamicProperties(nodeType) {
            const container = document.getElementById('dynamic-properties-container');
            const selectedItem = recentSelectedNodes[0];
            if (!container || !selectedItem) {
                return;
            }
            
            const item = selectedItem.data;
            let propertiesHtml = '';
            
            if (nodeType === 'Entity') {
                // Ëé∑ÂèñÂÆû‰ΩìÁöÑÂΩìÂâçÂÄºÔºåÁ°Æ‰øùÂÆâÂÖ®ËΩ¨‰πâ
                const entityName = (item.properties.name || item.label || '').replace(/"/g, '&quot;');
                const entityImportance = (item.properties.importance || item.properties['ÂÆû‰ΩìÈáçË¶ÅÊÄß'] || '').toString().replace(/"/g, '&quot;');
                const entityDescription = (item.properties.note || item.properties['ÂÆû‰ΩìÊèèËø∞'] || item.properties.description || 'Êó†').replace(/"/g, '&quot;');
                const entityContext = (item.properties.context || 'realityÁé∞ÂÆû').replace(/"/g, '&quot;');
                
                propertiesHtml = `
                    <label style="font-weight: 600; color: #495057; margin-bottom: 8px; display: block;">ÂÆû‰ΩìÂ±ûÊÄß:</label>
                    <div style="border: 1px solid #e0e0e0; border-radius: 6px; padding: 12px; margin-bottom: 15px;">
                        <div class="form-group" style="margin-bottom: 12px;">
                            <label for="edit-entity-name" style="font-weight: 600; color: #0c5460; margin-bottom: 4px; display: block;">ÂÆû‰ΩìÂêçÁß∞Ôºö</label>
                            <input type="text" id="edit-entity-name" value="${entityName}" style="width: 100%; padding: 6px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;" placeholder="ËØ∑ËæìÂÖ•ÂÆû‰ΩìÂêçÁß∞">
                        </div>
                        <div class="form-group" style="margin-bottom: 12px;">
                            <label for="edit-entity-importance" style="font-weight: 600; color: #0c5460; margin-bottom: 4px; display: block;">ÂÆû‰ΩìÈáçË¶ÅÊÄßÔºö</label>
                            <input type="text" id="edit-entity-importance" value="${entityImportance}" style="width: 100%; padding: 6px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;" placeholder="ÂèñÂÄºËåÉÂõ¥0-1ÔºàÈªòËÆ§0.75Ôºâ">
                        </div>
                        <div class="form-group" style="margin-bottom: 12px;">
                            <label for="edit-entity-context" style="font-weight: 600; color: #0c5460; margin-bottom: 4px; display: block;">‰∏ä‰∏ãÊñáÔºö</label>
                            <input type="text" id="edit-entity-context" value="${entityContext}" style="width: 100%; padding: 6px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;" placeholder="ÂÆû‰ΩìÊâÄÂ±û‰∏ä‰∏ãÊñáÔºàÈªòËÆ§realityÁé∞ÂÆûÔºâ">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="edit-entity-description" style="font-weight: 600; color: #0c5460; margin-bottom: 4px; display: block;">ÂÆû‰ΩìÊèèËø∞Ôºö</label>
                            <textarea id="edit-entity-description" style="width: 100%; padding: 6px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; resize: vertical;" rows="3" placeholder="Â§áÊ≥®‰ø°ÊÅØÔºàÈÄâÂ°´Ôºâ">${entityDescription}</textarea>
                        </div>
                    </div>
                `;
            } else if (nodeType === 'Character') {
                // Ëé∑ÂèñËßíËâ≤ÁöÑÂΩìÂâçÂÄºÔºåÁ°Æ‰øùÂÆâÂÖ®ËΩ¨‰πâ
                const characterName = (item.properties.name || item.label || '').replace(/"/g, '&quot;');
                const characterTrust = (item.properties.trust || item.properties['ËßíËâ≤ÁΩÆ‰ø°Â∫¶'] || '').toString().replace(/"/g, '&quot;');
                const characterImportance = (item.properties.importance || item.properties['ËßíËâ≤ÈáçË¶ÅÊÄß'] || '').toString().replace(/"/g, '&quot;');
                const characterContext = (item.properties.context || 'realityÁé∞ÂÆû').replace(/"/g, '&quot;');
                
                propertiesHtml = `
                    <label style="font-weight: 600; color: #495057; margin-bottom: 8px; display: block;">ËßíËâ≤Â±ûÊÄß:</label>
                    <div style="border: 1px solid #e0e0e0; border-radius: 6px; padding: 12px; margin-bottom: 15px;">
                        <div class="form-group" style="margin-bottom: 12px;">
                            <label for="edit-character-name" style="font-weight: 600; color: #0c5460; margin-bottom: 4px; display: block;">ËßíËâ≤ÂêçÁß∞Ôºö</label>
                            <input type="text" id="edit-character-name" value="${characterName}" style="width: 100%; padding: 6px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;" placeholder="ËØ∑ËæìÂÖ•ËßíËâ≤ÂêçÁß∞">
                        </div>
                        <div class="form-group" style="margin-bottom: 12px;">
                            <label for="edit-character-trust" style="font-weight: 600; color: #0c5460; margin-bottom: 4px; display: block;">ËßíËâ≤ÁΩÆ‰ø°Â∫¶Ôºö</label>
                            <input type="text" id="edit-character-trust" value="${characterTrust}" style="width: 100%; padding: 6px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;" placeholder="ÂèñÂÄºËåÉÂõ¥0-1ÔºàÈªòËÆ§0.75Ôºâ">
                        </div>
                        <div class="form-group" style="margin-bottom: 12px;">
                            <label for="edit-character-importance" style="font-weight: 600; color: #0c5460; margin-bottom: 4px; display: block;">ËßíËâ≤ÈáçË¶ÅÊÄßÔºö</label>
                            <input type="text" id="edit-character-importance" value="${characterImportance}" style="width: 100%; padding: 6px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;" placeholder="ÂèñÂÄºËåÉÂõ¥0-1ÔºàÈªòËÆ§0.75Ôºâ">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="edit-character-context" style="font-weight: 600; color: #0c5460; margin-bottom: 4px; display: block;">‰∏ä‰∏ãÊñáÔºö</label>
                            <input type="text" id="edit-character-context" value="${characterContext}" style="width: 100%; padding: 6px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;" placeholder="ËßíËâ≤ÊâÄÂ±û‰∏ä‰∏ãÊñáÔºàÈªòËÆ§realityÁé∞ÂÆûÔºâ">
                        </div>
                    </div>
                `;
            } else if (nodeType === 'Location') {
                // Ëé∑ÂèñÂú∞ÁÇπÁöÑÂΩìÂâçÂÄºÔºåÁ°Æ‰øùÂÆâÂÖ®ËΩ¨‰πâ
                const locationName = (item.properties.name || item.label || '').replace(/"/g, '&quot;');
                const locationContext = (item.properties.context || 'realityÁé∞ÂÆû').replace(/"/g, '&quot;');
                
                propertiesHtml = `
                    <label style="font-weight: 600; color: #495057; margin-bottom: 8px; display: block;">Âú∞ÁÇπÂ±ûÊÄß:</label>
                    <div style="border: 1px solid #e0e0e0; border-radius: 6px; padding: 12px; margin-bottom: 15px;">
                        <div class="form-group" style="margin-bottom: 12px;">
                            <label for="edit-location-name" style="font-weight: 600; color: #0c5460; margin-bottom: 4px; display: block;">Âú∞ÁÇπÂêçÁß∞Ôºö</label>
                            <input type="text" id="edit-location-name" value="${locationName}" style="width: 100%; padding: 6px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;" placeholder="ËØ∑ËæìÂÖ•Âú∞ÁÇπÂêçÁß∞">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="edit-location-context" style="font-weight: 600; color: #0c5460; margin-bottom: 4px; display: block;">‰∏ä‰∏ãÊñáÔºö</label>
                            <input type="text" id="edit-location-context" value="${locationContext}" style="width: 100%; padding: 6px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;" placeholder="Âú∞ÁÇπÊâÄÂ±û‰∏ä‰∏ãÊñáÔºàÈªòËÆ§realityÁé∞ÂÆûÔºâ">
                        </div>
                    </div>
                `;
            } else if (nodeType === 'relationship' && selectedItem && selectedItem.type === 'relationship') {
                // Â§ÑÁêÜÂÖ≥Á≥ªÁ±ªÂûã
                const item = selectedItem.data;
                
                // Ëé∑ÂèñËµ∑ÂßãÂíåÁõÆÊ†áËäÇÁÇπ‰ø°ÊÅØ
                const sourceNode = graphData.nodes.find(node => node.id === item.source.id);
                const targetNode = graphData.nodes.find(node => node.id === item.target.id);
                
                {
                    // Ê≠£Â∏∏ÁöÑÂÖ≥Á≥ªÁºñËæë
                    // Ëé∑ÂèñÂÖ≥Á≥ªÁöÑÂΩìÂâçÂÄºÔºåÁ°Æ‰øùÂÆâÂÖ®ËΩ¨‰πâ
                    const relationshipName = (item.type || '').replace(/"/g, '&quot;');
                    const relationshipConfidence = (item.properties && (item.properties.confidence || item.properties.weight)) ? 
                        (item.properties.confidence || item.properties.weight).toString().replace(/"/g, '&quot;') : '0.75';
                    const relationshipSource = (item.properties && item.properties.source) ? 
                        item.properties.source.toString().replace(/"/g, '&quot;') : '';
                    const relationshipEvidence = (item.properties && item.properties.evidence) ? 
                        item.properties.evidence.toString().replace(/"/g, '&quot;') : '';
                    
                    propertiesHtml = `
                        <label style="font-weight: 600; color: #495057; margin-bottom: 8px; display: block;">ÂÖ≥Á≥ªÂ±ûÊÄß:</label>
                        <div style="border: 1px solid #e0e0e0; border-radius: 6px; padding: 12px; margin-bottom: 15px;">
                            <div class="form-group" style="margin-bottom: 12px;">
                                <label for="edit-relationship-name" style="font-weight: 600; color: #0c5460; margin-bottom: 4px; display: block;">ÂÖ≥Á≥ªÂêçÁß∞Ôºö</label>
                                <input type="text" id="edit-relationship-name" value="${relationshipName}" style="width: 100%; padding: 6px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;" placeholder="ËØ∑ËæìÂÖ•ÂÖ≥Á≥ªÂêçÁß∞">
                            </div>
                            <div class="form-group" style="margin-bottom: 12px;">
                                <label for="edit-relationship-confidence" style="font-weight: 600; color: #0c5460; margin-bottom: 4px; display: block;">ÁΩÆ‰ø°Â∫¶Ôºö</label>
                                <input type="number" id="edit-relationship-confidence" value="${relationshipConfidence}" min="0" max="1" step="0.1" style="width: 100%; padding: 6px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;" placeholder="ÂèñÂÄºËåÉÂõ¥0-1ÔºàÈªòËÆ§0.75Ôºâ">
                            </div>
                            <div class="form-group" style="margin-bottom: 12px;">
                                <label for="edit-relationship-source" style="font-weight: 600; color: #0c5460; margin-bottom: 4px; display: block;">ÂÖ≥Á≥ªÊù•Ê∫êÔºö</label>
                                <input type="text" id="edit-relationship-source" value="${relationshipSource}" style="width: 100%; padding: 6px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;" placeholder="ËØ∑ËæìÂÖ•ÂÖ≥Á≥ªÊù•Ê∫êÔºàÈªòËÆ§manual_inputÔºâ">
                            </div>
                            <div class="form-group" style="margin-bottom: 12px;">
                                <label for="edit-relationship-evidence" style="font-weight: 600; color: #0c5460; margin-bottom: 4px; display: block;">ÂÖ≥Á≥ªËØÅÊçÆÔºö</label>
                                <textarea id="edit-relationship-evidence" style="width: 100%; padding: 6px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; min-height: 60px; resize: vertical;" placeholder="ËØ∑ËæìÂÖ•ÂÖ≥Á≥ªËØÅÊçÆÔºà‰∏∫‰ªÄ‰πàËÆæÁΩÆËøô‰∏™ÁΩÆ‰ø°Â∫¶Ôºâ">${relationshipEvidence}</textarea>
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label for="edit-relationship-direction" style="font-weight: 600; color: #0c5460; margin-bottom: 4px; display: block;">ÂÖ≥Á≥ªÊñπÂêëÔºö</label>
                                <select id="edit-relationship-direction" style="width: 100%; padding: 6px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                                    <option value="to_endNode">${sourceNode ? sourceNode.label : 'Unknown'} ‚Üí ${targetNode ? targetNode.label : 'Unknown'}</option>
                                    <option value="to_startNode">${targetNode ? targetNode.label : 'Unknown'} ‚Üí ${sourceNode ? sourceNode.label : 'Unknown'}</option>
                                    <option value="bidirectional">ÂèåÂêëÂÖ≥Á≥ª</option>
                                </select>
                            </div>
                        </div>
                    `;
                }
            }
            
            container.innerHTML = propertiesHtml;
        }
        
        // Á°ÆËÆ§ËäÇÁÇπ‰øÆÊîπÂáΩÊï∞
        async function confirmNodeModification() {
            const selectedItem = recentSelectedNodes[0];
            if (!selectedItem || (selectedItem.type !== 'node' && selectedItem.type !== 'relationship')) {
                alert('ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™ËäÇÁÇπÊàñÂÖ≥Á≥ªËøõË°å‰øÆÊîπ');
                return;
            }
            
            // Â¶ÇÊûúÊòØÂÖ≥Á≥ªÁ±ªÂûãÔºåÂçïÁã¨Â§ÑÁêÜ
            if (selectedItem.type === 'relationship') {
                const item = selectedItem.data;
                
                const relationshipNameInput = document.getElementById('edit-relationship-name');
                const relationshipConfidenceInput = document.getElementById('edit-relationship-confidence');
                const relationshipSourceInput = document.getElementById('edit-relationship-source');
                const relationshipEvidenceInput = document.getElementById('edit-relationship-evidence');
                const relationshipDirectionInput = document.getElementById('edit-relationship-direction');
                
                if (!relationshipNameInput || !relationshipNameInput.value.trim()) {
                    alert('ÂÖ≥Á≥ªÂêçÁß∞‰∏çËÉΩ‰∏∫Á©∫');
                    return;
                }
                
                const newRelationshipName = relationshipNameInput.value.trim();
                const modifiedProperties = {};
                
                if (relationshipConfidenceInput && relationshipConfidenceInput.value.trim()) {
                    const confidence = parseFloat(relationshipConfidenceInput.value.trim());
                    if (!isNaN(confidence) && confidence >= 0 && confidence <= 1) {
                        modifiedProperties['confidence'] = confidence;
                    } else {
                        alert('ÁΩÆ‰ø°Â∫¶ÂøÖÈ°ªÂú®0-1‰πãÈó¥');
                        return;
                    }
                }
                
                if (relationshipSourceInput && relationshipSourceInput.value.trim()) {
                    modifiedProperties['source'] = relationshipSourceInput.value.trim();
                } else {
                    // Â¶ÇÊûúÊ≤°ÊúâÂ°´ÂÜôsourceÔºå‰ΩøÁî®ÈªòËÆ§ÂÄº
                    modifiedProperties['source'] = 'manual_input';
                }
                
                if (relationshipEvidenceInput) {
                    modifiedProperties['evidence'] = relationshipEvidenceInput.value.trim() || selectedItem.data.properties.evidence || '';
                } else {
                    modifiedProperties['evidence'] = selectedItem.data.properties.evidence || '';
                }
                
                const direction = relationshipDirectionInput ? relationshipDirectionInput.value : 'to_endNode';
                
                // Ëé∑ÂèñËäÇÁÇπ‰ø°ÊÅØÁî®‰∫éÂêéÁª≠ÂèçÈ¶à
                const sourceNode = graphData.nodes.find(node => node.id === selectedItem.data.source.id);
                const targetNode = graphData.nodes.find(node => node.id === selectedItem.data.target.id);
                
                let directionText = '';
                if (direction === 'to_startNode') {
                    directionText = `${targetNode ? targetNode.label : 'Unknown'} ‚Üí ${sourceNode ? sourceNode.label : 'Unknown'}`;
                } else if (direction === 'bidirectional') {
                    directionText = `${sourceNode ? sourceNode.label : 'Unknown'} ‚Üî ${targetNode ? targetNode.label : 'Unknown'}`;
                } else {
                    directionText = `${sourceNode ? sourceNode.label : 'Unknown'} ‚Üí ${targetNode ? targetNode.label : 'Unknown'}`;
                }
                
                try {
                    // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
                    const confirmBtn = document.querySelector('.primary-btn');
                    const originalText = confirmBtn.textContent;
                    confirmBtn.textContent = '‰øÆÊîπ‰∏≠...';
                    confirmBtn.disabled = true;
                    
                    // Ë∞ÉÁî®ÂÖ≥Á≥ª‰øÆÊîπAPI
                    const response = await fetch('/api/modify_relation', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            relation_id: selectedItem.data.neo4j_id,
                            predicate: newRelationshipName,
                            source: modifiedProperties.source || selectedItem.data.source_type || 'neo4j',
                            confidence: modifiedProperties.confidence || 0.75,
                            directivity: direction,
                            evidence: modifiedProperties.evidence || ''
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        // ÈöêËóèÁºñËæëË°®Âçï
                        hideEditForms();
                        // ÈöêËóèËØ¶ÊÉÖÈù¢Êùø
                        document.getElementById("node-details").style.display = "none";
                        // ‰ΩøÁî®Âä®ÊÄÅÊõ¥Êñ∞‰ª£ÊõøÈ°µÈù¢Âà∑Êñ∞
                        const updateSuccess = await updateGraphData();
                        if (updateSuccess) {
                            alert(`ÂÖ≥Á≥ª‰øÆÊîπÊàêÂäüÔºÅ\n\n${directionText}\nÂÖ≥Á≥ªÁ±ªÂûãÔºö${newRelationshipName}\n\nÂõæË∞±Â∑≤Ëá™Âä®Êõ¥Êñ∞ÊòæÁ§∫ÊúÄÊñ∞Êï∞ÊçÆ„ÄÇ`);
                        } else {
                            alert(`ÂÖ≥Á≥ª‰øÆÊîπÊàêÂäüÔºÅ\n\nÂõæË∞±Êï∞ÊçÆÊõ¥Êñ∞Â§±Ë¥•ÔºåËØ∑ÊâãÂä®Âà∑Êñ∞È°µÈù¢„ÄÇ`);
                        }
                    } else {
                        alert(`ÂÖ≥Á≥ª‰øÆÊîπÂ§±Ë¥•Ôºö${result.error || 'Êú™Áü•ÈîôËØØ'}`);
                    }
                    
                } catch (error) {
                    console.error('ÂÖ≥Á≥ª‰øÆÊîπÊìç‰ΩúÂ§±Ë¥•:', error);
                    alert(`ÂÖ≥Á≥ª‰øÆÊîπÊìç‰ΩúÂ§±Ë¥•Ôºö${error.message}`);
                } finally {
                    // ÊÅ¢Â§çÊåâÈíÆÁä∂ÊÄÅ
                    const confirmBtn = document.querySelector('.primary-btn');
                    if (confirmBtn) {
                        confirmBtn.textContent = originalText;
                        confirmBtn.disabled = false;
                    }
                }
                
                return;
            }
            
            // Â§ÑÁêÜËäÇÁÇπÁ±ªÂûãÁöÑ‰øÆÊîπ
            const newNodeType = document.getElementById('edit-node-type').value.trim();
            
            if (!newNodeType) {
                alert('ËäÇÁÇπÁ±ªÂûã‰∏çËÉΩ‰∏∫Á©∫');
                return;
            }
            
            // Êî∂ÈõÜÂä®ÊÄÅÂ±ûÊÄßÁöÑ‰øÆÊîπÂÄº
            const modifiedProperties = {};
            modifiedProperties['node_type'] = newNodeType;

            if (newNodeType === 'Entity') {
                // Êî∂ÈõÜÂÆû‰ΩìÂ±ûÊÄß
                const entityNameInput = document.getElementById('edit-entity-name');
                const entityImportanceInput = document.getElementById('edit-entity-importance');
                const entityDescriptionInput = document.getElementById('edit-entity-description');
                const entityContextInput = document.getElementById('edit-entity-context');
                
                if (entityNameInput && entityNameInput.value.trim()) {
                    modifiedProperties['name'] = entityNameInput.value.trim();
                }
                if (entityImportanceInput && entityImportanceInput.value.trim()) {
                    const importance = parseFloat(entityImportanceInput.value.trim());
                    if (!isNaN(importance) && importance >= 0 && importance <= 1) {
                        modifiedProperties['importance'] = importance;
                    } else if (entityImportanceInput.value.trim() !== '') {
                        alert('ÂÆû‰ΩìÈáçË¶ÅÊÄßÂøÖÈ°ªÂú®0-1‰πãÈó¥');
                        return;
                    }
                }
                if (entityContextInput && entityContextInput.value.trim()) {
                    modifiedProperties['context'] = entityContextInput.value.trim();
                }
                if (entityDescriptionInput) {
                    const description = entityDescriptionInput.value.trim() || 'Êó†';
                    modifiedProperties['note'] = description;
                }
            } else if (newNodeType === 'Character') {
                // Êî∂ÈõÜËßíËâ≤Â±ûÊÄß
                const characterNameInput = document.getElementById('edit-character-name');
                const characterTrustInput = document.getElementById('edit-character-trust');
                const characterImportanceInput = document.getElementById('edit-character-importance');
                const characterContextInput = document.getElementById('edit-character-context');
                
                if (characterNameInput && characterNameInput.value.trim()) {
                    modifiedProperties['name'] = characterNameInput.value.trim();
                }
                if (characterTrustInput && characterTrustInput.value.trim()) {
                    const trust = parseFloat(characterTrustInput.value.trim());
                    if (!isNaN(trust) && trust >= 0 && trust <= 1) {
                        modifiedProperties['trust'] = trust;
                    } else if (characterTrustInput.value.trim() !== '') {
                        alert('ËßíËâ≤ÁΩÆ‰ø°Â∫¶ÂøÖÈ°ªÂú®0-1‰πãÈó¥');
                        return;
                    }
                }
                if (characterImportanceInput && characterImportanceInput.value.trim()) {
                    const importance = parseFloat(characterImportanceInput.value.trim());
                    if (!isNaN(importance) && importance >= 0 && importance <= 1) {
                        modifiedProperties['importance'] = importance;
                    } else if (characterImportanceInput.value.trim() !== '') {
                        alert('ËßíËâ≤ÈáçË¶ÅÊÄßÂøÖÈ°ªÂú®0-1‰πãÈó¥');
                        return;
                    }
                }
                if (characterContextInput && characterContextInput.value.trim()) {
                    modifiedProperties['context'] = characterContextInput.value.trim();
                }
            } else if (newNodeType === 'Location') {
                // Êî∂ÈõÜÂú∞ÁÇπÂ±ûÊÄß
                const locationNameInput = document.getElementById('edit-location-name');
                const locationContextInput = document.getElementById('edit-location-context');
                
                if (locationNameInput && locationNameInput.value.trim()) {
                    modifiedProperties['name'] = locationNameInput.value.trim();
                }
                if (locationContextInput && locationContextInput.value.trim()) {
                    modifiedProperties['context'] = locationContextInput.value.trim();
                }
            }
            
            // Êî∂ÈõÜÂÖ∂‰ªñÂ±ûÊÄßÁöÑ‰øÆÊîπÂÄº
            for (const [key, value] of Object.entries(selectedItem.data.properties)) {
                if (!EXCLUDED_PROPERTIES.includes(key)) {
                    const inputElement = document.getElementById(`edit-property-${key}`);
                    if (inputElement) {
                        const newValue = inputElement.value.trim();
                        if (newValue !== '') {
                            // Â∞ùËØïËß£Êûê‰∏∫ÂéüÂßãÁ±ªÂûãÔºåÂ¶ÇÊûúÂ§±Ë¥•Âàô‰Ωú‰∏∫Â≠óÁ¨¶‰∏≤
                            try {
                                modifiedProperties[key] = JSON.parse(newValue);
                            } catch {
                                modifiedProperties[key] = newValue;
                            }
                        }
                    }
                }
            }
            
            
            // ÂÆûÁé∞ËäÇÁÇπ‰øÆÊîπÈÄªËæë
            try {
                // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
                const confirmBtn = document.querySelector('.primary-btn');
                const originalText = confirmBtn.textContent;
                confirmBtn.textContent = '‰øÆÊîπ‰∏≠...';
                confirmBtn.disabled = true;
                
                // ÂáÜÂ§áAPIË∞ÉÁî®Êï∞ÊçÆ
                const updateData = {
                    element_id: selectedItem.data.neo4j_id,
                    updates: modifiedProperties
                };
                
                console.log('ËäÇÁÇπ‰øÆÊîπÂèÇÊï∞:', {
                    nodeId: selectedItem.data.neo4j_id,
                    originalType: selectedItem.data.labels.join(', '),
                    originalName: selectedItem.data.label,
                    newType: newNodeType,
                    modifiedProperties: modifiedProperties
                });
                
                // Ë∞ÉÁî®ËäÇÁÇπ‰øÆÊîπAPI
                const response = await fetch('/api/modify_node', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(updateData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // ÈöêËóèÁºñËæëË°®Âçï
                    hideEditForms();
                    // ÈöêËóèËØ¶ÊÉÖÈù¢Êùø
                    document.getElementById("node-details").style.display = "none";
                    // ‰ΩøÁî®Âä®ÊÄÅÊõ¥Êñ∞‰ª£ÊõøÈ°µÈù¢Âà∑Êñ∞
                    const updateSuccess = await updateGraphData();
                    if (updateSuccess) {
                        alert(`ËäÇÁÇπ‰øÆÊîπÊàêÂäüÔºÅ\n\nËäÇÁÇπIDÔºö${result.element_id}\nËäÇÁÇπÁ±ªÂûãÔºö${newNodeType}\n\nÂõæË∞±Â∑≤Ëá™Âä®Êõ¥Êñ∞ÊòæÁ§∫ÊúÄÊñ∞Êï∞ÊçÆ„ÄÇ`);
                    } else {
                        alert(`ËäÇÁÇπ‰øÆÊîπÊàêÂäüÔºÅ\n\nÂõæË∞±Êï∞ÊçÆÊõ¥Êñ∞Â§±Ë¥•ÔºåËØ∑ÊâãÂä®Âà∑Êñ∞È°µÈù¢„ÄÇ`);
                    }
                } else {
                    alert(`ËäÇÁÇπ‰øÆÊîπÂ§±Ë¥•Ôºö${result.error || 'Êú™Áü•ÈîôËØØ'}`);
                }
                
            } catch (error) {
                console.error('ËäÇÁÇπ‰øÆÊîπÊìç‰ΩúÂ§±Ë¥•:', error);
                alert(`ËäÇÁÇπ‰øÆÊîπÊìç‰ΩúÂ§±Ë¥•Ôºö${error.message}`);
            } finally {
                // ÊÅ¢Â§çÊåâÈíÆÁä∂ÊÄÅ
                const confirmBtn = document.querySelector('.primary-btn');
                if (confirmBtn) {
                    confirmBtn.textContent = originalText;
                    confirmBtn.disabled = false;
                }
            }
        }
        
        // Á°ÆËÆ§ÈìæÊé•ÂáΩÊï∞
        async function confirmLink() {
            if (recentSelectedNodes.length < 2) {
                alert('ËØ∑ÂÖàÈÄâÊã©‰∏§‰∏™ËäÇÁÇπËøõË°åÈìæÊé•');
                return;
            }
            
            // Ëé∑ÂèñË°®ÂçïÊï∞ÊçÆ
            const predicate = document.getElementById('link-predicate').value.trim();
            const confidence = parseFloat(document.getElementById('link-confidence').value);
            const evidenceInput = document.getElementById('link-evidence');
            const evidence = evidenceInput ? evidenceInput.value.trim() || 'user manual input' : 'user manual input';
            const directionSelect = document.getElementById('link-direction');
            const direction = directionSelect.value;
            
            if (!predicate) {
                alert('ËØ∑ËæìÂÖ•ÂÖ≥Á≥ªÁ±ªÂûã');
                return;
            }
            
            if (isNaN(confidence) || confidence < 0 || confidence > 1) {
                alert('ÁΩÆ‰ø°Â∫¶ÂøÖÈ°ªÂú®0-1‰πãÈó¥');
                return;
            }
            
            const node1 = recentSelectedNodes[1].data;
            const node2 = recentSelectedNodes[0].data;
            
            // ÊûÑÂª∫Á°ÆËÆ§ÈìæÊé•Ê∂àÊÅØ
            let directionText = '';
            if (direction === 'to_startNode') {
                directionText = `${node2.label} ‚Üí ${node1.label}`;
            } else if (direction === 'bidirectional') {
                directionText = `${node1.label} ‚Üî ${node2.label}`;
            } else {
                directionText = `${node1.label} ‚Üí ${node2.label}`;
            }
            
            const confirmMessage = `Á°ÆËÆ§ÂàõÂª∫‰ª•‰∏ãÈìæÊé•Ôºü\n\nÂÖ≥Á≥ªÔºö${predicate}\nÊñπÂêëÔºö${directionText}\nÁΩÆ‰ø°Â∫¶Ôºö${confidence}\n\nÊ≠§Êìç‰ΩúÂ∞ÜÂú®Neo4jÊï∞ÊçÆÂ∫ì‰∏≠ÂàõÂª∫Êñ∞ÁöÑÂÖ≥Á≥ª„ÄÇ`;
            
            if (!confirm(confirmMessage)) {
                return;
            }
            
            try {
                // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
                const confirmBtn = document.querySelector('.primary-btn');
                const originalText = confirmBtn.textContent;
                confirmBtn.textContent = 'ÈìæÊé•‰∏≠...';
                confirmBtn.disabled = true;
                
                // Ë∞ÉÁî®ÂêéÁ´ØAPI
                const response = await fetch('/api/create_relation', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        startNode_id: node1.neo4j_id,
                        endNode_id: node2.neo4j_id,
                        predicate: predicate,
                        source: 'manual_input',
                        confidence: confidence,
                        directivity: direction,
                        evidence: evidence
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Ê∏ÖÁ©∫ÈÄâÊã©ÁöÑËäÇÁÇπ
                    recentSelectedNodes = [];
                    // ÈöêËóèÁºñËæëË°®Âçï
                    hideEditForms();
                    // ‰ΩøÁî®Âä®ÊÄÅÊõ¥Êñ∞‰ª£ÊõøÈ°µÈù¢Âà∑Êñ∞
                    const updateSuccess = await updateGraphData();
                    if (updateSuccess) {
                        alert(`ÈìæÊé•ÂàõÂª∫ÊàêÂäüÔºÅ\n\nÂÖ≥Á≥ªIDÔºö${result.relationship_id}\nÂõæË∞±Â∑≤Ëá™Âä®Êõ¥Êñ∞ÊòæÁ§∫ÊúÄÊñ∞Êï∞ÊçÆ„ÄÇ`);
                    } else {
                        alert(`ÈìæÊé•ÂàõÂª∫ÊàêÂäüÔºÅ\n\nÂÖ≥Á≥ªIDÔºö${result.relationship_id}\nÂõæË∞±Êï∞ÊçÆÊõ¥Êñ∞Â§±Ë¥•ÔºåËØ∑ÊâãÂä®Âà∑Êñ∞È°µÈù¢„ÄÇ`);
                    }
                } else {
                    alert(`ÈìæÊé•ÂàõÂª∫Â§±Ë¥•Ôºö${result.error || 'Êú™Áü•ÈîôËØØ'}`);
                }
                
            } catch (error) {
                console.error('ÈìæÊé•Êìç‰ΩúÂ§±Ë¥•:', error);
                alert(`ÈìæÊé•Êìç‰ΩúÂ§±Ë¥•Ôºö${error.message}`);
            } finally {
                // ÊÅ¢Â§çÊåâÈíÆÁä∂ÊÄÅ
                const confirmBtn = document.querySelector('.primary-btn');
                if (confirmBtn) {
                    confirmBtn.textContent = originalText;
                    confirmBtn.disabled = false;
                }
            }
        }
        
        // ÂÖ≥Èó≠ËäÇÁÇπËØ¶ÊÉÖÈù¢Êùø
        function closeNodeDetails() {
            const detailsDiv = document.getElementById("node-details");
            detailsDiv.style.display = "none";
            clearSelection();
        }
        
        // Ê∏ÖÁ©∫ÈÄâ‰∏≠È°πÁõÆÔºàÂΩìËØ¶ÊÉÖÈù¢ÊùøÂÖ≥Èó≠Êó∂Ôºâ
        function clearSelection() {
            selectedItem = null;
            // Â¶ÇÊûúÂà†Èô§ÁïåÈù¢Â∑≤ÊâìÂºÄÔºåÂÆûÊó∂Êõ¥Êñ∞Âà†Èô§ÂÜÖÂÆπ
            updateDeleteFormIfVisible();
            // Â¶ÇÊûú‰øÆÊîπÁïåÈù¢Â∑≤ÊâìÂºÄÔºåÂÆûÊó∂Êõ¥Êñ∞‰øÆÊîπÂÜÖÂÆπ
            updateModifyFormIfVisible();
        }
        
        function resetButtonStates() {
            document.querySelectorAll('.edit-function-button').forEach(btn => {
                btn.classList.remove('active');
            });
        }
        
        // Ê∑ªÂä†ÂÖ®Â±ÄÂèòÈáèÁî®‰∫éË∑üË∏™ËäÇÁÇπÂàõÂª∫Áä∂ÊÄÅ
        let isCreatingNode = false;
        let newNodeData = null;
        let ghostNode = null;
        
        // ÈÄâÊã©ËäÇÁÇπÁ±ªÂûã
        function selectNodeType(nodeType) {
            // ÂÖàÈáçÁΩÆÊâÄÊúâÊåâÈíÆÁä∂ÊÄÅ
            document.querySelectorAll('.node-type-button').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            // ËÆæÁΩÆÂΩìÂâçÈÄâ‰∏≠ÊåâÈíÆÁöÑÁä∂ÊÄÅ
            event.target.closest('.node-type-button').classList.add('selected');
            
            if (nodeType === 'Time') {
                showTimeNodeForm();
            } else if (nodeType === 'Entity') {
                showEntityNodeForm();
            } else if (nodeType === 'Character') {
                showCharacterNodeForm();
            } else if (nodeType === 'Location') {
                showLocationNodeForm();
            }
        }
        
        // ÊòæÁ§∫Êó∂Èó¥ËäÇÁÇπÂàõÂª∫Ë°®Âçï
        function showTimeNodeForm() {
            const userInputForm = document.getElementById('user-input-form');
            userInputForm.style.display = 'block';
            userInputForm.innerHTML = `
                <div class="time-node-form">
                    <h4>ÂàõÂª∫Êó∂Èó¥ËäÇÁÇπ</h4>
                    <div class="form-group">
                        <label for="time-input">ËØ∑ËæìÂÖ•Êó∂Èó¥Ôºö</label>
                        <input type="text" id="time-input" placeholder="‰æãÂ¶ÇÔºö2024Âπ¥12Êúà5Êó•14ÁÇπ30ÂàÜ" class="time-input" />
                        <div class="time-format-help">
                            ÊîØÊåÅÊ†ºÂºèÔºö
                            <ul>
                                <li>ÂÆåÊï¥Ê†ºÂºèÔºö2024Âπ¥12Êúà5Êó•14ÁÇπ30ÂàÜ45Áßí</li>
                                <li>Êó•ÊúüÊ†ºÂºèÔºö2024Âπ¥12Êúà5Êó•</li>
                                <li>Êó∂Èó¥Ê†ºÂºèÔºö14ÁÇπ30ÂàÜ</li>
                                <li>Âë®Ê¨°Ê†ºÂºèÔºöÁ¨¨3‰∏™ÊòüÊúü‰∏Ä</li>
                                <li>Áõ∏ÂØπÊ†ºÂºèÔºö‰∏âÁÇπÂçä</li>
                            </ul>
                        </div>
                    </div>
                    <div class="form-buttons">
                        <button class="create-btn" onclick="createTimeNode()">ÂàõÂª∫Êó∂Èó¥ËäÇÁÇπ</button>
                        <button class="cancel-btn" onclick="hideUserInputForm()">ÂèñÊ∂à</button>
                    </div>
                </div>
            `;
            
            // ËÅöÁÑ¶Âà∞ËæìÂÖ•Ê°Ü
            setTimeout(() => {
                document.getElementById('time-input').focus();
            }, 100);
            
            // Ê∑ªÂä†ÂõûËΩ¶ÈîÆÁõëÂê¨
            document.getElementById('time-input').addEventListener('keypress', function(event) {
                if (event.key === 'Enter') {
                    createTimeNode();
                }
            });
        }
        
        // ÊòæÁ§∫ÂÆû‰ΩìËäÇÁÇπÂàõÂª∫Ë°®Âçï
        function showEntityNodeForm() {
            const userInputForm = document.getElementById('user-input-form');
            userInputForm.style.display = 'block';
            userInputForm.innerHTML = `
                <div class="entity-node-form">
                    <h4>ÂàõÂª∫ÂÆû‰ΩìËäÇÁÇπ</h4>
                    <div class="form-group">
                        <label for="entity-name-input">ÂÆû‰ΩìÂêçÁß∞Ôºö</label>
                        <input type="text" id="entity-name-input" placeholder="ËØ∑ËæìÂÖ•ÂÆû‰ΩìÂêçÁß∞" class="time-input" />
                    </div>
                    <div class="form-group">
                        <label for="entity-importance-input">ÂÆû‰ΩìÈáçË¶ÅÊÄßÔºö</label>
                        <input type="text" id="entity-importance-input" placeholder="ÂèñÂÄºËåÉÂõ¥0-1ÔºàÈªòËÆ§0.75Ôºâ" class="time-input" />
                    </div>
                    <div class="form-group">
                        <label for="entity-description-input">ÂÆû‰ΩìÊèèËø∞Ôºö</label>
                        <textarea id="entity-description-input" placeholder="Â§áÊ≥®‰ø°ÊÅØÔºàÈÄâÂ°´Ôºâ" class="time-input" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="entity-context-input">‰∏ä‰∏ãÊñáÁéØÂ¢ÉÔºö</label>
                        <input type="text" id="entity-context-input" value="realityÁé∞ÂÆû" placeholder="ËæìÂÖ•‰∏ä‰∏ãÊñáÁéØÂ¢É" class="time-input" />
                    </div>
                    <div class="form-buttons">
                        <button class="create-btn" onclick="createEntityNode()">ÂàõÂª∫ÂÆû‰ΩìËäÇÁÇπ</button>
                        <button class="cancel-btn" onclick="hideUserInputForm()">ÂèñÊ∂à</button>
                    </div>
                </div>
            `;
            
            // ËÅöÁÑ¶Âà∞ËæìÂÖ•Ê°Ü
            setTimeout(() => {
                document.getElementById('entity-name-input').focus();
            }, 100);
        }
        
        // ÊòæÁ§∫ËßíËâ≤ËäÇÁÇπÂàõÂª∫Ë°®Âçï
        function showCharacterNodeForm() {
            const userInputForm = document.getElementById('user-input-form');
            userInputForm.style.display = 'block';
            userInputForm.innerHTML = `
                <div class="character-node-form">
                    <h4>ÂàõÂª∫ËßíËâ≤ËäÇÁÇπ</h4>
                    <div class="form-group">
                        <label for="character-name-input">ËßíËâ≤ÂêçÁß∞Ôºö</label>
                        <input type="text" id="character-name-input" placeholder="ËØ∑ËæìÂÖ•ËßíËâ≤ÂêçÁß∞" class="time-input" />
                    </div>
                    <div class="form-group">
                        <label for="character-trust-input">ËßíËâ≤ÁΩÆ‰ø°Â∫¶Ôºö</label>
                        <input type="text" id="character-trust-input" placeholder="ÂèñÂÄºËåÉÂõ¥0-1ÔºàÈªòËÆ§0.75Ôºâ" class="time-input" />
                    </div>
                    <div class="form-group">
                        <label for="character-importance-input">ËßíËâ≤ÈáçË¶ÅÊÄßÔºö</label>
                        <input type="text" id="character-importance-input" placeholder="ÂèñÂÄºËåÉÂõ¥0-1ÔºàÈªòËÆ§0.75Ôºâ" class="time-input" />
                    </div>
                    <div class="form-group">
                        <label for="character-context-input">‰∏ä‰∏ãÊñáÁéØÂ¢ÉÔºö</label>
                        <input type="text" id="character-context-input" value="realityÁé∞ÂÆû" placeholder="ËæìÂÖ•‰∏ä‰∏ãÊñáÁéØÂ¢É" class="time-input" />
                    </div>
                    <div class="form-buttons">
                        <button class="create-btn" onclick="createCharacterNode()">ÂàõÂª∫ËßíËâ≤ËäÇÁÇπ</button>
                        <button class="cancel-btn" onclick="hideUserInputForm()">ÂèñÊ∂à</button>
                    </div>
                </div>
            `;
            
            // ËÅöÁÑ¶Âà∞ËæìÂÖ•Ê°Ü
            setTimeout(() => {
                document.getElementById('character-name-input').focus();
            }, 100);
        }
        
        // ÊòæÁ§∫Âú∞ÁÇπËäÇÁÇπÂàõÂª∫Ë°®Âçï
        function showLocationNodeForm() {
            const userInputForm = document.getElementById('user-input-form');
            userInputForm.style.display = 'block';
            userInputForm.innerHTML = `
                <div class="location-node-form">
                    <h4>ÂàõÂª∫Âú∞ÁÇπËäÇÁÇπ</h4>
                    <div class="form-group">
                        <label for="location-name-input">Âú∞ÁÇπÂêçÁß∞Ôºö</label>
                        <input type="text" id="location-name-input" placeholder="ËØ∑ËæìÂÖ•Âú∞ÁÇπÂêçÁß∞" class="time-input" />
                    </div>
                    <div class="form-group">
                        <label for="location-context-input">‰∏ä‰∏ãÊñáÁéØÂ¢ÉÔºö</label>
                        <input type="text" id="location-context-input" value="realityÁé∞ÂÆû" placeholder="ËæìÂÖ•‰∏ä‰∏ãÊñáÁéØÂ¢É" class="time-input" />
                    </div>
                    <div class="form-buttons">
                        <button class="create-btn" onclick="createLocationNode()">ÂàõÂª∫Âú∞ÁÇπËäÇÁÇπ</button>
                        <button class="cancel-btn" onclick="hideUserInputForm()">ÂèñÊ∂à</button>
                    </div>
                </div>
            `;
            
            // ËÅöÁÑ¶Âà∞ËæìÂÖ•Ê°Ü
            setTimeout(() => {
                document.getElementById('location-name-input').focus();
            }, 100);
        }
        
        // ÈöêËóèÁî®Êà∑ËæìÂÖ•Ë°®Âçï
        function hideUserInputForm() {
            const userInputForm = document.getElementById('user-input-form');
            userInputForm.style.display = 'none';
            userInputForm.innerHTML = '';
            
            // ÈáçÁΩÆÊåâÈíÆÈÄâ‰∏≠Áä∂ÊÄÅ
            document.querySelectorAll('.node-type-button').forEach(btn => {
                btn.classList.remove('selected');
            });
        }
        
        // ÂàõÂª∫Êó∂Èó¥ËäÇÁÇπ
        function createTimeNode() {
            const timeInput = document.getElementById('time-input');
            const timeStr = timeInput.value.trim();
            
            if (!timeStr) {
                alert('ËØ∑ËæìÂÖ•Êó∂Èó¥‰ø°ÊÅØ');
                timeInput.focus();
                return;
            }
            
            // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
            const createBtn = document.querySelector('.create-btn');
            const originalText = createBtn.textContent;
            createBtn.textContent = 'ÂàõÂª∫‰∏≠...';
            createBtn.disabled = true;
            
            // Ë∞ÉÁî®APIÂàõÂª∫Êó∂Èó¥ËäÇÁÇπ
            fetch('/api/create_time_node', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    time_str: timeStr
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    hideUserInputForm();
                    hideEditForms();
                    // ‰ΩøÁî®Âä®ÊÄÅÊõ¥Êñ∞‰ª£ÊõøÈ°µÈù¢Âà∑Êñ∞
                    updateGraphData().then(updateSuccess => {
                        if (updateSuccess) {
                            alert(`Êó∂Èó¥ËäÇÁÇπÂàõÂª∫ÊàêÂäü: ${data.message}\n\nÂõæË∞±Â∑≤Ëá™Âä®Êõ¥Êñ∞ÊòæÁ§∫ÊúÄÊñ∞Êï∞ÊçÆ„ÄÇ`);
                        } else {
                            alert(`Êó∂Èó¥ËäÇÁÇπÂàõÂª∫ÊàêÂäü: ${data.message}\n\nÂõæË∞±Êï∞ÊçÆÊõ¥Êñ∞Â§±Ë¥•ÔºåËØ∑ÊâãÂä®Âà∑Êñ∞È°µÈù¢„ÄÇ`);
                        }
                    });
                } else {
                    alert(`Êó∂Èó¥ËäÇÁÇπÂàõÂª∫Â§±Ë¥•: ${data.error}`);
                }
            })
            .catch(error => {
                console.error('ÂàõÂª∫Êó∂Èó¥ËäÇÁÇπÊó∂Âá∫Èîô:', error);
                alert('ÂàõÂª∫Êó∂Èó¥ËäÇÁÇπÊó∂Âá∫Èîô: ' + error.message);
            })
            .finally(() => {
                createBtn.textContent = originalText;
                createBtn.disabled = false;
            });
        }
        
        // ÂàõÂª∫ÂÆû‰ΩìËäÇÁÇπ
        function createEntityNode() {
            const nameInput = document.getElementById('entity-name-input');
            const importanceInput = document.getElementById('entity-importance-input');
            const descriptionInput = document.getElementById('entity-description-input');
            const contextInput = document.getElementById('entity-context-input');
            const entityName = nameInput.value.trim();
            const importance = parseFloat(importanceInput.value.trim()) || 0.5;
            const entityDescription = descriptionInput.value.trim() || 'Êó†';
            const context = contextInput.value.trim() || 'realityÁé∞ÂÆû';
            
            if (!entityName) {
                alert('ËØ∑ËæìÂÖ•ÂÆû‰ΩìÂêçÁß∞');
                nameInput.focus();
                return;
            }
            
            // È™åËØÅÈáçË¶ÅÊÄßËåÉÂõ¥
            if (importance < 0 || importance > 1) {
                alert('ÂÆû‰ΩìÈáçË¶ÅÊÄßÂøÖÈ°ªÂú®0-1‰πãÈó¥');
                importanceInput.focus();
                return;
            }
            
            // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
            const createBtn = document.querySelector('.create-btn');
            const originalText = createBtn.textContent;
            createBtn.textContent = 'ÂàõÂª∫‰∏≠...';
            createBtn.disabled = true;
            
            // Ë∞ÉÁî®APIÂàõÂª∫ÂÆû‰ΩìËäÇÁÇπ
            fetch('/api/create_entity_node', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    entity_name: entityName,
                    importance: importance,
                    context: context,
                    note: entityDescription
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    hideUserInputForm();
                    hideEditForms();
                    // ‰ΩøÁî®Âä®ÊÄÅÊõ¥Êñ∞‰ª£ÊõøÈ°µÈù¢Âà∑Êñ∞
                    updateGraphData().then(updateSuccess => {
                        if (updateSuccess) {
                            alert(`ÂÆû‰ΩìËäÇÁÇπÂàõÂª∫ÊàêÂäü: ${data.message}\n\nÂõæË∞±Â∑≤Ëá™Âä®Êõ¥Êñ∞ÊòæÁ§∫ÊúÄÊñ∞Êï∞ÊçÆ„ÄÇ`);
                        } else {
                            alert(`ÂÆû‰ΩìËäÇÁÇπÂàõÂª∫ÊàêÂäü: ${data.message}\n\nÂõæË∞±Êï∞ÊçÆÊõ¥Êñ∞Â§±Ë¥•ÔºåËØ∑ÊâãÂä®Âà∑Êñ∞È°µÈù¢„ÄÇ`);
                        }
                    });
                } else {
                    alert(`ÂÆû‰ΩìËäÇÁÇπÂàõÂª∫Â§±Ë¥•: ${data.error}`);
                }
            })
            .catch(error => {
                console.error('ÂàõÂª∫ÂÆû‰ΩìËäÇÁÇπÊó∂Âá∫Èîô:', error);
                alert('ÂàõÂª∫ÂÆû‰ΩìËäÇÁÇπÊó∂Âá∫Èîô: ' + error.message);
            })
            .finally(() => {
                createBtn.textContent = originalText;
                createBtn.disabled = false;
            });
        }
        
        // ÂàõÂª∫ËßíËâ≤ËäÇÁÇπ
        function createCharacterNode() {
            const nameInput = document.getElementById('character-name-input');
            const trustInput = document.getElementById('character-trust-input');
            const importanceInput = document.getElementById('character-importance-input');
            const contextInput = document.getElementById('character-context-input');
            const characterName = nameInput.value.trim();
            const trust = parseFloat(trustInput.value.trim()) || 0.5;
            const importance = parseFloat(importanceInput.value.trim()) || 0.5;
            const context = contextInput.value.trim() || 'realityÁé∞ÂÆû';
            
            if (!characterName) {
                alert('ËØ∑ËæìÂÖ•ËßíËâ≤ÂêçÁß∞');
                nameInput.focus();
                return;
            }
            
            // È™åËØÅÁΩÆ‰ø°Â∫¶ÂíåÈáçË¶ÅÊÄßËåÉÂõ¥
            if (trust < 0 || trust > 1) {
                alert('ËßíËâ≤ÁΩÆ‰ø°Â∫¶ÂøÖÈ°ªÂú®0-1‰πãÈó¥');
                trustInput.focus();
                return;
            }
            
            if (importance < 0 || importance > 1) {
                alert('ËßíËâ≤ÈáçË¶ÅÊÄßÂøÖÈ°ªÂú®0-1‰πãÈó¥');
                importanceInput.focus();
                return;
            }
            
            // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
            const createBtn = document.querySelector('.create-btn');
            const originalText = createBtn.textContent;
            createBtn.textContent = 'ÂàõÂª∫‰∏≠...';
            createBtn.disabled = true;
            
            // Ë∞ÉÁî®APIÂàõÂª∫ËßíËâ≤ËäÇÁÇπ
            fetch('/api/create_character_node', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    character_name: characterName,
                    trust: trust,
                    importance: importance,
                    context: context
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    hideUserInputForm();
                    hideEditForms();
                    // ‰ΩøÁî®Âä®ÊÄÅÊõ¥Êñ∞‰ª£ÊõøÈ°µÈù¢Âà∑Êñ∞
                    updateGraphData().then(updateSuccess => {
                        if (updateSuccess) {
                            alert(`ËßíËâ≤ËäÇÁÇπÂàõÂª∫ÊàêÂäü: ${data.message}\n\nÂõæË∞±Â∑≤Ëá™Âä®Êõ¥Êñ∞ÊòæÁ§∫ÊúÄÊñ∞Êï∞ÊçÆ„ÄÇ`);
                        } else {
                            alert(`ËßíËâ≤ËäÇÁÇπÂàõÂª∫ÊàêÂäü: ${data.message}\n\nÂõæË∞±Êï∞ÊçÆÊõ¥Êñ∞Â§±Ë¥•ÔºåËØ∑ÊâãÂä®Âà∑Êñ∞È°µÈù¢„ÄÇ`);
                        }
                    });
                } else {
                    alert(`ËßíËâ≤ËäÇÁÇπÂàõÂª∫Â§±Ë¥•: ${data.error}`);
                }
            })
            .catch(error => {
                console.error('ÂàõÂª∫ËßíËâ≤ËäÇÁÇπÊó∂Âá∫Èîô:', error);
                alert('ÂàõÂª∫ËßíËâ≤ËäÇÁÇπÊó∂Âá∫Èîô: ' + error.message);
            })
            .finally(() => {
                createBtn.textContent = originalText;
                createBtn.disabled = false;
            });
        }
        
        // ÂàõÂª∫Âú∞ÁÇπËäÇÁÇπ
        function createLocationNode() {
            const nameInput = document.getElementById('location-name-input');
            const contextInput = document.getElementById('location-context-input');
            const locationName = nameInput.value.trim();
            const context = contextInput.value.trim() || 'realityÁé∞ÂÆû';
            
            if (!locationName) {
                alert('ËØ∑ËæìÂÖ•Âú∞ÁÇπÂêçÁß∞');
                nameInput.focus();
                return;
            }
            
            // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
            const createBtn = document.querySelector('.create-btn');
            const originalText = createBtn.textContent;
            createBtn.textContent = 'ÂàõÂª∫‰∏≠...';
            createBtn.disabled = true;
            
            // Ë∞ÉÁî®APIÂàõÂª∫Âú∞ÁÇπËäÇÁÇπ
            fetch('/api/create_location_node', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    location_name: locationName,
                    context: context
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    hideUserInputForm();
                    hideEditForms();
                    // ‰ΩøÁî®Âä®ÊÄÅÊõ¥Êñ∞‰ª£ÊõøÈ°µÈù¢Âà∑Êñ∞
                    updateGraphData().then(updateSuccess => {
                        if (updateSuccess) {
                            alert(`Âú∞ÁÇπËäÇÁÇπÂàõÂª∫ÊàêÂäü: ${data.message}\n\nÂõæË∞±Â∑≤Ëá™Âä®Êõ¥Êñ∞ÊòæÁ§∫ÊúÄÊñ∞Êï∞ÊçÆ„ÄÇ`);
                        } else {
                            alert(`Âú∞ÁÇπËäÇÁÇπÂàõÂª∫ÊàêÂäü: ${data.message}\n\nÂõæË∞±Êï∞ÊçÆÊõ¥Êñ∞Â§±Ë¥•ÔºåËØ∑ÊâãÂä®Âà∑Êñ∞È°µÈù¢„ÄÇ`);
                        }
                    });
                } else {
                    alert(`Âú∞ÁÇπËäÇÁÇπÂàõÂª∫Â§±Ë¥•: ${data.error}`);
                }
            })
            .catch(error => {
                console.error('ÂàõÂª∫Âú∞ÁÇπËäÇÁÇπÊó∂Âá∫Èîô:', error);
                alert('ÂàõÂª∫Âú∞ÁÇπËäÇÁÇπÊó∂Âá∫Èîô: ' + error.message);
            })
            .finally(() => {
                createBtn.textContent = originalText;
                createBtn.disabled = false;
            });
        }
        
        function saveNodeToLocalMemory(nodeData) {
            // ÂäüËÉΩÂ∑≤Á¶ÅÁî®
        }
        
        function cleanupNodeCreation() {
            // ÂäüËÉΩÂ∑≤Á¶ÅÁî®
        }
        
        function deleteNode() {
            // ÂäüËÉΩÂ∑≤Á¶ÅÁî®
        }
        
        function updateVisualization() {
            // Êõ¥Êñ∞ËäÇÁÇπÈÄâÊã©ÂàóË°®
            updateNodeSelectionLists();
            
            // Â§ÑÁêÜÂèåÂêëÂÖ≥Á≥ª
            detectBidirectionalLinks(graphData.links);
            
            // Êõ¥Êñ∞ÂäõÂØºÂêëÂõæÊï∞ÊçÆ
            simulation.nodes(graphData.nodes);
            simulation.force("link").links(graphData.links);
            
            // ÈáçÊñ∞ÁªëÂÆöÂπ∂Êõ¥Êñ∞ËäÇÁÇπ
            node = node.data(graphData.nodes, d => d.id);
            node.exit().remove();
            node = node.enter().append("circle")
                .attr("class", "node")
                .attr("r", d => d.size)
                .attr("fill", d => d.color)
                .attr("stroke", d => d.strokeColor)
                .attr("stroke-width", d => d.strokeWidth)
                .on("click", showNodeDetails)
                .call(d3.drag()
                    .on("start", dragstarted)
                    .on("drag", dragged)
                    .on("end", dragended))
                .merge(node);
            
            // Êõ¥Êñ∞ÊâÄÊúâËäÇÁÇπÁöÑÂ±ûÊÄßÔºàÂåÖÊã¨Áé∞ÊúâÁöÑÔºâ
            node.attr("r", d => d.size)
                .attr("fill", d => d.color)
                .attr("stroke", d => d.strokeColor)
                .attr("stroke-width", d => d.strokeWidth);
            
            // ÈáçÊñ∞ÁªëÂÆöÂπ∂Êõ¥Êñ∞ÈìæÊé•
            link = link.data(graphData.links, d => d.neo4j_id || d.id);
            link.exit().remove();
            link = link.enter().append("line")
                .attr("class", "link")
                .attr("marker-end", d => getStorageTypeArrow(d.source_type))
                .attr("stroke", d => getStorageTypeColor(d.source_type))
                .attr("stroke-width", "2")
                .on("click", showLinkDetails)
                .merge(link);
            
            // Êõ¥Êñ∞ÊâÄÊúâÈìæÊé•ÁöÑÈ¢úËâ≤ÔºàÂåÖÊã¨Áé∞ÊúâÁöÑÔºâ
            link.attr("stroke", d => {
                    // Ë∞ÉËØïÔºöÊâìÂç∞ÂÖ≥Á≥ªÁöÑsource_type
                    console.log('Êõ¥Êñ∞ÂÖ≥Á≥ªÈ¢úËâ≤ - ID:', d.neo4j_id, 'Type:', d.type, 'Source_type:', d.source_type);
                    
                    // Ê†πÊçÆÂ≠òÂÇ®‰ΩçÁΩÆËÆæÁΩÆÈ¢úËâ≤
                    if (!d.source_type || !STORAGE_TYPE_COLORS[d.source_type]) {
                        console.warn('Êõ¥Êñ∞Êó∂ÂÖ≥Á≥ªÊú™Áü•Â≠òÂÇ®‰ΩçÁΩÆ:', d.source_type, 'ÂÖ≥Á≥ª:', d);
                    }
                    return getStorageTypeColor(d.source_type);
                })
                .attr("marker-end", d => getStorageTypeArrow(d.source_type));
            
            // ÈáçÊñ∞ÁªëÂÆöÂπ∂Êõ¥Êñ∞ËäÇÁÇπÊ†áÁ≠æ
            nodeLabels = nodeLabels.data(graphData.nodes, d => d.id);
            nodeLabels.exit().remove();
            nodeLabels = nodeLabels.enter().append("text")
                .attr("class", "node-label")
                .text(d => d.label.length > 8 ? d.label.substring(0, 8) + "..." : d.label)
                .style("display", "block")
                .merge(nodeLabels);
            
            // Êõ¥Êñ∞ÊâÄÊúâËäÇÁÇπÊ†áÁ≠æÁöÑÊñáÊú¨ÂÜÖÂÆπÔºàÂåÖÊã¨Áé∞ÊúâÁöÑÔºâ
            nodeLabels.text(d => d.label.length > 8 ? d.label.substring(0, 8) + "..." : d.label);
            
            // ÈáçÊñ∞ÁªëÂÆöÂπ∂Êõ¥Êñ∞ÈìæÊé•Ê†áÁ≠æ
            linkLabels = linkLabels.data(graphData.links, d => d.neo4j_id || d.id);
            linkLabels.exit().remove();
            linkLabels = linkLabels.enter().append("text")
                .attr("class", "link-label")
                .text(d => {
                    // ÊòæÁ§∫ÂÖ≥Á≥ªÁ±ªÂûãÔºö‰ºòÂÖàÊòæÁ§∫predicate > action > type
                    if (d.properties && d.properties.predicate) {
                        return d.properties.predicate;
                    } else if (d.properties && d.properties.action) {
                        return d.properties.action;
                    } else {
                        return d.type;
                    }
                })
                .style("display", "block")
                .merge(linkLabels);
            
            // Êõ¥Êñ∞Áé∞ÊúâÊ†áÁ≠æÁöÑÊñáÊú¨ÂÜÖÂÆπ
            linkLabels.text(d => {
                // ÊòæÁ§∫ÂÖ≥Á≥ªÁ±ªÂûãÔºö‰ºòÂÖàÊòæÁ§∫predicate > action > type
                if (d.properties && d.properties.predicate) {
                    return d.properties.predicate;
                } else if (d.properties && d.properties.action) {
                    return d.properties.action;
                } else {
                    return d.type;
                }
            });
            
            // ÈáçÊñ∞ÁªëÂÆöÂπ∂Êõ¥Êñ∞ÈìæÊé•Ê†áÁ≠æËÉåÊôØ
            linkLabelBgs = linkLabelBgs.data(graphData.links, d => d.neo4j_id || d.id);
            linkLabelBgs.exit().remove();
            linkLabelBgs = linkLabelBgs.enter().append("rect")
                .attr("class", "link-label-bg")
                .attr("fill", "rgba(255,255,255,0.8)")
                .attr("stroke", "rgba(200,200,200,0.5)")
                .attr("stroke-width", 0.5)
                .attr("rx", 3)
                .attr("ry", 3)
                .merge(linkLabelBgs);
            
            // Â∫îÁî®ÂΩìÂâçÁöÑÊ†áÁ≠æÂèØËßÅÊÄßÁä∂ÊÄÅ
            nodeLabels.style("display", nodeLabelsVisible ? "block" : "none");
            linkLabels.style("display", linkLabelsVisible ? "block" : "none");
            linkLabelBgs.style("display", linkLabelsVisible ? "block" : "none");
            
            // ÈáçÊñ∞ÂêØÂä®‰ªøÁúü
            simulation.alpha(1).restart();
        }
        
        // ÂàùÂßãÂåñ
        initStats();
        initEditButtonState();
        
        // ÂàùÂßãÂåñÁºñËæëÊåâÈíÆÁä∂ÊÄÅ
        function initEditButtonState() {
            const editButton = document.getElementById('edit-button');
            const neo4jConnected = graphData.neo4j_connected;
            
            console.log('üîç Neo4jËøûÊé•Áä∂ÊÄÅÊ£ÄÊü•:', neo4jConnected);
            console.log('üîç ÂÆåÊï¥graphData:', graphData);
            console.log('üîç ÁºñËæëÊåâÈíÆÂÖÉÁ¥†:', editButton);
            
            if (!editButton) {
                console.error('‚ùå Êó†Ê≥ïÊâæÂà∞ÁºñËæëÊåâÈíÆÂÖÉÁ¥†');
                return;
            }
            
            if (!neo4jConnected) {
                console.log('‚ùå Neo4jÊú™ËøûÊé•ÔºåÁ¶ÅÁî®ÁºñËæëÊåâÈíÆ');
                editButton.disabled = true;
                editButton.className = 'control-button edit-controls';
                editButton.title = 'Neo4jÊï∞ÊçÆÂ∫ìÊú™ËøûÊé•ÔºåÊó†Ê≥ïÁºñËæëËäÇÁÇπ';
                editButton.onclick = function(event) {
                    event.preventDefault();
                    alert('Neo4jÊï∞ÊçÆÂ∫ìÊú™ËøûÊé•ÔºåÊó†Ê≥ïËøõË°åËäÇÁÇπÁºñËæëÊìç‰Ωú„ÄÇ\\n\\nËØ∑Ê£ÄÊü•Ôºö\\n1. Neo4jÊúçÂä°ÊòØÂê¶ÂêØÂä®\\n2. ÁΩëÁªúËøûÊé•ÊòØÂê¶Ê≠£Â∏∏\\n3. ÈÖçÁΩÆÊñá‰ª∂‰∏≠ÁöÑËøûÊé•‰ø°ÊÅØÊòØÂê¶Ê≠£Á°Æ');
                };
            } else {
                console.log('‚úÖ Neo4jÂ∑≤ËøûÊé•ÔºåÂêØÁî®ÁºñËæëÊåâÈíÆ');
                editButton.disabled = false;
                editButton.className = 'control-button edit-controls';
                editButton.title = 'ÁºñËæëËÆ∞ÂøÜÂõæË∞±ËäÇÁÇπ';
                editButton.onclick = function(event) {
                    event.preventDefault();
                    toggleEditPanel();
                };
            }
        }
        
        // ‰øÆÊîπtoggleEditPanelÂáΩÊï∞ÔºåÂ¢ûÂä†ËøûÊé•Áä∂ÊÄÅÊ£ÄÊü•
        function toggleEditPanel() {
            console.log('üîÑ toggleEditPanelË¢´Ë∞ÉÁî®');
            console.log('üîç ÂΩìÂâçNeo4jËøûÊé•Áä∂ÊÄÅ:', graphData.neo4j_connected);
            
            if (!graphData.neo4j_connected) {
                console.log('‚ùå Neo4jÊú™ËøûÊé•ÔºåÈòªÊ≠¢Èù¢ÊùøÊâìÂºÄ');
                alert('Neo4jÊï∞ÊçÆÂ∫ìÊú™ËøûÊé•ÔºåÊó†Ê≥ïËøõË°åËäÇÁÇπÁºñËæëÊìç‰Ωú„ÄÇ');
                return;
            }
            
            console.log('‚úÖ Neo4jÂ∑≤ËøûÊé•ÔºåÂàáÊç¢ÁºñËæëÈù¢Êùø');
            const panel = document.getElementById('edit-panel');
            panel.classList.toggle('show');
            
            // Â¶ÇÊûúÊâìÂºÄÈù¢ÊùøÔºåÊõ¥Êñ∞ËäÇÁÇπÈÄâÊã©ÂàóË°®
            if (panel.classList.contains('show')) {
                console.log('üìã Êõ¥Êñ∞ËäÇÁÇπÈÄâÊã©ÂàóË°®');
                updateNodeSelectionLists();
            }
        }
        
        // ÊµãËØïAPIËøûÊé•ÁöÑÂáΩÊï∞
        window.testApiConnection = function() {
            console.log('üß™ ÊµãËØïAPIËøûÊé•');
            fetch('/api/create_time_node', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    time_str: 'ÊµãËØïÊó∂Èó¥'
                })
            })
            .then(response => {
                console.log('APIÂìçÂ∫îÁä∂ÊÄÅ:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('APIÂìçÂ∫îÊï∞ÊçÆ:', data);
                alert('APIËøûÊé•ÊµãËØïÂÆåÊàêÔºåËØ∑Êü•ÁúãÊéßÂà∂Âè∞');
            })
            .catch(error => {
                console.error('APIËøûÊé•ÊµãËØïÂ§±Ë¥•:', error);
                alert('APIËøûÊé•Â§±Ë¥•: ' + error.message);
            });
        };
        
        // Ê∑ªÂä†ESCÈîÆÁõëÂê¨Êù•ÂèñÊ∂àËäÇÁÇπÂàõÂª∫
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape' && isCreatingNode) {
                cleanupNodeCreation();
            }
        });
        
        // ÂÆ¢Êà∑Á´ØÁîüÂëΩÂë®ÊúüÁÆ°ÁêÜ
        let heartbeatInterval = null;
        let disconnectSent = false; // Èò≤Ê≠¢ÈáçÂ§çÂèëÈÄÅÊñ≠ÂºÄËøûÊé•ÈÄöÁü•
        
        // ÂêØÂä®ÂøÉË∑≥
        function startHeartbeat() {
            // Á´ãÂç≥ÂèëÈÄÅ‰∏ÄÊ¨°ÂøÉË∑≥
            sendHeartbeat();
            
            // ÊØè60ÁßíÂèëÈÄÅ‰∏ÄÊ¨°ÂøÉË∑≥
            heartbeatInterval = setInterval(sendHeartbeat, 60000);
        }
        
        // ÂèëÈÄÅÂøÉË∑≥
        function sendHeartbeat() {
            fetch('/api/heartbeat', {
                method: 'GET'
            }).catch(error => {
                console.log('ÂøÉË∑≥ÂèëÈÄÅÂ§±Ë¥•:', error);
            });
        }
        

        
        // ÈÄöÁü•ÊúçÂä°Âô®ÂÆ¢Êà∑Á´ØÊñ≠ÂºÄËøûÊé•
        function notifyDisconnect() {
            // Èò≤Ê≠¢ÈáçÂ§çÂèëÈÄÅÊñ≠ÂºÄËøûÊé•ÈÄöÁü•
            if (disconnectSent) {
                return;
            }
            disconnectSent = true;
            
            console.log('ÂèëÈÄÅÊñ≠ÂºÄËøûÊé•ÈÄöÁü•');
            
            // ÂÅúÊ≠¢ÂøÉË∑≥ÔºàÂ¶ÇÊûúÊ≠£Âú®ËøêË°åÔºâ
            if (heartbeatInterval) {
                clearInterval(heartbeatInterval);
                heartbeatInterval = null;
            }
            
            const payload = JSON.stringify({
                action: 'disconnect',
                timestamp: Date.now()
            });
            
            // ‰ºòÂÖà‰ΩøÁî®ÂêåÊ≠•ËØ∑Ê±ÇÔºàÊõ¥ÂèØÈù†ÔºåÂ∞§ÂÖ∂Âú®ÊµèËßàÂô®ÂÖ≥Èó≠Êó∂Ôºâ
            try {
                console.log('‰ΩøÁî®ÂêåÊ≠•XMLHttpRequestÂèëÈÄÅÊñ≠ÂºÄËøûÊé•ÈÄöÁü•');
                const xhr = new XMLHttpRequest();
                xhr.open('POST', '/api/disconnect', false); // ÂêåÊ≠•ËØ∑Ê±Ç
                xhr.setRequestHeader('Content-Type', 'application/json');
                xhr.timeout = 1000; // 1ÁßíË∂ÖÊó∂
                xhr.send(payload);
                console.log('ÂêåÊ≠•ËØ∑Ê±ÇÂèëÈÄÅÂÆåÊàêÔºåÁä∂ÊÄÅ:', xhr.status);
            } catch (error) {
                console.warn('ÂêåÊ≠•ËØ∑Ê±ÇÂ§±Ë¥•ÔºåÂ∞ùËØïsendBeacon:', error);
                // Â§áÁî®ÊñπÊ°àÔºösendBeacon
                if (navigator.sendBeacon) {
                    const blob = new Blob([payload], { type: 'application/json' });
                    const success = navigator.sendBeacon('/api/disconnect', blob);
                    console.log('sendBeaconÂ§áÁî®ÁªìÊûú:', success);
                }
            }
        }
        
        // È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÂêØÂä®ÂøÉË∑≥
        document.addEventListener('DOMContentLoaded', function() {
            startHeartbeat();
        });
        
        // È°µÈù¢ÂÖ≥Èó≠Ê£ÄÊµãÊú∫Âà∂ÔºàÈíàÂØπChromeÊµèËßàÂô®Áõ¥Êé•ÂÖ≥Èó≠ÁöÑÈóÆÈ¢òÔºâ
        
        // 1. beforeunload - ‰∏ªË¶ÅÊñπÊ≥ï
        window.addEventListener('beforeunload', function(event) {
            console.log('beforeunload‰∫ã‰ª∂Ëß¶Âèë');
            notifyDisconnect();
        });
        
        // 2. unload - Â§áÁî®ÊñπÊ≥ï
        window.addEventListener('unload', function(event) {
            console.log('unload‰∫ã‰ª∂Ëß¶Âèë');
            notifyDisconnect();
        });
        
        // 3. pagehide - ‰ªÖÂú®È°µÈù¢ÁúüÊ≠£Ë¢´Âç∏ËΩΩÊó∂Ëß¶ÂèëÔºà‰∏çÊòØË¢´ÁºìÂ≠òÔºâ
        window.addEventListener('pagehide', function(event) {
            console.log('pagehide‰∫ã‰ª∂Ëß¶ÂèëÔºåpersisted:', event.persisted);
            // Âè™ÊúâÂú®È°µÈù¢ÁúüÊ≠£Ë¢´Âç∏ËΩΩÔºà‰∏çÊòØË¢´ÁºìÂ≠òÔºâÊó∂ÊâçÂèëÈÄÅÊñ≠ÂºÄËøûÊé•ÈÄöÁü•
            if (!event.persisted) {
                notifyDisconnect();
            }
        });
        
    </script>
</body>
</html>