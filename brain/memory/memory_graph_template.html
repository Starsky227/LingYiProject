<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è®°å¿†å›¾è°±å¯è§†åŒ–</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 10px;
            text-align: center;
        }
        
        .container {
            display: flex;
            height: calc(100vh - 50px);
        }
        
        .sidebar {
            width: 280px;
            background: white;
            padding: 15px;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            overflow-y: auto;
        }
        
        .menu-bar {
            flex: 1;
            position: relative;
        }
        
        #graph-container {
            width: 100%;
            height: 100%;
            background: white;
        }
        
        .stat-card {
            background: #f8f9fa;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 12px;
            border-left: 3px solid #667eea;
        }
        
        .stat-title {
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }
        
        .stat-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 14px;
        }
        
        .node-details {
            background: #fff;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            border: 1px solid #e0e0e0;
            display: none;
        }
        
        .detail-title {
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
            border-bottom: 1px solid #e0e0e0;
            padding-bottom: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .detail-title .close-detail-btn {
            background: none;
            border: none;
            color: #999;
            cursor: pointer;
            font-size: 18px;
            padding: 0;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        
        .detail-title .close-detail-btn:hover {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
        }
        
        .property-item {
            margin-bottom: 8px;
            font-size: 13px;
        }
        
        .property-key {
            font-weight: bold;
            color: #555;
        }
        
        .property-value {
            color: #777;
            margin-left: 10px;
        }
        
        .node {
            cursor: pointer;
        }
        
        .node:hover {
            stroke: #333 !important;
            stroke-width: 4px !important;
        }
        
        .link {
            /* strokeé¢œè‰²ç”±JavaScriptåŠ¨æ€è®¾ç½®ï¼Œä¸åœ¨CSSä¸­å›ºå®š */
            stroke-opacity: 0.5;
            stroke-width: 2px;
        }
        
        .link:hover {
            /* hoveræ—¶åŠ ç²—æ˜¾ç¤ºï¼Œä¿æŒåŸæœ‰é¢œè‰² */
            stroke-opacity: 0.8;
            stroke-width: 2px;
        }
        
        .node-label {
            font-size: 11px;
            text-anchor: middle;
            pointer-events: none;
            fill: #333;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(255,255,255,0.8);
        }
        
        .link-label {
            font-size: 10px;
            text-anchor: middle;
            pointer-events: none;
            fill: #666;
            font-style: italic;
            background: rgba(255,255,255,0.8);
        }
        
        .controls {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .control-button {
            margin: 2px;
            padding: 5px 10px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .zoom-controls {
            background: #667eea;
            color: white;
        }
        
        .filter-controls {
            background: #28a745;
            color: white;
        }
        
        .edit-controls {
            background: #6f42c1;
            color: white;
        }
        
        .refresh-controls {
            background: #fd7e14;
            color: white;
        }
        
        .refresh-controls:hover {
            background: #e8590c;
        }
        
        .edit-controls:disabled {
            background: #cccccc;
            color: #666666;
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        .legend {
            position: absolute;
            top: 60px;
            left: 10px;
            background: rgba(255, 255, 255, 0.9);
            padding: 8px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            font-size: 11px;
            max-width: 120px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 3px;
        }
        
        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        /* èŠ‚ç‚¹ç¼–è¾‘é¢æ¿æ ·å¼ */
        .edit-panel {
            position: fixed;
            top: 0;
            right: -400px;
            width: 380px;
            height: 100vh;
            background: white;
            box-shadow: -2px 0 10px rgba(0,0,0,0.3);
            z-index: 1000;
            transition: right 0.3s ease;
            overflow-y: auto;
        }
        
        .edit-panel.show {
            right: 0;
        }
        
        /* èŠ‚ç‚¹åˆ›å»ºæ¨¡å¼ä¸‹çš„æ ·å¼ */
        .creating-node {
            cursor: crosshair !important;
        }
        
        .creating-node .graph-container {
            cursor: crosshair !important;
        }
        
        .edit-panel-header {
            background: #6f42c1;
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #5a2d91;
        }
        
        .edit-panel-header h3 {
            margin: 0;
            font-size: 18px;
        }
        
        .close-button {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .close-button:hover {
            background: rgba(255,255,255,0.2);
        }
        
        .edit-panel-content {
            padding: 20px;
        }
        
        .edit-buttons-row {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
        }
        
        .edit-function-button {
            flex: 1;
            padding: 12px 8px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            transition: all 0.2s ease;
            font-size: 12px;
            min-width: 0;
        }
        
        .edit-function-button:hover {
            border-color: #6f42c1;
            background: #f8f6ff;
            transform: translateY(-1px);
        }
        
        .edit-function-button.active {
            border-color: #6f42c1;
            background: #6f42c1;
            color: white;
        }
        
        .edit-function-button:disabled {
            background: #f5f5f5;
            color: #cccccc;
            border-color: #e0e0e0;
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        .edit-function-button:disabled:hover {
            background: #f5f5f5;
            border-color: #e0e0e0;
            transform: none;
        }
        
        .button-icon {
            font-size: 16px;
        }
        
        .button-text {
            font-weight: 500;
            font-size: 11px;
            text-align: center;
            white-space: nowrap;
        }
        
        .edit-forms {
            border-top: 1px solid #e0e0e0;
            padding-top: 20px;
            margin-top: 20px;
        }
        
        .edit-form {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
        }
        
        .edit-form h4 {
            margin: 0 0 15px 0;
            color: #333;
            font-size: 16px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
            font-size: 13px;
        }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 60px;
        }
        
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #6f42c1;
            box-shadow: 0 0 0 2px rgba(111, 66, 193, 0.1);
        }
        
        .warning-text {
            color: #dc3545;
            font-size: 13px;
            margin: 0;
            padding: 10px;
            background: #fff5f5;
            border: 1px solid #fed7d7;
            border-radius: 4px;
        }
        
        .form-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .action-btn {
            flex: 1;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        
        .confirm-btn {
            background: #28a745;
            color: white;
        }
        
        .confirm-btn:hover {
            background: #218838;
        }
        
        .danger-btn {
            background: #dc3545;
            color: white;
        }
        
        .danger-btn:hover {
            background: #c82333;
        }
        
        .cancel-btn {
            background: #6c757d;
            color: white;
        }
        
        .cancel-btn:hover {
            background: #5a6268;
        }
        
        /* èŠ‚ç‚¹ç±»å‹é€‰æ‹©æŒ‰é’®æ ·å¼ */
        .node-type-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }
        
        .node-type-button {
            flex: 1;
            padding: 15px 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            transition: all 0.2s ease;
            min-width: 0;
        }
        
        .node-type-button:hover {
            border-color: #4CAF50;
            background: #f8fff8;
            transform: translateY(-1px);
        }
        
        .node-type-button.selected {
            border-color: #4CAF50;
            background: #4CAF50;
            color: white;
        }
        
        .node-type-icon {
            font-size: 20px;
        }
        
        .node-type-text {
            font-weight: 500;
            font-size: 12px;
            text-align: center;
            white-space: nowrap;
        }
        
        /* æ—¶é—´èŠ‚ç‚¹è¡¨å•æ ·å¼ */
        .time-node-form {
            padding: 20px;
            background: #f9f9f9;
            border-radius: 8px;
            margin-top: 15px;
        }
        
        .time-node-form h4 {
            margin: 0 0 15px 0;
            color: #333;
            font-size: 16px;
        }
        
        /* å®ä½“èŠ‚ç‚¹è¡¨å•æ ·å¼ */
        .entity-node-form {
            padding: 20px;
            background: #f9f9f9;
            border-radius: 8px;
            margin-top: 15px;
        }
        
        .entity-node-form h4 {
            margin: 0 0 15px 0;
            color: #333;
            font-size: 16px;
        }
        
        /* è§’è‰²èŠ‚ç‚¹è¡¨å•æ ·å¼ */
        .character-node-form {
            padding: 20px;
            background: #f9f9f9;
            border-radius: 8px;
            margin-top: 15px;
        }
        
        .character-node-form h4 {
            margin: 0 0 15px 0;
            color: #333;
            font-size: 16px;
        }
        
        /* åœ°ç‚¹èŠ‚ç‚¹è¡¨å•æ ·å¼ */
        .location-node-form {
            padding: 20px;
            background: #f9f9f9;
            border-radius: 8px;
            margin-top: 15px;
        }
        
        .location-node-form h4 {
            margin: 0 0 15px 0;
            color: #333;
            font-size: 16px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
        }
        
        .time-input {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }
        
        .time-input:focus {
            border-color: #4CAF50;
            outline: none;
        }
        
        .time-format-help {
            margin-top: 10px;
            padding: 10px;
            background: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            font-size: 12px;
            color: #666;
        }
        
        .time-format-help ul {
            margin: 5px 0 0 0;
            padding-left: 20px;
        }
        
        .time-format-help li {
            margin: 2px 0;
        }
        
        .form-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 15px;
        }
        
        .create-btn, .cancel-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        
        .create-btn {
            background: #4CAF50;
            color: white;
        }
        
        .create-btn:hover {
            background: #45a049;
        }
        
        .create-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .cancel-btn {
            background: #f44336;
            color: white;
        }
        
        .cancel-btn:hover {
            background: #da190b;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ§  å¿ƒæ™ºäº‘å›¾</h1>
    </div>
    
    <div class="container">
        <div class="sidebar">
            <div class="stat-card">
                <div class="stat-title">ğŸ“Š å›¾è°±ç»Ÿè®¡</div>
                <div class="stat-item">
                    <span>èŠ‚ç‚¹æ€»æ•°:</span>
                    <span id="total-nodes">-</span>
                </div>
                <div class="stat-item">
                    <span>å…³ç³»æ€»æ•°:</span>
                    <span id="total-links">-</span>
                </div>
                <div class="stat-item">
                    <span>æ›´æ–°æ—¶é—´:</span>
                    <span id="updated-time">-</span>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-title">ğŸ·ï¸ èŠ‚ç‚¹ç±»å‹</div>
                <div id="node-types"></div>
            </div>
            
            <div class="stat-card">
                <div class="stat-title">ğŸ”— å…³ç³»ç±»å‹</div>
                <div id="relation-types"></div>
            </div>
            
            <div class="node-details" id="node-details">
                <div class="detail-title" id="detail-title">
                    <span>èŠ‚ç‚¹è¯¦æƒ…</span>
                    <button class="close-detail-btn" onclick="closeNodeDetails()">Ã—</button>
                </div>
                <div id="node-properties"></div>
            </div>
        </div>
        
        <div class="menu-bar">
            <svg id="graph-container"></svg>
            
            <div class="controls">
                <button class="control-button refresh-controls" onclick="smartRefresh()">ğŸ”„ åˆ·æ–°</button>
                <button class="control-button zoom-controls" onclick="resetZoom()">é‡ç½®</button>
                <button class="control-button filter-controls" onclick="toggleNodeLabels()">èŠ‚ç‚¹æ ‡ç­¾</button>
                <button class="control-button filter-controls" onclick="toggleLinkLabels()">å…³ç³»æ ‡ç­¾</button>
                <button class="control-button edit-controls" id="edit-button">èŠ‚ç‚¹ç¼–è¾‘</button>
            </div>
            
            <div class="legend">
                <div style="font-weight: bold; margin-bottom: 6px; border-bottom: 1px solid #ccc; padding-bottom: 2px; font-size: 10px;">èŠ‚ç‚¹ç±»å‹</div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #FF9800; width: 10px; height: 10px; margin-right: 6px;"></div>
                    <span style="font-size: 10px;">åœ°ç‚¹</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #2196F3; width: 10px; height: 10px; margin-right: 6px;"></div>
                    <span style="font-size: 10px;">è§’è‰²</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #FFD700; width: 10px; height: 10px; margin-right: 6px;"></div>
                    <span style="font-size: 10px;">å®ä½“</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #4CAF50; width: 10px; height: 10px; margin-right: 6px;"></div>
                    <span style="font-size: 10px;">æ—¶é—´</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #9E9E9E; width: 10px; height: 10px; margin-right: 6px;"></div>
                    <span style="font-size: 10px;">å…¶ä»–</span>
                </div>
                
                <div style="font-weight: bold; margin: 8px 0 6px 0; border-bottom: 1px solid #ccc; padding-bottom: 2px; font-size: 10px;">æ•°æ®ä½ç½®</div>
                <div class="legend-item">
                    <div style="width: 8px; height: 8px; border: 2px solid #808080; border-radius: 50%; margin-right: 6px; background-color: #f0f0f0;"></div>
                    <span style="font-size: 10px;">æœ¬åœ°</span>
                </div>
                <div class="legend-item">
                    <div style="width: 8px; height: 8px; border: 2px solid #00FF00; border-radius: 50%; margin-right: 6px; background-color: #f0f0f0;"></div>
                    <span style="font-size: 10px;">Neo4j</span>
                </div>
                <div class="legend-item">
                    <div style="width: 8px; height: 8px; border: 2px solid #0066FF; border-radius: 50%; margin-right: 6px; background-color: #f0f0f0;"></div>
                    <span style="font-size: 10px;">åŒæº</span>
                </div>
            </div>
        </div>
        
        <!-- èŠ‚ç‚¹ç¼–è¾‘é¢æ¿ -->
        <div class="edit-panel" id="edit-panel">
            <div class="edit-panel-header">
                <h3>èŠ‚ç‚¹ç¼–è¾‘</h3>
                <button class="close-button" onclick="toggleEditPanel()">Ã—</button>
            </div>
            <div class="edit-panel-content">
                <div class="edit-buttons-row">
                    <button class="edit-function-button add-node-btn" onclick="showAddNodeForm()">
                        <span class="button-icon">â•</span>
                        <span class="button-text">æ·»åŠ </span>
                    </button>
                    <button class="edit-function-button modify-node-btn" onclick="showModifyNodeForm()">
                        <span class="button-icon">âœï¸</span>
                        <span class="button-text">ç¼–è¾‘</span>
                    </button>
                    <button class="edit-function-button link-node-btn" onclick="showLinkNodeForm()">
                        <span class="button-icon">ğŸ”—</span>
                        <span class="button-text">é“¾æ¥</span>
                    </button>
                    <button class="edit-function-button delete-node-btn" onclick="showDeleteNodeForm()">
                        <span class="button-icon">ğŸ—‘ï¸</span>
                        <span class="button-text">åˆ é™¤</span>
                    </button>
                    <button class="edit-function-button quintuple-btn" onclick="showQuintupleForm()">
                        <span class="button-icon">ğŸŒ</span>
                        <span class="button-text">äº”å…ƒç»„</span>
                    </button>
                </div>
            </div>
            
            <!-- åŠŸèƒ½è¡¨å•åŒºåŸŸ -->
            <div class="edit-forms">
            </div>
        </div>
    </div>

    <script>
        // å­˜å‚¨ç±»å‹é¢œè‰²é…ç½®å¸¸é‡
        const STORAGE_TYPE_COLORS = {
            local: '#856404',    // é»„è‰²ï¼ˆä»…æœ¬åœ°ï¼‰
            neo4j: '#155724',    // ç»¿è‰²ï¼ˆä»…Neo4jï¼‰
            both: '#0c5460'      // è“è‰²ï¼ˆæœ¬åœ°+Neo4jï¼‰
        };
        
        // è·å–å­˜å‚¨ç±»å‹å¯¹åº”çš„é¢œè‰²
        function getStorageTypeColor(sourceType) {
            return STORAGE_TYPE_COLORS[sourceType] || STORAGE_TYPE_COLORS.neo4j;
        }
        
        // è·å–å­˜å‚¨ç±»å‹å¯¹åº”çš„ç®­å¤´æ ‡è®°ID
        function getStorageTypeArrow(sourceType) {
            return `url(#arrow-${sourceType || 'neo4j'})`;
        }
        
        // è·å–UIä¸­æ•°æ®ä½ç½®æŒ‡ç¤ºå™¨çš„èƒŒæ™¯è‰²
        function getStorageUIBackground(sourceText) {
            if (sourceText === 'ä»…Neo4j' || sourceText === 'Neo4j') {
                return '#d4edda';
            } else if (sourceText === 'ä»…æœ¬åœ°') {
                return '#fff3cd';
            } else {
                return '#d1ecf1';
            }
        }
        
        // è·å–UIä¸­æ•°æ®ä½ç½®æŒ‡ç¤ºå™¨çš„æ–‡å­—é¢œè‰²
        function getStorageUIColor(sourceText) {
            if (sourceText === 'ä»…Neo4j' || sourceText === 'Neo4j') {
                return STORAGE_TYPE_COLORS.neo4j;
            } else if (sourceText === 'ä»…æœ¬åœ°') {
                return STORAGE_TYPE_COLORS.local;
            } else {
                return STORAGE_TYPE_COLORS.both;
            }
        }
        
        // æ’é™¤åœ¨ç¼–è¾‘è¡¨å•ä¸­æ˜¾ç¤ºå’Œæ”¶é›†çš„ç³»ç»Ÿå±æ€§
        const EXCLUDED_PROPERTIES = ['significance', 'name', 'created_at', 'last_updated', 'node_type'];
        
        // å›¾è°±æ•°æ®å ä½ç¬¦
        const graphData = {{GRAPH_DATA}};
        
        // å…¨å±€å˜é‡è·Ÿè¸ªæœ€è¿‘é€‰ä¸­çš„é¡¹ç›®åˆ—è¡¨ï¼ˆèŠ‚ç‚¹å’Œå…³ç³»ï¼‰ï¼Œæœ€å¤šä¿ç•™10ä¸ª
        let recentSelectedNodes = [];
        
        // åˆ é™¤æ¨¡å¼çŠ¶æ€å˜é‡
        let deleteMode = false;
        
        // è®¾ç½®ç”»å¸ƒ
        const svg = d3.select("#graph-container");
        const width = svg.node().getBoundingClientRect().width;
        const height = svg.node().getBoundingClientRect().height;
        
        svg.attr("width", width).attr("height", height);
        
        // åˆ›å»ºç¼©æ”¾è¡Œä¸º
        const zoom = d3.zoom()
            .scaleExtent([0.1, 3])
            .on("zoom", function(event) {
                container.attr("transform", event.transform);
            });
        
        svg.call(zoom);
        
        // åˆ›å»ºå®¹å™¨ç»„
        const container = svg.append("g");
        
        // åˆ›å»ºåŠ›å¯¼å‘å›¾
        const simulation = d3.forceSimulation(graphData.nodes)
            .force("link", d3.forceLink(graphData.links).id(d => d.id).distance(100))
            .force("charge", d3.forceManyBody().strength(-300))
            .force("center", d3.forceCenter(width / 2, height / 2))
            .force("collision", d3.forceCollide().radius(d => d.size + 5));
        
        // åˆ›å»ºç®­å¤´æ ‡è®°ï¼ˆä¸ºä¸åŒå­˜å‚¨ä½ç½®åˆ›å»ºä¸åŒé¢œè‰²çš„ç®­å¤´ï¼‰
        const defs = container.append("defs");
        
        // åˆ›å»ºå­˜å‚¨ç±»å‹ç®­å¤´æ ‡è®°ï¼ˆä½¿ç”¨å¸¸é‡é¢œè‰²ï¼‰
        Object.keys(STORAGE_TYPE_COLORS).forEach(storageType => {
            defs.append("marker")
                .attr("id", `arrow-${storageType}`)
                .attr("viewBox", "0 -5 10 10")
                .attr("refX", 25)
                .attr("refY", 0)
                .attr("markerWidth", 4)
                .attr("markerHeight", 4)
                .attr("orient", "auto")
                .append("path")
                .attr("d", "M0,-5L10,0L0,5")
                .attr("fill", STORAGE_TYPE_COLORS[storageType]);
        });
        
        // æ£€æµ‹åŒå‘å…³ç³»å¹¶è®¾ç½®åç§»
        function detectBidirectionalLinks(links) {
            const linkPairs = new Map();
            
            // ä¸ºæ¯ä¸ªè¿æ¥åˆ›å»ºæ ‡è¯†ç¬¦ï¼Œæ£€æµ‹åŒå‘å…³ç³»
            links.forEach((link, index) => {
                const sourceId = link.source.id || link.source;
                const targetId = link.target.id || link.target;
                const pairKey1 = `${sourceId}-${targetId}`;
                const pairKey2 = `${targetId}-${sourceId}`;
                
                // æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰åå‘è¿æ¥
                if (linkPairs.has(pairKey2)) {
                    // å‘ç°åŒå‘å…³ç³»
                    const reverseLink = linkPairs.get(pairKey2);
                    
                    // è®¾ç½®åç§»æ ‡è¯†
                    link.isBidirectional = true;
                    link.offsetDirection = 1; // æ­£åç§»
                    reverseLink.isBidirectional = true;
                    reverseLink.offsetDirection = 1; // è´Ÿåç§»
                    
                    console.log('æ£€æµ‹åˆ°åŒå‘å…³ç³»:', sourceId, '<->', targetId);
                } else {
                    linkPairs.set(pairKey1, link);
                    link.isBidirectional = false;
                    link.offsetDirection = 0; // æ— åç§»
                }
            });
            
            return links;
        }
        
        // è®¡ç®—åç§»åçš„è¿çº¿ä½ç½®
        function calculateOffsetPosition(source, target, offset = 10, direction = 0) {
            if (direction === 0) {
                // æ— åç§»ï¼Œè¿”å›åŸå§‹ä½ç½®
                return { x1: source.x, y1: source.y, x2: target.x, y2: target.y };
            }
            
            // è®¡ç®—è¿çº¿çš„å‚ç›´å‘é‡ç”¨äºåç§»
            const dx = target.x - source.x;
            const dy = target.y - source.y;
            const length = Math.sqrt(dx * dx + dy * dy);
            
            if (length === 0) {
                return { x1: source.x, y1: source.y, x2: target.x, y2: target.y };
            }
            
            // å‚ç›´å‘é‡ï¼ˆé€†æ—¶é’ˆæ—‹è½¬90åº¦ï¼‰
            const perpX = -dy / length * offset * direction;
            const perpY = dx / length * offset * direction;
            
            return {
                x1: source.x + perpX,
                y1: source.y + perpY,
                x2: target.x + perpX,
                y2: target.y + perpY
            };
        }
        
        // å¤„ç†åŒå‘å…³ç³»
        detectBidirectionalLinks(graphData.links);
        
        // åˆ›å»ºé“¾æ¥
        let link = container.append("g")
            .selectAll("line")
            .data(graphData.links)
            .enter().append("line")
            .attr("class", "link")
            .attr("marker-end", d => getStorageTypeArrow(d.source_type))
            .attr("stroke", d => {
                // è°ƒè¯•ï¼šæ‰“å°å…³ç³»çš„source_type
                console.log('å…³ç³»é¢œè‰²è®¾ç½® - ID:', d.neo4j_id, 'Type:', d.type, 'Source_type:', d.source_type);
                
                // æ ¹æ®å­˜å‚¨ä½ç½®è®¾ç½®é¢œè‰²ï¼ˆä½¿ç”¨ç»Ÿä¸€çš„é¢œè‰²å‡½æ•°ï¼‰
                if (!d.source_type || !STORAGE_TYPE_COLORS[d.source_type]) {
                    console.warn('å…³ç³»æœªçŸ¥å­˜å‚¨ä½ç½®:', d.source_type, 'å…³ç³»:', d);
                }
                return getStorageTypeColor(d.source_type);
            })
            .attr("stroke-width", "2")
            .on("click", showLinkDetails);
        
        // åˆ›å»ºèŠ‚ç‚¹
        let node = container.append("g")
            .selectAll("circle")
            .data(graphData.nodes)
            .enter().append("circle")
            .attr("class", "node")
            .attr("r", d => d.size)
            .attr("fill", d => d.color)
            .attr("stroke", d => d.strokeColor)
            .attr("stroke-width", d => d.strokeWidth)
            .on("click", showNodeDetails)
            .call(d3.drag()
                .on("start", dragstarted)
                .on("drag", dragged)
                .on("end", dragended));
        
        // åˆ›å»ºèŠ‚ç‚¹æ ‡ç­¾ï¼ˆæ˜¾ç¤ºåœ¨èŠ‚ç‚¹ä¸Šï¼‰
        let nodeLabels = container.append("g")
            .selectAll("text")
            .data(graphData.nodes)
            .enter().append("text")
            .attr("class", "node-label")
            .text(d => d.label.length > 8 ? d.label.substring(0, 8) + "..." : d.label)
            .style("display", "block");
        
        // åˆ›å»ºå…³ç³»æ ‡ç­¾èƒŒæ™¯
        let linkLabelBgs = container.append("g")
            .selectAll("rect")
            .data(graphData.links)
            .enter().append("rect")
            .attr("class", "link-label-bg")
            .attr("fill", "rgba(255,255,255,0.8)")
            .attr("stroke", "rgba(200,200,200,0.5)")
            .attr("stroke-width", 0.5)
            .attr("rx", 3)
            .attr("ry", 3);
        
        // åˆ›å»ºå…³ç³»æ ‡ç­¾ï¼ˆæ˜¾ç¤ºåœ¨è¿æ¥çº¿ä¸Šï¼‰
        let linkLabels = container.append("g")
            .selectAll("text")
            .data(graphData.links)
            .enter().append("text")
            .attr("class", "link-label")
            .text(d => {
                // æ˜¾ç¤ºå…³ç³»ç±»å‹ï¼šä¼˜å…ˆæ˜¾ç¤ºpredicate > action > type
                if (d.properties && d.properties.predicate) {
                    return d.properties.predicate;
                } else if (d.properties && d.properties.action) {
                    return d.properties.action;
                } else {
                    return d.type;
                }
            })
            .style("display", "block");
        
        // æ›´æ–°ä½ç½®
        simulation.on("tick", () => {
            // æ›´æ–°è¿çº¿ä½ç½®ï¼ˆæ”¯æŒåŒå‘å…³ç³»åç§»ï¼‰
            link.each(function(d) {
                const offset = d.isBidirectional ? calculateOffsetPosition(d.source, d.target, 8, d.offsetDirection) : 
                              { x1: d.source.x, y1: d.source.y, x2: d.target.x, y2: d.target.y };
                
                d3.select(this)
                    .attr("x1", offset.x1)
                    .attr("y1", offset.y1)
                    .attr("x2", offset.x2)
                    .attr("y2", offset.y2);
            });
            
            node
                .attr("cx", d => d.x)
                .attr("cy", d => d.y);
            
            // èŠ‚ç‚¹æ ‡ç­¾è·ŸéšèŠ‚ç‚¹
            nodeLabels
                .attr("x", d => d.x)
                .attr("y", d => d.y + 4); // ç¨å¾®å‘ä¸‹åç§»ï¼Œè®©æ–‡å­—åœ¨èŠ‚ç‚¹ä¸­å¿ƒåä¸‹
            
            // å…³ç³»æ ‡ç­¾æ˜¾ç¤ºåœ¨è¿æ¥çº¿çš„ä¸­ç‚¹ï¼ˆæ”¯æŒåŒå‘å…³ç³»åç§»ï¼‰
            linkLabels.each(function(d) {
                let labelX, labelY;
                
                if (d.isBidirectional) {
                    const offset = calculateOffsetPosition(d.source, d.target, 8, d.offsetDirection);
                    labelX = (offset.x1 + offset.x2) / 2;
                    labelY = (offset.y1 + offset.y2) / 2 - 5;
                } else {
                    labelX = (d.source.x + d.target.x) / 2;
                    labelY = (d.source.y + d.target.y) / 2 - 5;
                }
                
                d3.select(this)
                    .attr("x", labelX)
                    .attr("y", labelY);
            });
            
            // å…³ç³»æ ‡ç­¾èƒŒæ™¯è·Ÿéšæ ‡ç­¾ä½ç½®
            linkLabelBgs.each(function(d) {
                const text = linkLabels.filter(data => data === d).node();
                if (text) {
                    const bbox = text.getBBox();
                    d3.select(this)
                        .attr("x", bbox.x - 2)
                        .attr("y", bbox.y - 1)
                        .attr("width", bbox.width + 4)
                        .attr("height", bbox.height + 2);
                }
            });
        });
        
        // æ‹–æ‹½å‡½æ•°
        function dragstarted(event, d) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            d.fx = d.x;
            d.fy = d.y;
        }
        
        function dragged(event, d) {
            d.fx = event.x;
            d.fy = event.y;
        }
        
        function dragended(event, d) {
            if (!event.active) simulation.alphaTarget(0);
            d.fx = null;
            d.fy = null;
        }
        
        // æ˜¾ç¤ºèŠ‚ç‚¹è¯¦æƒ…
        function showNodeDetails(event, d) {
            const detailsDiv = document.getElementById("node-details");
            const propertiesDiv = document.getElementById("node-properties");
            const titleDiv = document.getElementById("detail-title");
            
            detailsDiv.style.display = "block";
            titleDiv.querySelector('span').textContent = "èŠ‚ç‚¹è¯¦æƒ…";
            
            // è·Ÿè¸ªé€‰ä¸­çš„èŠ‚ç‚¹
            const selectedItemData = {
                type: 'node',
                data: d,
                elementId: d.neo4j_id
            };
            
            // æ›´æ–°æœ€è¿‘é€‰ä¸­çš„é¡¹ç›®åˆ—è¡¨
            updateRecentSelectedNodes(selectedItemData);
            
            // å¦‚æœåˆ é™¤ç•Œé¢å·²æ‰“å¼€ï¼Œå®æ—¶æ›´æ–°åˆ é™¤å†…å®¹
            updateDeleteFormIfVisible();
            
            // å¦‚æœä¿®æ”¹ç•Œé¢å·²æ‰“å¼€ï¼Œå®æ—¶æ›´æ–°ä¿®æ”¹å†…å®¹
            updateModifyFormIfVisible();
            
            // å¦‚æœé“¾æ¥ç•Œé¢å·²æ‰“å¼€ï¼Œå®æ—¶æ›´æ–°é“¾æ¥å†…å®¹
            updateLinkFormIfVisible();
            
            let sourceText = '';
            if (d.source === 'local') {
                sourceText = 'ä»…æœ¬åœ°';
            } else if (d.source === 'neo4j') {
                sourceText = 'ä»…Neo4j';
            } else if (d.source === 'both') {
                sourceText = 'æœ¬åœ°+Neo4j';
            } else {
                sourceText = 'æœªçŸ¥';
            }
            
            let html = `
                <div class="property-item">
                    <span class="property-key">èŠ‚ç‚¹ID:</span>
                    <span class="property-value">${d.neo4j_id}</span>
                </div>
                <div class="property-item">
                    <span class="property-key">æ•°æ®ä½ç½®:</span>
                    <span class="property-value">${sourceText}</span>
                </div>
                <div class="property-item">
                    <span class="property-key">æ ‡ç­¾:</span>
                    <span class="property-value">${d.labels.join(", ")}</span>
                </div>
                <div class="property-item">
                    <span class="property-key">åç§°:</span>
                    <span class="property-value">${d.label}</span>
                </div>
            `;
            
            // æ˜¾ç¤ºæ‰€æœ‰å±æ€§
            for (const [key, value] of Object.entries(d.properties)) {
                html += `
                    <div class="property-item">
                        <span class="property-key">${key}:</span>
                        <span class="property-value">${JSON.stringify(value)}</span>
                    </div>
                `;
            }
            
            propertiesDiv.innerHTML = html;
        }
        
        // æ˜¾ç¤ºå…³ç³»è¯¦æƒ…
        function showLinkDetails(event, d) {
            console.log('æ˜¾ç¤ºå…³ç³»è¯¦æƒ… - åŸå§‹æ•°æ®:', d);
            console.log('å…³ç³»source_type:', d.source_type);
            
            // æ£€æŸ¥æ˜¯å¦æœ‰å¤šä¸ªåŒå‘å…³ç³»
            const sameDirectionLinks = graphData.links.filter(link => 
                (link.source.id === d.source.id && link.target.id === d.target.id) ||
                (link.source.id === d.target.id && link.target.id === d.source.id)
            );
            
            if (sameDirectionLinks.length > 1) {
                // æœ‰å¤šä¸ªåŒå‘å…³ç³»ï¼Œæ˜¾ç¤ºé€‰æ‹©æ¡†
                showMultiRelationSelector(event, sameDirectionLinks);
                return;
            }
            
            // åªæœ‰ä¸€ä¸ªå…³ç³»ï¼Œç›´æ¥æ˜¾ç¤ºè¯¦æƒ…
            showSingleRelationDetails(d);
        }
        
        // æ˜¾ç¤ºå¤šå…³ç³»é€‰æ‹©æ¡†
        function showMultiRelationSelector(event, relations) {
            // ç§»é™¤å·²å­˜åœ¨çš„é€‰æ‹©æ¡†
            d3.select('.multi-relation-selector').remove();
            
            const mouseX = event.pageX;
            const mouseY = event.pageY;
            
            // åˆ›å»ºé€‰æ‹©æ¡†å®¹å™¨
            const selectorDiv = d3.select('body')
                .append('div')
                .attr('class', 'multi-relation-selector')
                .style('position', 'fixed')
                .style('left', Math.min(mouseX + 10, window.innerWidth - 420) + 'px')
                .style('top', Math.min(mouseY - 10, window.innerHeight - 320) + 'px')
                .style('background', '#fff')
                .style('border', '2px solid #007bff')
                .style('border-radius', '8px')
                .style('box-shadow', '0 4px 12px rgba(0,0,0,0.3)')
                .style('z-index', '10000')
                .style('min-width', '300px')
                .style('max-width', '400px')
                .style('max-height', '300px')
                .style('overflow-y', 'auto')
                .style('font-family', 'Arial, sans-serif');
            
            // æ·»åŠ æ ‡é¢˜æ 
            const headerDiv = selectorDiv.append('div')
                .style('background', '#f8f9fa')
                .style('padding', '8px 12px')
                .style('border-bottom', '1px solid #dee2e6')
                .style('display', 'flex')
                .style('justify-content', 'space-between')
                .style('align-items', 'center');
            
            headerDiv.append('span')
                .style('font-weight', 'bold')
                .style('font-size', '14px')
                .style('color', '#495057')
                .text(`é€‰æ‹©å…³ç³» (${relations.length}ä¸ª)`);
            
            // æ·»åŠ å…³é—­æŒ‰é’®
            headerDiv.append('button')
                .style('background', 'none')
                .style('border', 'none')
                .style('font-size', '18px')
                .style('color', '#6c757d')
                .style('cursor', 'pointer')
                .style('padding', '0')
                .style('width', '24px')
                .style('height', '24px')
                .style('display', 'flex')
                .style('align-items', 'center')
                .style('justify-content', 'center')
                .text('Ã—')
                .on('click', function(event) {
                    event.stopPropagation();
                    closeMutliRelationSelector();
                })
                .on('mouseover', function() {
                    d3.select(this).style('background', '#e9ecef').style('border-radius', '4px');
                })
                .on('mouseout', function() {
                    d3.select(this).style('background', 'none');
                });
            
            // æ·»åŠ å…³ç³»åˆ—è¡¨
            const listDiv = selectorDiv.append('div')
                .style('padding', '8px 0');
            
            relations.forEach((relation, index) => {
                const relationDiv = listDiv.append('div')
                    .style('padding', '8px 12px')
                    .style('cursor', 'pointer')
                    .style('border-bottom', index < relations.length - 1 ? '1px solid #f1f3f4' : 'none')
                    .style('display', 'flex')
                    .style('flex-direction', 'column')
                    .style('transition', 'background-color 0.2s')
                    .on('click', function(event) {
                        event.stopPropagation();
                        selectRelationFromList(relation);
                    })
                    .on('mouseover', function() {
                        d3.select(this).style('background', '#f8f9fa');
                        // é«˜äº®å¯¹åº”çš„å…³ç³»çº¿
                        highlightRelation(relation, true);
                    })
                    .on('mouseout', function() {
                        d3.select(this).style('background', '#fff');
                        // å–æ¶ˆé«˜äº®
                        highlightRelation(relation, false);
                    });
                
                // å…³ç³»ç±»å‹å’Œæ–¹å‘
                const typeDiv = relationDiv.append('div')
                    .style('font-weight', 'bold')
                    .style('color', '#495057')
                    .style('margin-bottom', '4px')
                    .style('font-size', '14px');
                
                const sourceNode = graphData.nodes.find(n => n.id === relation.source.id);
                const targetNode = graphData.nodes.find(n => n.id === relation.target.id);
                
                let directionIcon = 'â†’';
                if (relation.properties?.directivity === 'bidirectional') {
                    directionIcon = 'â†”';
                } else if (relation.properties?.directivity === 'to_startNode') {
                    directionIcon = 'â†';
                }
                
                typeDiv.text(`${relation.type} (${sourceNode?.label || 'Unknown'} ${directionIcon} ${targetNode?.label || 'Unknown'})`);
                
                // å…³ç³»è¯¦ç»†ä¿¡æ¯
                const detailsDiv = relationDiv.append('div')
                    .style('font-size', '12px')
                    .style('color', '#6c757d');
                
                let details = [];
                if (relation.properties?.source) {
                    details.push(`æ¥æº: ${relation.properties.source}`);
                }
                if (relation.properties?.confidence) {
                    const confidence = parseFloat(relation.properties.confidence);
                    details.push(`ç½®ä¿¡åº¦: ${(confidence * 100).toFixed(1)}%`);
                }
                if (relation.properties?.created_at) {
                    const date = new Date(relation.properties.created_at);
                    details.push(`åˆ›å»º: ${date.toLocaleDateString()}`);
                }
                
                if (details.length > 0) {
                    detailsDiv.text(details.join(' â€¢ '));
                }
            });
            
            // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­é€‰æ‹©æ¡†
            setTimeout(() => {
                d3.select('body').on('click.multiRelationSelector', function(event) {
                    if (!event.target.closest('.multi-relation-selector')) {
                        closeMutliRelationSelector();
                    }
                });
            }, 100);
            
            // ESCé”®å…³é—­é€‰æ‹©æ¡†
            d3.select('body').on('keydown.multiRelationSelector', function(event) {
                if (event.key === 'Escape') {
                    closeMutliRelationSelector();
                }
            });
        }
        
        // å…³é—­å¤šå…³ç³»é€‰æ‹©æ¡†
        function closeMutliRelationSelector() {
            d3.select('.multi-relation-selector').remove();
            d3.select('body').on('click.multiRelationSelector', null);
            d3.select('body').on('keydown.multiRelationSelector', null);
            // å–æ¶ˆæ‰€æœ‰å…³ç³»çš„é«˜äº®
            container.selectAll('.link')
                .style('stroke-width', function(d) { return d.properties?.directivity === 'bidirectional' ? '3px' : '2px'; })
                .style('stroke', null);
        }
        
        // ä»åˆ—è¡¨ä¸­é€‰æ‹©å…³ç³»
        function selectRelationFromList(relation) {
            // å…³é—­é€‰æ‹©æ¡†
            closeMutliRelationSelector();
            
            // æ˜¾ç¤ºé€‰ä¸­å…³ç³»çš„è¯¦æƒ…
            showSingleRelationDetails(relation);
        }
        
        // é«˜äº®/å–æ¶ˆé«˜äº®å…³ç³»
        function highlightRelation(relation, highlight) {
            container.selectAll('.link')
                .filter(d => d === relation)
                .style('stroke-width', highlight ? '5px' : function(d) { return d.properties?.directivity === 'bidirectional' ? '3px' : '2px'; })
                .style('stroke', highlight ? '#ff6b6b' : null);
        }
        
        // æ˜¾ç¤ºå•ä¸ªå…³ç³»è¯¦æƒ…
        function showSingleRelationDetails(d) {
            const detailsDiv = document.getElementById("node-details");
            const propertiesDiv = document.getElementById("node-properties");
            const titleDiv = document.getElementById("detail-title");
            
            detailsDiv.style.display = "block";
            titleDiv.querySelector('span').textContent = "å…³ç³»è¯¦æƒ…";
            
            // è·Ÿè¸ªé€‰ä¸­çš„å…³ç³»
            const selectedItemData = {
                type: 'relationship',
                data: d,
                elementId: d.neo4j_id
            };
            
            // æ›´æ–°æœ€è¿‘é€‰ä¸­çš„é¡¹ç›®åˆ—è¡¨
            updateRecentSelectedNodes(selectedItemData);
            
            // å¦‚æœåˆ é™¤ç•Œé¢å·²æ‰“å¼€ï¼Œå®æ—¶æ›´æ–°åˆ é™¤å†…å®¹
            updateDeleteFormIfVisible();
            
            // å¦‚æœä¿®æ”¹ç•Œé¢å·²æ‰“å¼€ï¼Œå®æ—¶æ›´æ–°ä¿®æ”¹å†…å®¹
            updateModifyFormIfVisible();
            
            // å¦‚æœé“¾æ¥ç•Œé¢å·²æ‰“å¼€ï¼Œå®æ—¶æ›´æ–°é“¾æ¥å†…å®¹
            updateLinkFormIfVisible();
            
            // è·å–èµ·å§‹å’Œç›®æ ‡èŠ‚ç‚¹çš„åç§°
            const sourceNode = graphData.nodes.find(node => node.id === d.source.id);
            const targetNode = graphData.nodes.find(node => node.id === d.target.id);
            
            // ç¡®å®šå­˜å‚¨ä½ç½®æ–‡æœ¬
            let sourceText = '';
            if (d.source_type === 'local') {
                sourceText = 'ä»…æœ¬åœ°';
            } else if (d.source_type === 'neo4j') {
                sourceText = 'ä»…Neo4j';
            } else if (d.source_type === 'both') {
                sourceText = 'æœ¬åœ°+Neo4j';
            } else {
                sourceText = 'æœªçŸ¥';
            }
            
            let html = `
                <div class="property-item">
                    <span class="property-key">å…³ç³»ID:</span>
                    <span class="property-value">${d.neo4j_id}</span>
                </div>
                <div class="property-item">
                    <span class="property-key">æ•°æ®ä½ç½®:</span>
                    <span class="property-value">${sourceText}</span>
                </div>
                <div class="property-item">
                    <span class="property-key">å…³ç³»ç±»å‹:</span>
                    <span class="property-value">${d.type}</span>
                </div>
                <div class="property-item">
                    <span class="property-key">èµ·å§‹èŠ‚ç‚¹:</span>
                    <span class="property-value">${sourceNode ? sourceNode.label : 'Unknown'}</span>
                </div>
                <div class="property-item">
                    <span class="property-key">ç›®æ ‡èŠ‚ç‚¹:</span>
                    <span class="property-value">${targetNode ? targetNode.label : 'Unknown'}</span>
                </div>
            `;
            
            // æ˜¾ç¤ºæ‰€æœ‰å…³ç³»å±æ€§
            for (const [key, value] of Object.entries(d.properties)) {
                html += `
                    <div class="property-item">
                        <span class="property-key">${key}:</span>
                        <span class="property-value">${JSON.stringify(value)}</span>
                    </div>
                `;
            }
            
            propertiesDiv.innerHTML = html;
        }
        
        // æ§åˆ¶å‡½æ•°
        function resetZoom() {
            svg.transition().call(zoom.transform, d3.zoomIdentity);
        }
        
        let nodeLabelsVisible = true;
        let linkLabelsVisible = true;
        
        function toggleNodeLabels() {
            nodeLabelsVisible = !nodeLabelsVisible;
            nodeLabels.style("display", nodeLabelsVisible ? "block" : "none");
        }
        
        function toggleLinkLabels() {
            linkLabelsVisible = !linkLabelsVisible;
            linkLabels.style("display", linkLabelsVisible ? "block" : "none");
            linkLabelBgs.style("display", linkLabelsVisible ? "block" : "none");
        }
        
        // åŠ¨æ€æ›´æ–°å›¾è°±æ•°æ®ï¼ˆæ— éœ€é¡µé¢åˆ·æ–°ï¼‰
        function updateGraphData() {
            console.log('æ­£åœ¨åŠ¨æ€æ›´æ–°å›¾è°±æ•°æ®...');
            
            return fetch('/api/get_graph_data', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('å›¾è°±æ•°æ®æ›´æ–°æˆåŠŸ:', data.data);
                    
                    // æ›´æ–°å…¨å±€æ•°æ®
                    const newGraphData = data.data;
                    
                    // ä¿å­˜æ—§æ•°æ®ä»¥ä¾¿å¯¹æ¯”
                    const oldNodesCount = graphData.nodes.length;
                    const oldLinksCount = graphData.links.length;
                    
                    // æ›´æ–°graphData
                    graphData.nodes = newGraphData.nodes || [];
                    graphData.links = newGraphData.links || [];
                    graphData.stats = newGraphData.stats || graphData.stats;
                    
                    // æ›´æ–°å¯è§†åŒ–
                    updateVisualization();
                    
                    // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
                    updateStats(newGraphData.stats);
                    
                    // æ˜¾ç¤ºæ›´æ–°ä¿¡æ¯
                    const newNodesCount = graphData.nodes.length;
                    const newLinksCount = graphData.links.length;
                    const nodesDiff = newNodesCount - oldNodesCount;
                    const linksDiff = newLinksCount - oldLinksCount;
                    
                    if (nodesDiff !== 0 || linksDiff !== 0) {
                        console.log(`å›¾è°±å·²æ›´æ–°: èŠ‚ç‚¹å˜åŒ–${nodesDiff > 0 ? '+' : ''}${nodesDiff}, å…³ç³»å˜åŒ–${linksDiff > 0 ? '+' : ''}${linksDiff}`);
                    }
                    
                    return true;
                } else {
                    console.error('åŠ¨æ€æ›´æ–°å¤±è´¥:', data.error);
                    return false;
                }
            })
            .catch(error => {
                console.error('åŠ¨æ€æ›´æ–°é”™è¯¯:', error);
                return false;
            });
        }
        
        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯æ˜¾ç¤º
        function updateStats(stats) {
            if (!stats) return;
            
            document.getElementById("total-nodes").textContent = stats.total_nodes || 0;
            document.getElementById("total-links").textContent = stats.total_links || 0;
            document.getElementById("updated-time").textContent = new Date(stats.updated_at).toLocaleString();
            
            // æ›´æ–°èŠ‚ç‚¹ç±»å‹ç»Ÿè®¡
            const nodeTypesDiv = document.getElementById("node-types");
            let nodeTypesHtml = "";
            for (const [type, count] of Object.entries(stats.node_types || {})) {
                nodeTypesHtml += `
                    <div class="stat-item">
                        <span>${type}:</span>
                        <span>${count}</span>
                    </div>
                `;
            }
            nodeTypesDiv.innerHTML = nodeTypesHtml;
            
            // æ›´æ–°å…³ç³»ç±»å‹ç»Ÿè®¡
            const relationTypesDiv = document.getElementById("relation-types");
            let relationTypesHtml = "";
            for (const [type, count] of Object.entries(stats.relation_types || {})) {
                relationTypesHtml += `
                    <div class="stat-item">
                        <span>${type}:</span>
                        <span>${count}</span>
                    </div>
                `;
            }
            relationTypesDiv.innerHTML = relationTypesHtml;
        }
        
        // æ™ºèƒ½åˆ·æ–°ï¼šä¼˜å…ˆä½¿ç”¨åŠ¨æ€æ›´æ–°ï¼Œå¤±è´¥æ—¶ä½¿ç”¨é¡µé¢åˆ·æ–°
        function smartRefresh() {
            console.log('æ‰§è¡Œæ™ºèƒ½åˆ·æ–°...');
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const refreshBtn = document.querySelector('.refresh-controls');
            const originalText = refreshBtn.innerHTML;
            refreshBtn.innerHTML = 'â³ æ›´æ–°ä¸­...';
            refreshBtn.disabled = true;
            
            // å°è¯•åŠ¨æ€æ›´æ–°
            updateGraphData().then(success => {
                if (success) {
                    // åŠ¨æ€æ›´æ–°æˆåŠŸ
                    console.log('åŠ¨æ€æ›´æ–°æˆåŠŸ');
                    refreshBtn.innerHTML = 'âœ… å·²æ›´æ–°';
                    setTimeout(() => {
                        refreshBtn.innerHTML = originalText;
                        refreshBtn.disabled = false;
                    }, 2000);
                } else {
                    // åŠ¨æ€æ›´æ–°å¤±è´¥ï¼Œè¯¢é—®æ˜¯å¦é¡µé¢åˆ·æ–°
                    refreshBtn.innerHTML = originalText;
                    refreshBtn.disabled = false;
                    
                    if (confirm('åŠ¨æ€æ›´æ–°å¤±è´¥ï¼Œæ˜¯å¦é‡æ–°åŠ è½½é¡µé¢ä»¥è·å–æœ€æ–°æ•°æ®ï¼Ÿ\n\nç‚¹å‡»"ç¡®å®š"é‡æ–°åŠ è½½é¡µé¢\nç‚¹å‡»"å–æ¶ˆ"ä¿æŒå½“å‰çŠ¶æ€')) {
                        refreshData(); // ä½¿ç”¨é¡µé¢åˆ·æ–°
                    }
                }
            }).catch(error => {
                console.error('æ™ºèƒ½åˆ·æ–°å¤±è´¥:', error);
                refreshBtn.innerHTML = originalText;
                refreshBtn.disabled = false;
                
                if (confirm('å›¾è°±æ›´æ–°å¤±è´¥ï¼Œæ˜¯å¦é‡æ–°åŠ è½½é¡µé¢ï¼Ÿ\n\nç‚¹å‡»"ç¡®å®š"é‡æ–°åŠ è½½é¡µé¢\nç‚¹å‡»"å–æ¶ˆ"ä¿æŒå½“å‰çŠ¶æ€')) {
                    refreshData(); // ä½¿ç”¨é¡µé¢åˆ·æ–°
                }
            });
        }
        
        // åˆ·æ–°æ•°æ®åŠŸèƒ½ï¼ˆé¡µé¢é‡æ–°åŠ è½½æ–¹å¼ï¼‰
        function refreshData() {
            console.log('æ­£åœ¨åˆ·æ–°æ•°æ®...');
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const refreshBtn = document.querySelector('.refresh-controls');
            const originalText = refreshBtn.innerHTML;
            refreshBtn.innerHTML = 'â³ åˆ·æ–°ä¸­...';
            refreshBtn.disabled = true;
            
            fetch('/api/refresh_data', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                console.log('åˆ·æ–°ç»“æœ:', data);
                if (data.success) {
                    // é€šçŸ¥æœåŠ¡å™¨å³å°†åˆ·æ–°ï¼Œç„¶åé‡æ–°åŠ è½½é¡µé¢
                    notifyRefreshAndReload();
                } else {
                    alert('åˆ·æ–°å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                    refreshBtn.innerHTML = originalText;
                    refreshBtn.disabled = false;
                }
            })
            .catch(error => {
                console.error('åˆ·æ–°é”™è¯¯:', error);
                alert('åˆ·æ–°å¤±è´¥: ' + error.message);
                refreshBtn.innerHTML = originalText;
                refreshBtn.disabled = false;
            });
        }
        
        // åˆå§‹åŒ–ç»Ÿè®¡ä¿¡æ¯
        function initStats() {
            document.getElementById("total-nodes").textContent = graphData.stats.total_nodes;
            document.getElementById("total-links").textContent = graphData.stats.total_links;
            document.getElementById("updated-time").textContent = new Date(graphData.stats.updated_at).toLocaleString();
            
            // èŠ‚ç‚¹ç±»å‹ç»Ÿè®¡
            const nodeTypesDiv = document.getElementById("node-types");
            let nodeTypesHtml = "";
            for (const [type, count] of Object.entries(graphData.stats.node_types)) {
                nodeTypesHtml += `
                    <div class="stat-item">
                        <span>${type}:</span>
                        <span>${count}</span>
                    </div>
                `;
            }
            nodeTypesDiv.innerHTML = nodeTypesHtml;
            
            // å…³ç³»ç±»å‹ç»Ÿè®¡
            const relationTypesDiv = document.getElementById("relation-types");
            let relationTypesHtml = "";
            for (const [type, count] of Object.entries(graphData.stats.relation_types)) {
                relationTypesHtml += `
                    <div class="stat-item">
                        <span>${type}:</span>
                        <span>${count}</span>
                    </div>
                `;
            }
            relationTypesDiv.innerHTML = relationTypesHtml;
        }
        
        function updateNodeSelectionLists() {
            const modifySelect = document.getElementById('modify-node-select');
            const deleteSelect = document.getElementById('delete-node-select');
            const linkSourceSelect = document.getElementById('link-source-select');
            const linkTargetSelect = document.getElementById('link-target-select');
            
            // åªæ›´æ–°å­˜åœ¨çš„é€‰æ‹©æ¡†
            if (modifySelect) {
                modifySelect.innerHTML = '<option value="">è¯·é€‰æ‹©è¦ä¿®æ”¹çš„èŠ‚ç‚¹</option>';
                graphData.nodes.forEach(node => {
                    const option = document.createElement('option');
                    option.value = node.id;
                    option.textContent = `${node.label} (${node.group})`;
                    modifySelect.appendChild(option);
                });
            }
            
            if (deleteSelect) {
                deleteSelect.innerHTML = '<option value="">è¯·é€‰æ‹©è¦åˆ é™¤çš„èŠ‚ç‚¹</option>';
                graphData.nodes.forEach(node => {
                    const option = document.createElement('option');
                    option.value = node.id;
                    option.textContent = `${node.label} (${node.group})`;
                    deleteSelect.appendChild(option);
                });
            }
            
            if (linkSourceSelect) {
                linkSourceSelect.innerHTML = '<option value="">è¯·é€‰æ‹©èµ·å§‹èŠ‚ç‚¹</option>';
                graphData.nodes.forEach(node => {
                    const option = document.createElement('option');
                    option.value = node.id;
                    option.textContent = `${node.label} (${node.group})`;
                    linkSourceSelect.appendChild(option);
                });
            }
            
            if (linkTargetSelect) {
                linkTargetSelect.innerHTML = '<option value="">è¯·é€‰æ‹©ç›®æ ‡èŠ‚ç‚¹</option>';
                graphData.nodes.forEach(node => {
                    const option = document.createElement('option');
                    option.value = node.id;
                    option.textContent = `${node.label} (${node.group})`;
                    linkTargetSelect.appendChild(option);
                });
            }
        }
        
        function showAddNodeForm() {
            hideEditForms();
            
            // åˆ›å»ºèŠ‚ç‚¹ç±»å‹é€‰æ‹©ç•Œé¢
            const editForms = document.querySelector('.edit-forms');
            editForms.innerHTML = `
                <div class="node-type-buttons">
                    <button class="node-type-button" onclick="selectNodeType('Entity')">
                        <span class="node-type-icon">ğŸ·ï¸</span>
                        <span class="node-type-text">å®ä½“èŠ‚ç‚¹</span>
                    </button>
                    <button class="node-type-button" onclick="selectNodeType('Time')">
                        <span class="node-type-icon">â°</span>
                        <span class="node-type-text">æ—¶é—´èŠ‚ç‚¹</span>
                    </button>
                    <button class="node-type-button" onclick="selectNodeType('Character')">
                        <span class="node-type-icon">ğŸ‘¤</span>
                        <span class="node-type-text">è§’è‰²èŠ‚ç‚¹</span>
                    </button>
                    <button class="node-type-button" onclick="selectNodeType('Location')">
                        <span class="node-type-icon">ğŸ“</span>
                        <span class="node-type-text">åœ°ç‚¹èŠ‚ç‚¹</span>
                    </button>
                </div>
                <!-- ç”¨æˆ·è¾“å…¥è¡¨å•åŒºåŸŸ -->
                <div class="user-input-form" id="user-input-form" style="display: none;">
                </div>
            `;
            
            // é‡ç½®æŒ‰é’®çŠ¶æ€
            resetButtonStates();
            document.querySelector('.add-node-btn').classList.add('active');
        }
        
        function showModifyNodeForm() {
            hideEditForms();
            
            // æ›´æ–°ä¿®æ”¹è¡¨å•å†…å®¹
            updateModifyFormContent();
            
            // è®¾ç½®æŒ‰é’®çŠ¶æ€
            resetButtonStates();
            document.querySelector('.modify-node-btn').classList.add('active');
        }
        
        function showLinkNodeForm() {
            hideEditForms();
            
            // æ›´æ–°é“¾æ¥è¡¨å•å†…å®¹
            updateLinkFormContent();
            
            // è®¾ç½®æŒ‰é’®çŠ¶æ€
            resetButtonStates();
            document.querySelector('.link-node-btn').classList.add('active');
        }
        
        // è·å–é€‰ä¸­é¡¹ç›®çš„ä¿¡æ¯æ˜¾ç¤ºæ–‡æœ¬
        function getSelectedItemInfo() {
            const selectedItem = recentSelectedNodes[0];
            if (!selectedItem) {
                return 'æ— é€‰ä¸­é¡¹ç›®';
            }
            
            if (selectedItem.type === 'node') {
                const node = selectedItem.data;
                return `
                    <strong>èŠ‚ç‚¹ï¼š</strong>${node.label}<br>
                    <strong>ç±»å‹ï¼š</strong>${node.labels.join(", ")}<br>
                    <strong>IDï¼š</strong>${node.neo4j_id}
                `;
            } else if (selectedItem.type === 'relationship') {
                const rel = selectedItem.data;
                const sourceNode = graphData.nodes.find(node => node.id === rel.source.id);
                const targetNode = graphData.nodes.find(node => node.id === rel.target.id);
                return `
                    <strong>å…³ç³»ï¼š</strong>${rel.type}<br>
                    <strong>ä»ï¼š</strong>${sourceNode ? sourceNode.label : 'Unknown'}<br>
                    <strong>åˆ°ï¼š</strong>${targetNode ? targetNode.label : 'Unknown'}<br>
                    <strong>IDï¼š</strong>${rel.neo4j_id}
                `;
            }
            
            return 'æœªçŸ¥é¡¹ç›®ç±»å‹';
        }
        
        // è·å–ç›¸å…³é¡¹ç›®æ•°é‡ï¼ˆä»…å¯¹èŠ‚ç‚¹æœ‰æ„ä¹‰ï¼‰
        function getRelatedItemsCount() {
            const selectedItem = recentSelectedNodes[0];
            if (!selectedItem || selectedItem.type !== 'node') {
                return 0;
            }
            
            const nodeId = selectedItem.data.id;
            return graphData.links.filter(link => 
                link.source.id === nodeId || link.target.id === nodeId
            ).length;
        }
        
        // æ£€æŸ¥åˆ é™¤ç•Œé¢æ˜¯å¦å¯è§ï¼Œå¦‚æœå¯è§åˆ™æ›´æ–°å†…å®¹
        function updateDeleteFormIfVisible() {
            const deleteBtn = document.querySelector('.delete-node-btn');
            if (deleteBtn && deleteBtn.classList.contains('active')) {
                // åˆ é™¤ç•Œé¢å·²æ‰“å¼€ï¼Œæ›´æ–°å†…å®¹ä½†ä¸é‡ç½®æŒ‰é’®çŠ¶æ€
                updateDeleteFormContent();
            }
        }
        
        // æ£€æŸ¥ä¿®æ”¹ç•Œé¢æ˜¯å¦å¯è§ï¼Œå¦‚æœå¯è§åˆ™æ›´æ–°å†…å®¹
        function updateModifyFormIfVisible() {
            const modifyBtn = document.querySelector('.modify-node-btn');
            if (modifyBtn && modifyBtn.classList.contains('active')) {
                // ä¿®æ”¹ç•Œé¢å·²æ‰“å¼€ï¼Œæ›´æ–°å†…å®¹ä½†ä¸é‡ç½®æŒ‰é’®çŠ¶æ€
                updateModifyFormContent();
            }
        }
        
        // æ£€æŸ¥é“¾æ¥ç•Œé¢æ˜¯å¦å¯è§ï¼Œå¦‚æœå¯è§åˆ™æ›´æ–°å†…å®¹
        function updateLinkFormIfVisible() {
            const linkBtn = document.querySelector('.link-node-btn');
            if (linkBtn && linkBtn.classList.contains('active')) {
                // é“¾æ¥ç•Œé¢å·²æ‰“å¼€ï¼Œæ›´æ–°å†…å®¹ä½†ä¸é‡ç½®æŒ‰é’®çŠ¶æ€
                updateLinkFormContent();
            }
        }
        
        // æ›´æ–°æœ€è¿‘é€‰ä¸­çš„é¡¹ç›®åˆ—è¡¨ï¼ˆèŠ‚ç‚¹å’Œå…³ç³»ï¼‰
        function updateRecentSelectedNodes(itemData) {
            // æ£€æŸ¥å‚æ•°
            if (!itemData) return;
            
            // æ£€æŸ¥æ˜¯å¦å·²ç»åœ¨åˆ—è¡¨ä¸­
            const existingIndex = recentSelectedNodes.findIndex(item => 
                item.elementId === itemData.elementId && item.type === itemData.type);
            
            if (existingIndex !== -1) {
                // å¦‚æœå·²å­˜åœ¨ï¼Œç§»é™¤åé‡æ–°æ·»åŠ åˆ°æœ€å‰é¢
                recentSelectedNodes.splice(existingIndex, 1);
            }
            
            // æ·»åŠ åˆ°åˆ—è¡¨å¼€å¤´
            recentSelectedNodes.unshift(itemData);
            
            // åªä¿ç•™æœ€è¿‘çš„10ä¸ªé¡¹ç›®
            if (recentSelectedNodes.length > 10) {
                recentSelectedNodes = recentSelectedNodes.slice(0, 10);
            }
            
            // å¦‚æœåœ¨åˆ é™¤æ¨¡å¼ä¸‹ï¼Œæ›´æ–°æ ·å¼
            if (deleteMode) {
                updateSelectedItemsStyle();
            }
        }
        
        // æ›´æ–°é€‰ä¸­é¡¹ç›®çš„æ ·å¼ï¼ˆåˆ é™¤æ¨¡å¼ä¸‹æ˜¾ç¤ºçº¢è‰²æè¾¹ï¼‰
        function updateSelectedItemsStyle() {
            // é‡ç½®æ‰€æœ‰èŠ‚ç‚¹çš„æ ·å¼
            container.selectAll(".node")
                .attr("stroke", d => d.strokeColor)
                .attr("stroke-width", d => d.strokeWidth);
            
            // é‡ç½®æ‰€æœ‰å…³ç³»çš„æ ·å¼
            container.selectAll(".link")
                .attr("stroke", d => getStorageTypeColor(d.source_type))
                .attr("stroke-width", "2");
            
            // å¦‚æœåœ¨åˆ é™¤æ¨¡å¼ä¸‹ï¼Œä¸ºé€‰ä¸­çš„é¡¹ç›®æ·»åŠ çº¢è‰²æè¾¹
            if (deleteMode) {
                recentSelectedNodes.forEach(item => {
                    if (item.type === 'node') {
                        // ä¸ºé€‰ä¸­çš„èŠ‚ç‚¹æ·»åŠ çº¢è‰²æè¾¹
                        container.selectAll(".node")
                            .filter(d => d.id === item.data.id)
                            .attr("stroke", "#ff0000")
                            .attr("stroke-width", "4");
                    } else if (item.type === 'relationship') {
                        // ä¸ºé€‰ä¸­çš„å…³ç³»æ·»åŠ çº¢è‰²æè¾¹
                        container.selectAll(".link")
                            .filter(d => d.neo4j_id === item.data.neo4j_id)
                            .attr("stroke", "#ff0000")
                            .attr("stroke-width", "4");
                    }
                });
            }
        }
        
        // æ›´æ–°åˆ é™¤è¡¨å•å†…å®¹
        function updateDeleteFormContent() {
            const editForms = document.querySelector('.edit-forms');
            
            if (recentSelectedNodes.length === 0) {
                // æœªé€‰ä¸­ä»»ä½•é¡¹ç›®
                editForms.innerHTML = `
                    <div class="edit-form">
                        <h4>åˆ é™¤é¡¹ç›®</h4>
                        <div class="warning-text">
                            è¯·å…ˆç‚¹å‡»é€‰ä¸­ä¸€ä¸ªæˆ–å¤šä¸ªèŠ‚ç‚¹æˆ–å…³ç³»åå†è¿›è¡Œåˆ é™¤æ“ä½œã€‚
                        </div>
                    </div>
                `;
            } else {
                // è®¡ç®—å°†è¦åˆ é™¤çš„æ‰€æœ‰é¡¹ç›®
                let totalNodeCount = 0;
                let totalRelationshipCount = 0;
                let itemsList = [];
                
                recentSelectedNodes.forEach((item, index) => {
                    if (item.type === 'node') {
                        totalNodeCount += 1;
                        // è®¡ç®—æ¯ä¸ªèŠ‚ç‚¹çš„ç›¸å…³å…³ç³»æ•°é‡
                        const relatedCount = graphData.links.filter(link => 
                            link.source.id === item.data.id || link.target.id === item.data.id
                        ).length;
                        totalRelationshipCount += relatedCount;
                        itemsList.push(`<strong>èŠ‚ç‚¹${index + 1}:</strong> ${item.data.label} (èŠ‚ç‚¹, å°†åˆ é™¤${relatedCount}ä¸ªå…³ç³»)`);
                    } else if (item.type === 'relationship') {
                        totalRelationshipCount += 1;
                        const sourceNode = graphData.nodes.find(node => node.id === item.data.source.id);
                        const targetNode = graphData.nodes.find(node => node.id === item.data.target.id);
                        itemsList.push(`<strong>å…³ç³»${index + 1}:</strong> ${item.data.type} (ä» "${sourceNode ? sourceNode.label : 'Unknown'}" åˆ° "${targetNode ? targetNode.label : 'Unknown'}")`);
                    }
                });
                
                let warningText = '';
                if (totalNodeCount > 0 && totalRelationshipCount > 0) {
                    warningText = `
                        <div class="warning-text">
                            è­¦å‘Šï¼šæ­¤æ¬¡æ“ä½œå°†åˆ é™¤ ${totalNodeCount} ä¸ªèŠ‚ç‚¹å’Œ ${totalRelationshipCount} ä¸ªå…³ç³»ï¼
                        </div>
                    `;
                } else if (totalNodeCount > 0) {
                    warningText = `
                        <div class="warning-text">
                            è­¦å‘Šï¼šæ­¤æ¬¡æ“ä½œå°†åˆ é™¤ ${totalNodeCount} ä¸ªèŠ‚ç‚¹å’Œå…¶ç›¸å…³çš„ ${totalRelationshipCount} ä¸ªå…³ç³»ï¼
                        </div>
                    `;
                } else if (totalRelationshipCount > 0) {
                    warningText = `
                        <div class="warning-text">
                            è­¦å‘Šï¼šæ­¤æ¬¡æ“ä½œå°†åˆ é™¤ ${totalRelationshipCount} ä¸ªå…³ç³»ï¼
                        </div>
                    `;
                }
                
                editForms.innerHTML = `
                    <div class="edit-form">
                        <h4>å³å°†åˆ é™¤ (å…±${recentSelectedNodes.length}ä¸ªé¡¹ç›®)</h4>
                        <div class="form-group">
                            <label>é€‰ä¸­çš„é¡¹ç›®åˆ—è¡¨ï¼š</label>
                            <div style="padding: 8px; background: #f8f9fa; border-radius: 4px; margin-top: 5px; max-height: 200px; overflow-y: auto;">
                                ${itemsList.join('<br>')}
                            </div>
                        </div>
                        ${warningText}
                        <div class="form-group">
                            <label>åˆ é™¤ç»Ÿè®¡ï¼š</label>
                            <div style="padding: 8px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px; margin-top: 5px;">
                                â€¢ èŠ‚ç‚¹ï¼š${totalNodeCount} ä¸ª<br>
                                â€¢ å…³ç³»ï¼š${totalRelationshipCount} ä¸ª<br>
                                â€¢ æ€»è®¡ï¼š${totalNodeCount + totalRelationshipCount} ä¸ªé¡¹ç›®
                            </div>
                        </div>
                        <div class="form-actions">
                            <button class="action-btn danger-btn" onclick="confirmDelete()">ç¡®è®¤åˆ é™¤</button>
                            <button class="action-btn" onclick="clearRecentNodes()" style="background-color: #6c757d; color: white;">æ¸…ç©ºå·²é€‰</button>
                            <button class="action-btn cancel-btn" onclick="hideEditForms()">å–æ¶ˆ</button>
                        </div>
                    </div>
                `;
            }
        }
        
        // æ›´æ–°ä¿®æ”¹è¡¨å•å†…å®¹
        function updateModifyFormContent() {
            const editForms = document.querySelector('.edit-forms');
            const selectedItem = recentSelectedNodes[0];
            
            if (!selectedItem) {
                // æœªé€‰ä¸­ä»»ä½•é¡¹ç›®
                editForms.innerHTML = `
                    <div class="edit-form">
                        <h4>ä¿®æ”¹é¡¹ç›®</h4>
                        <div class="warning-text">
                            è¯·å…ˆç‚¹å‡»é€‰ä¸­ä¸€ä¸ªèŠ‚ç‚¹æˆ–å…³ç³»åå†è¿›è¡Œä¿®æ”¹æ“ä½œã€‚
                        </div>
                    </div>
                `;
            } else {
                // æ˜¾ç¤ºé€‰ä¸­é¡¹ç›®çš„è¯¦ç»†ä¿¡æ¯ï¼ˆèŠ‚ç‚¹æˆ–å…³ç³»ï¼‰
                const item = selectedItem.data;
                
                // è·å–å½“å‰èŠ‚ç‚¹çš„ä¸»è¦ç±»å‹ï¼ˆåœ¨å‡½æ•°å¼€å¤´å®šä¹‰ï¼Œç¡®ä¿ä½œç”¨åŸŸæ­£ç¡®ï¼‰
                let currentType = 'Entity';
                if (selectedItem.type === 'node') {
                    currentType = item.labels.find(label => label === 'Character' || label === 'Entity' || label === 'Location') || 'Entity';
                }
                
                // æ£€æŸ¥æ˜¯å¦ä¸ºæ—¶é—´èŠ‚ç‚¹
                if (selectedItem.type === 'node' && item.labels && item.labels.includes('Time')) {
                    // æ—¶é—´èŠ‚ç‚¹ç‰¹æ®Šå¤„ç†
                    editForms.innerHTML = `
                        <div class="edit-form">
                            <h4>æ—¶é—´èŠ‚ç‚¹ä¿¡æ¯</h4>
                            <div class="form-group">
                                <div style="padding: 15px; background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 6px; margin-bottom: 15px;">
                                    <div style="display: flex; align-items: center; margin-bottom: 8px;">
                                        <span style="font-size: 18px; margin-right: 8px;">âš ï¸</span>
                                        <span style="font-weight: 600; color: #721c24;">ä¸æ”¯æŒä¿®æ”¹æ—¶é—´èŠ‚ç‚¹</span>
                                    </div>
                                    <div style="color: #721c24; font-size: 14px; line-height: 1.4;">
                                        æ—¶é—´èŠ‚ç‚¹æ˜¯ç³»ç»Ÿè‡ªåŠ¨ç®¡ç†çš„èŠ‚ç‚¹ï¼Œä¸æ”¯æŒç›´æ¥ä¿®æ”¹ã€‚<br>
                                        å¦‚éœ€ä¿®æ”¹å®ä½“å¯¹åº”çš„æ—¶é—´ï¼Œè¯·ä»ç›¸å…³çš„å®ä½“èŠ‚ç‚¹è¿›è¡Œä¿®æ”¹ã€‚
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-actions">
                                <button class="action-btn cancel-btn" onclick="hideEditForms()">å…³é—­</button>
                            </div>
                        </div>
                    `;
                    return; // ç›´æ¥è¿”å›ï¼Œä¸æ‰§è¡Œåç»­å¤„ç†
                }
                
                // æ£€æŸ¥æ˜¯å¦ä¸ºæ—¶é—´èŠ‚ç‚¹ä¹‹é—´çš„å…³ç³»
                if (selectedItem.type === 'relationship') {
                    // è·å–å…³ç³»çš„èµ·å§‹å’Œç»“æŸèŠ‚ç‚¹
                    const startNode = graphData.nodes.find(n => n.id === selectedItem.data.source.id);
                    const endNode = graphData.nodes.find(n => n.id === selectedItem.data.target.id);
                    
                    // æ£€æŸ¥æ˜¯å¦ä¸¤ä¸ªèŠ‚ç‚¹éƒ½æ˜¯æ—¶é—´èŠ‚ç‚¹
                    if ((startNode && startNode.labels && startNode.labels.includes('Time')) && 
                        (endNode && endNode.labels && endNode.labels.includes('Time'))) {
                        editForms.innerHTML = `
                            <div class="edit-form">
                                <h4>æ—¶é—´èŠ‚ç‚¹å…³ç³»ä¿¡æ¯</h4>
                                <div class="form-group">
                                    <div style="padding: 15px; background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 6px; margin-bottom: 15px;">
                                        <div style="display: flex; align-items: center; margin-bottom: 8px;">
                                            <span style="font-size: 18px; margin-right: 8px;">âš ï¸</span>
                                            <span style="font-weight: 600; color: #721c24;">ä¸æ”¯æŒä¿®æ”¹æ—¶é—´èŠ‚ç‚¹å…³ç³»</span>
                                        </div>
                                        <div style="color: #721c24; font-size: 14px; line-height: 1.4;">
                                            æ—¶é—´èŠ‚ç‚¹ä¹‹é—´çš„å…³ç³»ç”±ç³»ç»Ÿè‡ªåŠ¨ç®¡ç†ï¼Œä¸æ”¯æŒç›´æ¥ä¿®æ”¹ã€‚<br>
                                            è¿™äº›å…³ç³»ç”¨äºç»´æŠ¤æ—¶é—´çš„å±‚æ¬¡ç»“æ„ï¼ˆå¹´-æœˆ-æ—¥-æ—¶ç­‰ï¼‰ï¼Œè¯·å‹¿æ‰‹åŠ¨ä¿®æ”¹ã€‚
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="form-actions">
                                    <button class="action-btn cancel-btn" onclick="hideEditForms()">å…³é—­</button>
                                </div>
                            </div>
                        `;
                        return; // ç›´æ¥è¿”å›ï¼Œä¸æ‰§è¡Œåç»­å¤„ç†
                    }
                }
                
                // å¤„ç†ä¸åŒç±»å‹é¡¹ç›®çš„æ˜¾ç¤º
                let itemTypeText = '';
                let itemNameText = '';
                let sourceText = '';
                let propertiesHtml = '';
                
                if (selectedItem.type === 'node') {
                    itemTypeText = 'èŠ‚ç‚¹';
                    itemNameText = item.label;
                    
                    if (item.source === 'local') {
                        sourceText = 'ä»…æœ¬åœ°';
                    } else if (item.source === 'neo4j') {
                        sourceText = 'ä»…Neo4j';
                    } else if (item.source === 'both') {
                        sourceText = 'æœ¬åœ°+Neo4j';
                    } else {
                        sourceText = 'æœªçŸ¥';
                    }
                } else if (selectedItem.type === 'relationship') {
                    itemTypeText = 'å…³ç³»';
                    itemNameText = item.type;
                    sourceText = 'Neo4j'; // å…³ç³»é€šå¸¸æ¥è‡ªNeo4j
                }
                
                // æ˜¾ç¤ºå¯ç¼–è¾‘çš„é¡¹ç›®å±æ€§ï¼ˆè¿‡æ»¤æ‰ç³»ç»Ÿç®¡ç†çš„å±æ€§ï¼‰
                for (const [key, value] of Object.entries(item.properties)) {
                    if (!EXCLUDED_PROPERTIES.includes(key)) {
                        const valueStr = typeof value === 'string' ? value : JSON.stringify(value);
                        propertiesHtml += `
                            <div class="property-item" style="margin: 8px 0; padding: 6px; background: #f8f9fa; border-radius: 4px; border-left: 3px solid #007bff;">
                                <div style="font-weight: 500; color: #495057; font-size: 13px; margin-bottom: 4px;">${key}:</div>
                                <input type="text" id="edit-property-${key}" value="${valueStr}" style="width: 100%; padding: 4px 8px; border: 1px solid #ddd; border-radius: 3px; font-size: 12px; color: #495057;" placeholder="è¯·è¾“å…¥${key}çš„å€¼">
                            </div>
                        `;
                    }
                }
                
                // ä¸ºå…³ç³»ç±»å‹æ·»åŠ é¢å¤–ä¿¡æ¯
                let extraInfo = '';
                if (selectedItem.type === 'relationship') {
                    const sourceNode = graphData.nodes.find(node => node.id === item.source.id);
                    const targetNode = graphData.nodes.find(node => node.id === item.target.id);
                    extraInfo = `
                        <div class="property-item" style="margin: 6px 0; display: flex; justify-content: space-between;">
                            <span style="font-weight: 600; color: #0c5460;">èµ·å§‹èŠ‚ç‚¹:</span>
                            <span style="font-weight: 500; color: #495057; max-width: 200px; word-break: break-all;">${sourceNode ? sourceNode.label : 'Unknown'}</span>
                        </div>
                        <div class="property-item" style="margin: 6px 0; display: flex; justify-content: space-between;">
                            <span style="font-weight: 600; color: #0c5460;">ç›®æ ‡èŠ‚ç‚¹:</span>
                            <span style="font-weight: 500; color: #495057; max-width: 200px; word-break: break-all;">${targetNode ? targetNode.label : 'Unknown'}</span>
                        </div>
                    `;
                } else {
                    // ä¸ºèŠ‚ç‚¹ç±»å‹æ·»åŠ é¢å¤–ä¿¡æ¯ï¼ˆcurrentTypeå·²åœ¨å‡½æ•°å¼€å¤´å®šä¹‰ï¼‰
                    extraInfo = `
                        <div class="property-item" style="margin: 6px 0; display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-weight: 600; color: #0c5460;">èŠ‚ç‚¹ç±»å‹ï¼š</span>
                            <div style="display: flex; gap: 8px;">
                                <button type="button" id="btn-entity" onclick="selectNodeTypeInEdit('Entity')" style="padding: 4px 12px; border: 1px solid #ddd; border-radius: 4px; background: ${currentType === 'Entity' ? '#007bff' : '#fff'}; color: ${currentType === 'Entity' ? '#fff' : '#495057'}; cursor: pointer; font-size: 12px; font-weight: 500;">Entity</button>
                                <button type="button" id="btn-character" onclick="selectNodeTypeInEdit('Character')" style="padding: 4px 12px; border: 1px solid #ddd; border-radius: 4px; background: ${currentType === 'Character' ? '#007bff' : '#fff'}; color: ${currentType === 'Character' ? '#fff' : '#495057'}; cursor: pointer; font-size: 12px; font-weight: 500;">Character</button>
                                <button type="button" id="btn-location" onclick="selectNodeTypeInEdit('Location')" style="padding: 4px 12px; border: 1px solid #ddd; border-radius: 4px; background: ${currentType === 'Location' ? '#007bff' : '#fff'}; color: ${currentType === 'Location' ? '#fff' : '#495057'}; cursor: pointer; font-size: 12px; font-weight: 500;">Location</button>
                            </div>
                            <input type="hidden" id="edit-node-type" value="${currentType}">
                        </div>
                    `;
                }
                
                editForms.innerHTML = `
                    <div class="edit-form">
                        <h4>${itemTypeText}è¯¦ç»†ä¿¡æ¯</h4>
                        <div class="form-group">
                            <div style="padding: 12px; background: #e8f4fd; border-radius: 6px; border: 1px solid #bee5eb; margin-bottom: 15px;">
                                <div class="property-item" style="margin: 6px 0; display: flex; justify-content: space-between;">
                                    <span style="font-weight: 600; color: #0c5460;">${itemTypeText}ID:</span>
                                    <span style="font-family: monospace; background: #fff; padding: 2px 6px; border-radius: 3px; border: 1px solid #ddd;">${item.neo4j_id}</span>
                                </div>
                                <div class="property-item" style="margin: 6px 0; display: flex; justify-content: space-between;">
                                    <span style="font-weight: 600; color: #0c5460;">æ•°æ®ä½ç½®:</span>
                                    <span style="padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 500; background: ${getStorageUIBackground(sourceText)}; color: ${getStorageUIColor(sourceText)};">${sourceText}</span>
                                </div>
                                ${extraInfo}
                            </div>
                            
                            <!-- åŠ¨æ€å±æ€§åŒºåŸŸ -->
                            <div id="dynamic-properties-container">
                                <!-- è¿™é‡Œä¼šæ ¹æ®èŠ‚ç‚¹ç±»å‹åŠ¨æ€æ’å…¥ç›¸åº”çš„å±æ€§è¡¨å• -->
                            </div>

                        </div>
                        
                        <div class="form-actions">
                            <button class="action-btn primary-btn" onclick="confirmNodeModification()">ä¿å­˜ä¿®æ”¹</button>
                            <button class="action-btn cancel-btn" onclick="hideEditForms()">å–æ¶ˆ</button>
                        </div>
                    </div>
                `;
                
                // åˆå§‹åŒ–åŠ¨æ€å±æ€§æ˜¾ç¤º
                setTimeout(() => {
                    if (selectedItem.type === 'relationship') {
                        updateDynamicProperties('relationship');
                    } else {
                        updateDynamicProperties(currentType);
                    }
                }, 50);
            }
        }
        
        // æ›´æ–°é“¾æ¥è¡¨å•å†…å®¹
        function updateLinkFormContent() {
            const editForms = document.querySelector('.edit-forms');
            
            if (recentSelectedNodes.length < 2) {
                // é€‰ä¸­çš„èŠ‚ç‚¹ä¸è¶³ä¸¤ä¸ª
                editForms.innerHTML = `
                    <div class="edit-form">
                        <h4>é“¾æ¥èŠ‚ç‚¹</h4>
                        <div class="warning-text">
                            è¯·ç‚¹å‡»é€‰æ‹©ä¸¤ä¸ªä¸åŒçš„èŠ‚ç‚¹è¿›è¡Œé“¾æ¥ã€‚<br>
                            å½“å‰å·²é€‰æ‹© ${recentSelectedNodes.length} ä¸ªèŠ‚ç‚¹ã€‚
                        </div>
                        ${recentSelectedNodes.length > 0 ? `
                            <div class="form-group">
                                <label>å·²é€‰æ‹©çš„èŠ‚ç‚¹ï¼š</label>
                                <div style="padding: 8px; background: #f8f9fa; border-radius: 4px; margin-top: 5px;">
                                    <strong>èŠ‚ç‚¹1ï¼š</strong>${recentSelectedNodes[0].data.label}<br>
                                    <strong>ç±»å‹ï¼š</strong>${recentSelectedNodes[0].data.labels.join(", ")}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            } else {
                // å·²é€‰æ‹©ä¸¤ä¸ªé¡¹ç›®ï¼Œé¦–å…ˆæ£€æŸ¥æ˜¯å¦éƒ½æ˜¯èŠ‚ç‚¹ç±»å‹
                const item1 = recentSelectedNodes[1];
                const item2 = recentSelectedNodes[0];
                
                // æ£€æŸ¥æ˜¯å¦æœ‰éèŠ‚ç‚¹ç±»å‹çš„é¡¹ç›®
                if (item1.type !== 'node' || item2.type !== 'node') {
                    // æœ‰å…³ç³»æˆ–å…¶ä»–ç±»å‹ï¼Œä¸å…è®¸é“¾æ¥
                    const nonNodeItems = [];
                    if (item1.type !== 'node') nonNodeItems.push(`é¡¹ç›®1: ${item1.type === 'relationship' ? 'å…³ç³»' : 'æœªçŸ¥ç±»å‹'}`);
                    if (item2.type !== 'node') nonNodeItems.push(`é¡¹ç›®2: ${item2.type === 'relationship' ? 'å…³ç³»' : 'æœªçŸ¥ç±»å‹'}`);
                    
                    editForms.innerHTML = `
                        <div class="edit-form">
                            <h4>é“¾æ¥èŠ‚ç‚¹</h4>
                            <div class="form-group">
                                <label>å½“å‰é€‰ä¸­çš„é¡¹ç›®ï¼š</label>
                                <div style="padding: 8px; background: #f8f9fa; border-radius: 4px; margin-top: 5px;">
                                    <strong>é¡¹ç›®1ï¼š</strong>${item1.type === 'node' ? item1.data.label + ' (èŠ‚ç‚¹)' : (item1.type === 'relationship' ? item1.data.type + ' (å…³ç³»)' : 'æœªçŸ¥ç±»å‹')}<br>
                                    <strong>é¡¹ç›®2ï¼š</strong>${item2.type === 'node' ? item2.data.label + ' (èŠ‚ç‚¹)' : (item2.type === 'relationship' ? item2.data.type + ' (å…³ç³»)' : 'æœªçŸ¥ç±»å‹')}
                                </div>
                            </div>
                            <div style="padding: 15px; background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 6px; margin-bottom: 15px;">
                                <div style="display: flex; align-items: center; margin-bottom: 8px;">
                                    <span style="font-size: 18px; margin-right: 8px;">âš ï¸</span>
                                    <span style="font-weight: 600; color: #721c24;">è¯·é€‰æ‹©ä¸¤ä¸ªèŠ‚ç‚¹</span>
                                </div>
                                <div style="color: #721c24; font-size: 14px; line-height: 1.4;">
                                    é“¾æ¥åŠŸèƒ½åªèƒ½åœ¨ä¸¤ä¸ªèŠ‚ç‚¹ä¹‹é—´åˆ›å»ºå…³ç³»ã€‚<br>
                                    å½“å‰é€‰æ‹©åŒ…å«éèŠ‚ç‚¹ç±»å‹é¡¹ç›®ï¼š${nonNodeItems.join('ã€')}<br>
                                    è¯·é‡æ–°é€‰æ‹©ä¸¤ä¸ªèŠ‚ç‚¹è¿›è¡Œé“¾æ¥ã€‚
                                </div>
                            </div>
                            <div class="form-actions">
                                <button class="action-btn cancel-btn" onclick="clearRecentNodes()">é‡æ–°é€‰æ‹©</button>
                            </div>
                        </div>
                    `;
                    return;
                }
                
                // ä¸¤ä¸ªéƒ½æ˜¯èŠ‚ç‚¹ï¼Œç»§ç»­æ£€æŸ¥æ˜¯å¦éƒ½æ˜¯æ—¶é—´èŠ‚ç‚¹
                const node1 = item1.data;
                const node2 = item2.data;
                
                const isNode1Time = node1.labels && node1.labels.includes('Time');
                const isNode2Time = node2.labels && node2.labels.includes('Time');
                
                if (isNode1Time && isNode2Time) {
                    // ä¸¤ä¸ªèŠ‚ç‚¹éƒ½æ˜¯æ—¶é—´èŠ‚ç‚¹ï¼Œä¸å…è®¸é“¾æ¥
                    editForms.innerHTML = `
                        <div class="edit-form">
                            <h4>é“¾æ¥èŠ‚ç‚¹</h4>
                            <div class="form-group">
                                <label>é€‰ä¸­çš„èŠ‚ç‚¹ï¼š</label>
                                <div style="padding: 8px; background: #f8f9fa; border-radius: 4px; margin-top: 5px;">
                                    <strong>èŠ‚ç‚¹1ï¼š</strong>${node1.label} (${node1.labels.join(", ")})<br>
                                    <strong>èŠ‚ç‚¹2ï¼š</strong>${node2.label} (${node2.labels.join(", ")})
                                </div>
                            </div>
                            <div style="padding: 15px; background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 6px; margin-bottom: 15px;">
                                <div style="display: flex; align-items: center; margin-bottom: 8px;">
                                    <span style="font-size: 18px; margin-right: 8px;">âš ï¸</span>
                                    <span style="font-weight: 600; color: #721c24;">ä¸æ”¯æŒé“¾æ¥ä¸¤ä¸ªæ—¶é—´èŠ‚ç‚¹</span>
                                </div>
                                <div style="color: #721c24; font-size: 14px; line-height: 1.4;">
                                    æ—¶é—´èŠ‚ç‚¹ä¹‹é—´çš„å…³ç³»ç”±ç³»ç»Ÿè‡ªåŠ¨ç»´æŠ¤ï¼Œä¸æ”¯æŒæ‰‹åŠ¨åˆ›å»ºé“¾æ¥ã€‚<br>
                                    è¯·é€‰æ‹©è‡³å°‘ä¸€ä¸ªéæ—¶é—´ç±»å‹çš„èŠ‚ç‚¹è¿›è¡Œé“¾æ¥ã€‚
                                </div>
                            </div>
                            <div class="form-actions">
                                <button class="action-btn cancel-btn" onclick="clearRecentNodes()">é‡æ–°é€‰æ‹©</button>
                            </div>
                        </div>
                    `;
                } else {
                    // æ£€æŸ¥æ˜¯å¦æœ‰æ—¶é—´èŠ‚ç‚¹ï¼Œå¦‚æœæœ‰åˆ™è‡ªåŠ¨è®¾ç½®å…³ç³»
                    let defaultPredicate = "";
                    let defaultDirection = "to_endNode";
                    let isTimeRelation = false;
                    let timeNodeLabel = "";
                    let nonTimeNodeLabel = "";
                    
                    if (node1.labels.includes('Time') && node2.labels.includes('Entity')) {
                        // èŠ‚ç‚¹1æ˜¯æ—¶é—´èŠ‚ç‚¹ï¼ŒèŠ‚ç‚¹2ä¸æ˜¯
                        defaultPredicate = "HAPPENED_AT";
                        defaultDirection = "to_startNode"; // èŠ‚ç‚¹2 â†’ èŠ‚ç‚¹1ï¼ˆæ—¶é—´èŠ‚ç‚¹ï¼‰
                        isTimeRelation = true;
                        timeNodeLabel = node1.label;
                        nonTimeNodeLabel = node2.label;
                    } else if (node1.labels.includes('Entity') && node2.labels.includes('Time')) {
                        // èŠ‚ç‚¹2æ˜¯æ—¶é—´èŠ‚ç‚¹ï¼ŒèŠ‚ç‚¹1ä¸æ˜¯
                        defaultPredicate = "HAPPENED_AT";
                        defaultDirection = "to_endNode"; // èŠ‚ç‚¹1 â†’ èŠ‚ç‚¹2ï¼ˆæ—¶é—´èŠ‚ç‚¹ï¼‰
                        isTimeRelation = true;
                        timeNodeLabel = node2.label;
                        nonTimeNodeLabel = node1.label;
                    } else if (node1.labels.includes('Location') && node2.labels.includes('Entity')) {
                        // èŠ‚ç‚¹1æ˜¯æ—¶é—´èŠ‚ç‚¹ï¼ŒèŠ‚ç‚¹2æ˜¯è§’è‰²èŠ‚ç‚¹
                        defaultPredicate = "HAPPENED_IN";
                        defaultDirection = "to_startNode"; // èŠ‚ç‚¹2 â†’ èŠ‚ç‚¹1ï¼ˆæ—¶é—´èŠ‚ç‚¹ï¼‰
                        isTimeRelation = true;
                        timeNodeLabel = node1.label;
                        nonTimeNodeLabel = node2.label;
                    } else if (node1.labels.includes('Entity') && node2.labels.includes('Location')) {
                        // èŠ‚ç‚¹2æ˜¯æ—¶é—´èŠ‚ç‚¹ï¼ŒèŠ‚ç‚¹1æ˜¯è§’è‰²èŠ‚ç‚¹
                        defaultPredicate = "HAPPENED_IN";
                        defaultDirection = "to_endNode"; // èŠ‚ç‚¹1 â†’ èŠ‚ç‚¹2ï¼ˆæ—¶é—´èŠ‚ç‚¹ï¼‰
                        isTimeRelation = true;
                        timeNodeLabel = node2.label;
                        nonTimeNodeLabel = node1.label;
                    }
                    
                    // å¯ä»¥è¿›è¡Œé“¾æ¥ï¼Œæ˜¾ç¤ºé“¾æ¥è¡¨å•
                    let directionOptions = '';
                    let predicateField = '';
                    
                    if (isTimeRelation) {
                        // æ—¶é—´å…³ç³»çš„ç‰¹æ®Šå¤„ç†
                        directionOptions = `
                            <option value="to_endNode" ${defaultDirection === 'to_endNode' ? 'selected' : ''}>${node1.label} â†’ ${node2.label}</option>
                            <option value="to_startNode" ${defaultDirection === 'to_startNode' ? 'selected' : ''}>${node2.label} â†’ ${node1.label}</option>
                            <option value="bidirectional">åŒå‘å…³ç³»</option>
                        `;
                        predicateField = `
                            <input type="text" id="link-predicate" value="${defaultPredicate}" placeholder="é»˜è®¤ï¼šHAPPENED_AT" required>
                            <small style="color: #6c757d; font-style: italic;">é»˜è®¤ä¸º HAPPENED_ATï¼Œå¯è‡ªå®šä¹‰å…¶ä»–å…³ç³»ç±»å‹</small>
                        `;
                    } else {
                        // æ™®é€šå…³ç³»
                        directionOptions = `
                            <option value="to_endNode">${node1.label} â†’ ${node2.label}</option>
                            <option value="to_startNode">${node2.label} â†’ ${node1.label}</option>
                            <option value="bidirectional">åŒå‘å…³ç³»</option>
                        `;
                        predicateField = `
                            <input type="text" id="link-predicate" placeholder="ä¾‹å¦‚ï¼šè®¤è¯†ã€æœ‹å‹ã€åŒäº‹ç­‰" required>
                        `;
                    }
                    
                    editForms.innerHTML = `
                        <div class="edit-form">
                            <h4>é“¾æ¥èŠ‚ç‚¹</h4>
                            <div class="form-group">
                                <label>å³å°†é“¾æ¥çš„èŠ‚ç‚¹ï¼š</label>
                                <div style="padding: 8px; background: #f8f9fa; border-radius: 4px; margin-top: 5px;">
                                    <strong>èŠ‚ç‚¹1ï¼š</strong>${node1.label} (${node1.labels.join(", ")})<br>
                                    <strong>èŠ‚ç‚¹2ï¼š</strong>${node2.label} (${node2.labels.join(", ")})
                                </div>
                                ${isTimeRelation ? `
                                    <div style="padding: 8px; background: #d4edda; border: 1px solid #c3e6cb; border-radius: 4px; margin-top: 8px;">
                                        <small style="color: #155724;">
                                            <strong>è‡ªåŠ¨æ£€æµ‹ï¼š</strong>æ—¶é—´å…³ç³»ï¼Œå·²é¢„å¡«é»˜è®¤å€¼ï¼Œå¯æ ¹æ®éœ€è¦è‡ªå®šä¹‰
                                        </small>
                                    </div>
                                ` : ''}
                            </div>
                            <div class="form-group">
                                <label for="link-predicate">å…³ç³»ç±»å‹ï¼š</label>
                                ${predicateField}
                            </div>
                            <div class="form-group">
                                <label for="link-confidence">ç½®ä¿¡åº¦ï¼š</label>
                                <input type="number" id="link-confidence" min="0" max="1" step="0.1" value="0.75" required>
                            </div>
                            <div class="form-group">
                                <label for="link-evidence">å…³ç³»è¯æ®ï¼š</label>
                                <textarea id="link-evidence" style="min-height: 60px; resize: vertical;" placeholder="è¯·è¾“å…¥å…³ç³»è¯æ®ï¼ˆä¸ºä»€ä¹ˆè®¾ç½®è¿™ä¸ªç½®ä¿¡åº¦ï¼‰">user manual input</textarea>
                            </div>
                            <div class="form-group">
                                <label for="link-direction">å…³ç³»æ–¹å‘ï¼š</label>
                                <select id="link-direction" required>
                                    ${directionOptions}
                                </select>
                                ${isTimeRelation ? '<small style="color: #6c757d; font-style: italic;">é»˜è®¤æ–¹å‘æŒ‡å‘æ—¶é—´èŠ‚ç‚¹ï¼Œä¸å»ºè®®è°ƒæ•´</small>' : ''}
                            </div>
                            <div class="form-actions">
                                <button class="action-btn primary-btn" onclick="confirmLink()">ç¡®è®¤é“¾æ¥</button>
                                <button class="action-btn cancel-btn" onclick="clearRecentNodes()">é‡æ–°é€‰æ‹©</button>
                            </div>
                        </div>
                    `;
                }
            }
        }
        
        // æ¸…ç©ºæœ€è¿‘é€‰æ‹©çš„èŠ‚ç‚¹
        function clearRecentNodes() {
            recentSelectedNodes = [];
            // æ›´æ–°æ‰€æœ‰å¯èƒ½æ‰“å¼€çš„ç•Œé¢
            updateLinkFormContent();
            updateDeleteFormContent();
            updateModifyFormContent();
            
            // æ›´æ–°æ ·å¼ï¼ˆæ¸…é™¤åˆ é™¤æ¨¡å¼çš„çº¢è‰²æè¾¹ï¼‰
            updateSelectedItemsStyle();
        }
        
        function showDeleteNodeForm() {
            hideEditForms();
            
            // å¯ç”¨åˆ é™¤æ¨¡å¼
            deleteMode = true;
            
            // æ›´æ–°åˆ é™¤è¡¨å•å†…å®¹
            updateDeleteFormContent();
            
            // è®¾ç½®æŒ‰é’®çŠ¶æ€
            resetButtonStates();
            document.querySelector('.delete-node-btn').classList.add('active');
            
            // æ›´æ–°æ‰€æœ‰é€‰ä¸­é¡¹ç›®çš„æ ·å¼
            updateSelectedItemsStyle();
        }
        
        function showQuintupleForm() {
            hideEditForms();
            
            // åˆ›å»ºäº”å…ƒç»„è¾“å…¥è¡¨å•
            const editForms = document.querySelector('.edit-forms');
            editForms.innerHTML = `
                <div class="edit-form">
                    <h4>åˆ›å»ºäº”å…ƒç»„</h4>
                    <div class="form-group">
                        <label>ä¸»ä½“ï¼ˆSubjectï¼‰ï¼š</label>
                        <input type="text" id="quintuple-subject" placeholder="è¯·è¾“å…¥ä¸»ä½“" required>
                    </div>
                    <div class="form-group">
                        <label>åŠ¨ä½œï¼ˆActionï¼‰ï¼š</label>
                        <input type="text" id="quintuple-action" placeholder="è¯·è¾“å…¥åŠ¨ä½œ" required>
                    </div>
                    <div class="form-group">
                        <label>å®¢ä½“ï¼ˆObjectï¼‰ï¼š</label>
                        <input type="text" id="quintuple-object" placeholder="è¯·è¾“å…¥å®¢ä½“" required>
                    </div>
                    <div class="form-group">
                        <label>æ—¶é—´ï¼ˆTimeï¼‰ï¼š</label>
                        <input type="text" id="quintuple-time" placeholder="è¯·è¾“å…¥æ—¶é—´ï¼ˆå¯é€‰ï¼‰">
                    </div>
                    <div class="form-group">
                        <label>åœ°ç‚¹ï¼ˆLocationï¼‰ï¼š</label>
                        <input type="text" id="quintuple-location" placeholder="è¯·è¾“å…¥åœ°ç‚¹ï¼ˆå¯é€‰ï¼‰">
                    </div>
                    <div class="form-actions">
                        <button class="action-btn primary-btn" onclick="confirmQuintuple()">ç¡®è®¤åˆ›å»º</button>
                        <button class="action-btn cancel-btn" onclick="hideEditForms()">å–æ¶ˆ</button>
                    </div>
                </div>
            `;
            
            // è®¾ç½®æŒ‰é’®çŠ¶æ€
            resetButtonStates();
            document.querySelector('.quintuple-btn').classList.add('active');
        }
        
        function confirmQuintuple() {
            // TODO: äº”å…ƒç»„åˆ›å»ºé€»è¾‘ï¼Œæš‚æœªå®è£…
            alert('äº”å…ƒç»„åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­ï¼Œæ•¬è¯·æœŸå¾…ï¼');
        }
        
        function hideEditForms() {
            // æ¸…ç©ºåŠŸèƒ½è¡¨å•åŒºåŸŸ
            const editForms = document.querySelector('.edit-forms');
            editForms.innerHTML = '';
            resetButtonStates();
            
            // ç¦ç”¨åˆ é™¤æ¨¡å¼
            deleteMode = false;
            
            // æ¢å¤æ‰€æœ‰é€‰ä¸­é¡¹ç›®çš„æ­£å¸¸æ ·å¼
            updateSelectedItemsStyle();
            
            // å¦‚æœæ­£åœ¨åˆ›å»ºèŠ‚ç‚¹ï¼Œå–æ¶ˆåˆ›å»º
            if (isCreatingNode) {
                cleanupNodeCreation();
            }
        }
        
        // ç¡®è®¤åˆ é™¤å‡½æ•°
        async function confirmDelete() {
            if (recentSelectedNodes.length === 0) {
                alert('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„èŠ‚ç‚¹æˆ–å…³ç³»');
                return;
            }
            
            // è®¡ç®—å°†è¦åˆ é™¤çš„æ‰€æœ‰å†…å®¹
            let totalNodeCount = 0;
            let totalRelationshipCount = 0;
            let itemDescriptions = [];
            
            recentSelectedNodes.forEach((item, index) => {
                if (item.type === 'node') {
                    totalNodeCount += 1;
                    const relatedCount = graphData.links.filter(link => 
                        link.source.id === item.data.id || link.target.id === item.data.id
                    ).length;
                    totalRelationshipCount += relatedCount;
                    itemDescriptions.push(`èŠ‚ç‚¹"${item.data.label}"ï¼ˆåŒ…å«${relatedCount}ä¸ªå…³ç³»ï¼‰`);
                } else if (item.type === 'relationship') {
                    totalRelationshipCount += 1;
                    const sourceNode = graphData.nodes.find(node => node.id === item.data.source.id);
                    const targetNode = graphData.nodes.find(node => node.id === item.data.target.id);
                    itemDescriptions.push(`å…³ç³»"${item.data.type}" (ä»"${sourceNode ? sourceNode.label : 'Unknown'}"åˆ°"${targetNode ? targetNode.label : 'Unknown'}")`);
                }
            });
            
            // æ„å»ºç¡®è®¤åˆ é™¤æ¶ˆæ¯
            let confirmMessage = `ç¡®è®¤åˆ é™¤ä»¥ä¸‹${recentSelectedNodes.length}ä¸ªé¡¹ç›®ï¼Ÿ\n\n`;
            confirmMessage += `åˆ é™¤åˆ—è¡¨ï¼š\n`;
            itemDescriptions.forEach((desc, index) => {
                confirmMessage += `${index + 1}. ${desc}\n`;
            });
            confirmMessage += `\næ­¤æ“ä½œå°†æ€»å…±åˆ é™¤ï¼š\n`;
            if (totalNodeCount > 0) {
                confirmMessage += `â€¢ ${totalNodeCount} ä¸ªèŠ‚ç‚¹\n`;
            }
            if (totalRelationshipCount > 0) {
                confirmMessage += `â€¢ ${totalRelationshipCount} ä¸ªå…³ç³»\n`;
            }
            confirmMessage += `\næ­¤æ“ä½œä¸å¯æ’¤é”€ï¼Œç¡®å®šè¦ç»§ç»­å—ï¼Ÿ`;
            
            // è¿›è¡Œåˆ é™¤ç¡®è®¤
            if (!confirm(confirmMessage)) {
                return;
            }
            
            try {
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                const confirmBtn = document.querySelector('.danger-btn');
                const originalText = confirmBtn.textContent;
                confirmBtn.textContent = 'åˆ é™¤ä¸­...';
                confirmBtn.disabled = true;
                
                // æŒ‰ç±»å‹åˆ†ç»„åˆ é™¤é¡¹ç›®
                const nodesToDelete = recentSelectedNodes.filter(item => item.type === 'node');
                const relationshipsToDelete = recentSelectedNodes.filter(item => item.type === 'relationship');
                
                let deleteResults = [];
                
                // åˆ é™¤èŠ‚ç‚¹
                for (const nodeItem of nodesToDelete) {
                    try {
                        const response = await fetch('/api/delete_item', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                element_id: nodeItem.data.neo4j_id
                            })
                        });
                        
                        const result = await response.json();
                        deleteResults.push({
                            type: 'node',
                            name: nodeItem.data.label,
                            success: result.success,
                            error: result.error
                        });
                    } catch (error) {
                        deleteResults.push({
                            type: 'node',
                            name: nodeItem.data.label,
                            success: false,
                            error: error.message
                        });
                    }
                }
                
                // åˆ é™¤å…³ç³»
                for (const relationshipItem of relationshipsToDelete) {
                    try {
                        const response = await fetch('/api/delete_item', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                element_id: relationshipItem.data.neo4j_id
                            })
                        });
                        
                        const result = await response.json();
                        deleteResults.push({
                            type: 'relationship',
                            name: relationshipItem.data.type,
                            success: result.success,
                            error: result.error
                        });
                    } catch (error) {
                        deleteResults.push({
                            type: 'relationship',
                            name: relationshipItem.data.type,
                            success: false,
                            error: error.message
                        });
                    }
                }
                
                // ç»Ÿè®¡ç»“æœ
                const successCount = deleteResults.filter(r => r.success).length;
                const failCount = deleteResults.filter(r => !r.success).length;
                
                if (successCount > 0) {
                    // æ¸…ç©ºæœ€è¿‘é€‰æ‹©çš„é¡¹ç›®
                    recentSelectedNodes = [];
                    // éšè—ç¼–è¾‘è¡¨å•
                    hideEditForms();
                    // éšè—è¯¦æƒ…é¢æ¿
                    document.getElementById("node-details").style.display = "none";
                    
                    // ä½¿ç”¨åŠ¨æ€æ›´æ–°ä»£æ›¿é¡µé¢åˆ·æ–°
                    const updateSuccess = await updateGraphData();
                    
                    let resultMessage = `æ‰¹é‡åˆ é™¤å®Œæˆï¼\n\n`;
                    resultMessage += `æˆåŠŸåˆ é™¤ï¼š${successCount} ä¸ªé¡¹ç›®\n`;
                    if (failCount > 0) {
                        resultMessage += `åˆ é™¤å¤±è´¥ï¼š${failCount} ä¸ªé¡¹ç›®\n\nå¤±è´¥é¡¹ç›®ï¼š\n`;
                        deleteResults.filter(r => !r.success).forEach(r => {
                            resultMessage += `- ${r.type === 'node' ? 'èŠ‚ç‚¹' : 'å…³ç³»'} "${r.name}": ${r.error}\n`;
                        });
                    }
                    
                    if (updateSuccess) {
                        resultMessage += `\nå›¾è°±å·²è‡ªåŠ¨æ›´æ–°æ˜¾ç¤ºæœ€æ–°æ•°æ®ã€‚`;
                    } else {
                        resultMessage += `\nå›¾è°±æ•°æ®æ›´æ–°å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨åˆ·æ–°é¡µé¢ã€‚`;
                    }
                    
                    alert(resultMessage);
                } else {
                    let errorMessage = `æ‰€æœ‰é¡¹ç›®åˆ é™¤å¤±è´¥ï¼š\n\n`;
                    deleteResults.forEach(r => {
                        errorMessage += `- ${r.type === 'node' ? 'èŠ‚ç‚¹' : 'å…³ç³»'} "${r.name}": ${r.error || 'æœªçŸ¥é”™è¯¯'}\n`;
                    });
                    alert(errorMessage);
                }
                
            } catch (error) {
                console.error('æ‰¹é‡åˆ é™¤æ“ä½œå¤±è´¥:', error);
                alert(`æ‰¹é‡åˆ é™¤æ“ä½œå¤±è´¥ï¼š${error.message}`);
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                const confirmBtn = document.querySelector('.danger-btn');
                if (confirmBtn) {
                    confirmBtn.textContent = originalText;
                    confirmBtn.disabled = false;
                }
            }
        }
        
        // åœ¨ç¼–è¾‘ç•Œé¢ä¸­é€‰æ‹©èŠ‚ç‚¹ç±»å‹
        function selectNodeTypeInEdit(nodeType) {
            // æ›´æ–°éšè—çš„è¾“å…¥æ¡†
            document.getElementById('edit-node-type').value = nodeType;
            
            // æ›´æ–°æŒ‰é’®æ ·å¼
            const entityBtn = document.getElementById('btn-entity');
            const characterBtn = document.getElementById('btn-character');
            const locationBtn = document.getElementById('btn-location');
            
            // é‡ç½®æ‰€æœ‰æŒ‰é’®æ ·å¼
            const buttons = [entityBtn, characterBtn, locationBtn];
            buttons.forEach(btn => {
                if (btn) {
                    btn.style.background = '#fff';
                    btn.style.color = '#495057';
                }
            });
            
            // è®¾ç½®é€‰ä¸­æŒ‰é’®æ ·å¼
            if (nodeType === 'Entity' && entityBtn) {
                entityBtn.style.background = '#007bff';
                entityBtn.style.color = '#fff';
            } else if (nodeType === 'Character' && characterBtn) {
                characterBtn.style.background = '#007bff';
                characterBtn.style.color = '#fff';
            } else if (nodeType === 'Location' && locationBtn) {
                locationBtn.style.background = '#007bff';
                locationBtn.style.color = '#fff';
            }
            
            // æ›´æ–°åŠ¨æ€å±æ€§æ˜¾ç¤º
            updateDynamicProperties(nodeType);
        }
        
        // æ›´æ–°åŠ¨æ€å±æ€§æ˜¾ç¤ºåŒºåŸŸ
        function updateDynamicProperties(nodeType) {
            const container = document.getElementById('dynamic-properties-container');
            const selectedItem = recentSelectedNodes[0];
            if (!container || !selectedItem) {
                return;
            }
            
            const item = selectedItem.data;
            let propertiesHtml = '';
            
            if (nodeType === 'Entity') {
                // è·å–å®ä½“çš„å½“å‰å€¼ï¼Œç¡®ä¿å®‰å…¨è½¬ä¹‰
                const entityName = (item.properties.name || item.label || '').replace(/"/g, '&quot;');
                const entityImportance = (item.properties.importance || item.properties['å®ä½“é‡è¦æ€§'] || '').toString().replace(/"/g, '&quot;');
                const entityDescription = (item.properties.note || item.properties['å®ä½“æè¿°'] || item.properties.description || 'æ— ').replace(/"/g, '&quot;');
                const entityContext = (item.properties.context || 'realityç°å®').replace(/"/g, '&quot;');
                
                propertiesHtml = `
                    <label style="font-weight: 600; color: #495057; margin-bottom: 8px; display: block;">å®ä½“å±æ€§:</label>
                    <div style="border: 1px solid #e0e0e0; border-radius: 6px; padding: 12px; margin-bottom: 15px;">
                        <div class="form-group" style="margin-bottom: 12px;">
                            <label for="edit-entity-name" style="font-weight: 600; color: #0c5460; margin-bottom: 4px; display: block;">å®ä½“åç§°ï¼š</label>
                            <input type="text" id="edit-entity-name" value="${entityName}" style="width: 100%; padding: 6px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;" placeholder="è¯·è¾“å…¥å®ä½“åç§°">
                        </div>
                        <div class="form-group" style="margin-bottom: 12px;">
                            <label for="edit-entity-importance" style="font-weight: 600; color: #0c5460; margin-bottom: 4px; display: block;">å®ä½“é‡è¦æ€§ï¼š</label>
                            <input type="text" id="edit-entity-importance" value="${entityImportance}" style="width: 100%; padding: 6px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;" placeholder="å–å€¼èŒƒå›´0-1ï¼ˆé»˜è®¤0.75ï¼‰">
                        </div>
                        <div class="form-group" style="margin-bottom: 12px;">
                            <label for="edit-entity-context" style="font-weight: 600; color: #0c5460; margin-bottom: 4px; display: block;">ä¸Šä¸‹æ–‡ï¼š</label>
                            <input type="text" id="edit-entity-context" value="${entityContext}" style="width: 100%; padding: 6px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;" placeholder="å®ä½“æ‰€å±ä¸Šä¸‹æ–‡ï¼ˆé»˜è®¤realityç°å®ï¼‰">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="edit-entity-description" style="font-weight: 600; color: #0c5460; margin-bottom: 4px; display: block;">å®ä½“æè¿°ï¼š</label>
                            <textarea id="edit-entity-description" style="width: 100%; padding: 6px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; resize: vertical;" rows="3" placeholder="å¤‡æ³¨ä¿¡æ¯ï¼ˆé€‰å¡«ï¼‰">${entityDescription}</textarea>
                        </div>
                    </div>
                `;
            } else if (nodeType === 'Character') {
                // è·å–è§’è‰²çš„å½“å‰å€¼ï¼Œç¡®ä¿å®‰å…¨è½¬ä¹‰
                const characterName = (item.properties.name || item.label || '').replace(/"/g, '&quot;');
                const characterTrust = (item.properties.trust || item.properties['è§’è‰²ç½®ä¿¡åº¦'] || '').toString().replace(/"/g, '&quot;');
                const characterImportance = (item.properties.importance || item.properties['è§’è‰²é‡è¦æ€§'] || '').toString().replace(/"/g, '&quot;');
                const characterContext = (item.properties.context || 'realityç°å®').replace(/"/g, '&quot;');
                
                propertiesHtml = `
                    <label style="font-weight: 600; color: #495057; margin-bottom: 8px; display: block;">è§’è‰²å±æ€§:</label>
                    <div style="border: 1px solid #e0e0e0; border-radius: 6px; padding: 12px; margin-bottom: 15px;">
                        <div class="form-group" style="margin-bottom: 12px;">
                            <label for="edit-character-name" style="font-weight: 600; color: #0c5460; margin-bottom: 4px; display: block;">è§’è‰²åç§°ï¼š</label>
                            <input type="text" id="edit-character-name" value="${characterName}" style="width: 100%; padding: 6px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;" placeholder="è¯·è¾“å…¥è§’è‰²åç§°">
                        </div>
                        <div class="form-group" style="margin-bottom: 12px;">
                            <label for="edit-character-trust" style="font-weight: 600; color: #0c5460; margin-bottom: 4px; display: block;">è§’è‰²ç½®ä¿¡åº¦ï¼š</label>
                            <input type="text" id="edit-character-trust" value="${characterTrust}" style="width: 100%; padding: 6px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;" placeholder="å–å€¼èŒƒå›´0-1ï¼ˆé»˜è®¤0.75ï¼‰">
                        </div>
                        <div class="form-group" style="margin-bottom: 12px;">
                            <label for="edit-character-importance" style="font-weight: 600; color: #0c5460; margin-bottom: 4px; display: block;">è§’è‰²é‡è¦æ€§ï¼š</label>
                            <input type="text" id="edit-character-importance" value="${characterImportance}" style="width: 100%; padding: 6px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;" placeholder="å–å€¼èŒƒå›´0-1ï¼ˆé»˜è®¤0.75ï¼‰">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="edit-character-context" style="font-weight: 600; color: #0c5460; margin-bottom: 4px; display: block;">ä¸Šä¸‹æ–‡ï¼š</label>
                            <input type="text" id="edit-character-context" value="${characterContext}" style="width: 100%; padding: 6px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;" placeholder="è§’è‰²æ‰€å±ä¸Šä¸‹æ–‡ï¼ˆé»˜è®¤realityç°å®ï¼‰">
                        </div>
                    </div>
                `;
            } else if (nodeType === 'Location') {
                // è·å–åœ°ç‚¹çš„å½“å‰å€¼ï¼Œç¡®ä¿å®‰å…¨è½¬ä¹‰
                const locationName = (item.properties.name || item.label || '').replace(/"/g, '&quot;');
                const locationContext = (item.properties.context || 'realityç°å®').replace(/"/g, '&quot;');
                
                propertiesHtml = `
                    <label style="font-weight: 600; color: #495057; margin-bottom: 8px; display: block;">åœ°ç‚¹å±æ€§:</label>
                    <div style="border: 1px solid #e0e0e0; border-radius: 6px; padding: 12px; margin-bottom: 15px;">
                        <div class="form-group" style="margin-bottom: 12px;">
                            <label for="edit-location-name" style="font-weight: 600; color: #0c5460; margin-bottom: 4px; display: block;">åœ°ç‚¹åç§°ï¼š</label>
                            <input type="text" id="edit-location-name" value="${locationName}" style="width: 100%; padding: 6px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;" placeholder="è¯·è¾“å…¥åœ°ç‚¹åç§°">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="edit-location-context" style="font-weight: 600; color: #0c5460; margin-bottom: 4px; display: block;">ä¸Šä¸‹æ–‡ï¼š</label>
                            <input type="text" id="edit-location-context" value="${locationContext}" style="width: 100%; padding: 6px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;" placeholder="åœ°ç‚¹æ‰€å±ä¸Šä¸‹æ–‡ï¼ˆé»˜è®¤realityç°å®ï¼‰">
                        </div>
                    </div>
                `;
            } else if (nodeType === 'relationship' && selectedItem && selectedItem.type === 'relationship') {
                // å¤„ç†å…³ç³»ç±»å‹
                const item = selectedItem.data;
                
                // è·å–èµ·å§‹å’Œç›®æ ‡èŠ‚ç‚¹ä¿¡æ¯
                const sourceNode = graphData.nodes.find(node => node.id === item.source.id);
                const targetNode = graphData.nodes.find(node => node.id === item.target.id);
                
                {
                    // æ­£å¸¸çš„å…³ç³»ç¼–è¾‘
                    // è·å–å…³ç³»çš„å½“å‰å€¼ï¼Œç¡®ä¿å®‰å…¨è½¬ä¹‰
                    const relationshipName = (item.type || '').replace(/"/g, '&quot;');
                    const relationshipConfidence = (item.properties && (item.properties.confidence || item.properties.weight)) ? 
                        (item.properties.confidence || item.properties.weight).toString().replace(/"/g, '&quot;') : '0.75';
                    const relationshipSource = (item.properties && item.properties.source) ? 
                        item.properties.source.toString().replace(/"/g, '&quot;') : '';
                    const relationshipEvidence = (item.properties && item.properties.evidence) ? 
                        item.properties.evidence.toString().replace(/"/g, '&quot;') : '';
                    
                    propertiesHtml = `
                        <label style="font-weight: 600; color: #495057; margin-bottom: 8px; display: block;">å…³ç³»å±æ€§:</label>
                        <div style="border: 1px solid #e0e0e0; border-radius: 6px; padding: 12px; margin-bottom: 15px;">
                            <div class="form-group" style="margin-bottom: 12px;">
                                <label for="edit-relationship-name" style="font-weight: 600; color: #0c5460; margin-bottom: 4px; display: block;">å…³ç³»åç§°ï¼š</label>
                                <input type="text" id="edit-relationship-name" value="${relationshipName}" style="width: 100%; padding: 6px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;" placeholder="è¯·è¾“å…¥å…³ç³»åç§°">
                            </div>
                            <div class="form-group" style="margin-bottom: 12px;">
                                <label for="edit-relationship-confidence" style="font-weight: 600; color: #0c5460; margin-bottom: 4px; display: block;">ç½®ä¿¡åº¦ï¼š</label>
                                <input type="number" id="edit-relationship-confidence" value="${relationshipConfidence}" min="0" max="1" step="0.1" style="width: 100%; padding: 6px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;" placeholder="å–å€¼èŒƒå›´0-1ï¼ˆé»˜è®¤0.75ï¼‰">
                            </div>
                            <div class="form-group" style="margin-bottom: 12px;">
                                <label for="edit-relationship-source" style="font-weight: 600; color: #0c5460; margin-bottom: 4px; display: block;">å…³ç³»æ¥æºï¼š</label>
                                <input type="text" id="edit-relationship-source" value="${relationshipSource}" style="width: 100%; padding: 6px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;" placeholder="è¯·è¾“å…¥å…³ç³»æ¥æºï¼ˆé»˜è®¤manual_inputï¼‰">
                            </div>
                            <div class="form-group" style="margin-bottom: 12px;">
                                <label for="edit-relationship-evidence" style="font-weight: 600; color: #0c5460; margin-bottom: 4px; display: block;">å…³ç³»è¯æ®ï¼š</label>
                                <textarea id="edit-relationship-evidence" style="width: 100%; padding: 6px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; min-height: 60px; resize: vertical;" placeholder="è¯·è¾“å…¥å…³ç³»è¯æ®ï¼ˆä¸ºä»€ä¹ˆè®¾ç½®è¿™ä¸ªç½®ä¿¡åº¦ï¼‰">${relationshipEvidence}</textarea>
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label for="edit-relationship-direction" style="font-weight: 600; color: #0c5460; margin-bottom: 4px; display: block;">å…³ç³»æ–¹å‘ï¼š</label>
                                <select id="edit-relationship-direction" style="width: 100%; padding: 6px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                                    <option value="to_endNode">${sourceNode ? sourceNode.label : 'Unknown'} â†’ ${targetNode ? targetNode.label : 'Unknown'}</option>
                                    <option value="to_startNode">${targetNode ? targetNode.label : 'Unknown'} â†’ ${sourceNode ? sourceNode.label : 'Unknown'}</option>
                                    <option value="bidirectional">åŒå‘å…³ç³»</option>
                                </select>
                            </div>
                        </div>
                    `;
                }
            }
            
            container.innerHTML = propertiesHtml;
        }
        
        // ç¡®è®¤èŠ‚ç‚¹ä¿®æ”¹å‡½æ•°
        async function confirmNodeModification() {
            const selectedItem = recentSelectedNodes[0];
            if (!selectedItem || (selectedItem.type !== 'node' && selectedItem.type !== 'relationship')) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªèŠ‚ç‚¹æˆ–å…³ç³»è¿›è¡Œä¿®æ”¹');
                return;
            }
            
            // å¦‚æœæ˜¯å…³ç³»ç±»å‹ï¼Œå•ç‹¬å¤„ç†
            if (selectedItem.type === 'relationship') {
                const item = selectedItem.data;
                
                const relationshipNameInput = document.getElementById('edit-relationship-name');
                const relationshipConfidenceInput = document.getElementById('edit-relationship-confidence');
                const relationshipSourceInput = document.getElementById('edit-relationship-source');
                const relationshipEvidenceInput = document.getElementById('edit-relationship-evidence');
                const relationshipDirectionInput = document.getElementById('edit-relationship-direction');
                
                if (!relationshipNameInput || !relationshipNameInput.value.trim()) {
                    alert('å…³ç³»åç§°ä¸èƒ½ä¸ºç©º');
                    return;
                }
                
                const newRelationshipName = relationshipNameInput.value.trim();
                const modifiedProperties = {};
                
                if (relationshipConfidenceInput && relationshipConfidenceInput.value.trim()) {
                    const confidence = parseFloat(relationshipConfidenceInput.value.trim());
                    if (!isNaN(confidence) && confidence >= 0 && confidence <= 1) {
                        modifiedProperties['confidence'] = confidence;
                    } else {
                        alert('ç½®ä¿¡åº¦å¿…é¡»åœ¨0-1ä¹‹é—´');
                        return;
                    }
                }
                
                if (relationshipSourceInput && relationshipSourceInput.value.trim()) {
                    modifiedProperties['source'] = relationshipSourceInput.value.trim();
                } else {
                    // å¦‚æœæ²¡æœ‰å¡«å†™sourceï¼Œä½¿ç”¨é»˜è®¤å€¼
                    modifiedProperties['source'] = 'manual_input';
                }
                
                if (relationshipEvidenceInput) {
                    modifiedProperties['evidence'] = relationshipEvidenceInput.value.trim() || selectedItem.data.properties.evidence || '';
                } else {
                    modifiedProperties['evidence'] = selectedItem.data.properties.evidence || '';
                }
                
                const direction = relationshipDirectionInput ? relationshipDirectionInput.value : 'to_endNode';
                
                // è·å–èŠ‚ç‚¹ä¿¡æ¯ç”¨äºåç»­åé¦ˆ
                const sourceNode = graphData.nodes.find(node => node.id === selectedItem.data.source.id);
                const targetNode = graphData.nodes.find(node => node.id === selectedItem.data.target.id);
                
                let directionText = '';
                if (direction === 'to_startNode') {
                    directionText = `${targetNode ? targetNode.label : 'Unknown'} â†’ ${sourceNode ? sourceNode.label : 'Unknown'}`;
                } else if (direction === 'bidirectional') {
                    directionText = `${sourceNode ? sourceNode.label : 'Unknown'} â†” ${targetNode ? targetNode.label : 'Unknown'}`;
                } else {
                    directionText = `${sourceNode ? sourceNode.label : 'Unknown'} â†’ ${targetNode ? targetNode.label : 'Unknown'}`;
                }
                
                try {
                    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                    const confirmBtn = document.querySelector('.primary-btn');
                    const originalText = confirmBtn.textContent;
                    confirmBtn.textContent = 'ä¿®æ”¹ä¸­...';
                    confirmBtn.disabled = true;
                    
                    // è°ƒç”¨å…³ç³»ä¿®æ”¹API
                    const response = await fetch('/api/modify_relation', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            relation_id: selectedItem.data.neo4j_id,
                            predicate: newRelationshipName,
                            source: modifiedProperties.source || selectedItem.data.source_type || 'neo4j',
                            confidence: modifiedProperties.confidence || 0.75,
                            directivity: direction,
                            evidence: modifiedProperties.evidence || ''
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        // éšè—ç¼–è¾‘è¡¨å•
                        hideEditForms();
                        // éšè—è¯¦æƒ…é¢æ¿
                        document.getElementById("node-details").style.display = "none";
                        // ä½¿ç”¨åŠ¨æ€æ›´æ–°ä»£æ›¿é¡µé¢åˆ·æ–°
                        const updateSuccess = await updateGraphData();
                        if (updateSuccess) {
                            alert(`å…³ç³»ä¿®æ”¹æˆåŠŸï¼\n\n${directionText}\nå…³ç³»ç±»å‹ï¼š${newRelationshipName}\n\nå›¾è°±å·²è‡ªåŠ¨æ›´æ–°æ˜¾ç¤ºæœ€æ–°æ•°æ®ã€‚`);
                        } else {
                            alert(`å…³ç³»ä¿®æ”¹æˆåŠŸï¼\n\nå›¾è°±æ•°æ®æ›´æ–°å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨åˆ·æ–°é¡µé¢ã€‚`);
                        }
                    } else {
                        alert(`å…³ç³»ä¿®æ”¹å¤±è´¥ï¼š${result.error || 'æœªçŸ¥é”™è¯¯'}`);
                    }
                    
                } catch (error) {
                    console.error('å…³ç³»ä¿®æ”¹æ“ä½œå¤±è´¥:', error);
                    alert(`å…³ç³»ä¿®æ”¹æ“ä½œå¤±è´¥ï¼š${error.message}`);
                } finally {
                    // æ¢å¤æŒ‰é’®çŠ¶æ€
                    const confirmBtn = document.querySelector('.primary-btn');
                    if (confirmBtn) {
                        confirmBtn.textContent = originalText;
                        confirmBtn.disabled = false;
                    }
                }
                
                return;
            }
            
            // å¤„ç†èŠ‚ç‚¹ç±»å‹çš„ä¿®æ”¹
            const newNodeType = document.getElementById('edit-node-type').value.trim();
            
            if (!newNodeType) {
                alert('èŠ‚ç‚¹ç±»å‹ä¸èƒ½ä¸ºç©º');
                return;
            }
            
            // æ”¶é›†åŠ¨æ€å±æ€§çš„ä¿®æ”¹å€¼
            const modifiedProperties = {};
            modifiedProperties['node_type'] = newNodeType;

            if (newNodeType === 'Entity') {
                // æ”¶é›†å®ä½“å±æ€§
                const entityNameInput = document.getElementById('edit-entity-name');
                const entityImportanceInput = document.getElementById('edit-entity-importance');
                const entityDescriptionInput = document.getElementById('edit-entity-description');
                const entityContextInput = document.getElementById('edit-entity-context');
                
                if (entityNameInput && entityNameInput.value.trim()) {
                    modifiedProperties['name'] = entityNameInput.value.trim();
                }
                if (entityImportanceInput && entityImportanceInput.value.trim()) {
                    const importance = parseFloat(entityImportanceInput.value.trim());
                    if (!isNaN(importance) && importance >= 0 && importance <= 1) {
                        modifiedProperties['importance'] = importance;
                    } else if (entityImportanceInput.value.trim() !== '') {
                        alert('å®ä½“é‡è¦æ€§å¿…é¡»åœ¨0-1ä¹‹é—´');
                        return;
                    }
                }
                if (entityContextInput && entityContextInput.value.trim()) {
                    modifiedProperties['context'] = entityContextInput.value.trim();
                }
                if (entityDescriptionInput) {
                    const description = entityDescriptionInput.value.trim() || 'æ— ';
                    modifiedProperties['note'] = description;
                }
            } else if (newNodeType === 'Character') {
                // æ”¶é›†è§’è‰²å±æ€§
                const characterNameInput = document.getElementById('edit-character-name');
                const characterTrustInput = document.getElementById('edit-character-trust');
                const characterImportanceInput = document.getElementById('edit-character-importance');
                const characterContextInput = document.getElementById('edit-character-context');
                
                if (characterNameInput && characterNameInput.value.trim()) {
                    modifiedProperties['name'] = characterNameInput.value.trim();
                }
                if (characterTrustInput && characterTrustInput.value.trim()) {
                    const trust = parseFloat(characterTrustInput.value.trim());
                    if (!isNaN(trust) && trust >= 0 && trust <= 1) {
                        modifiedProperties['trust'] = trust;
                    } else if (characterTrustInput.value.trim() !== '') {
                        alert('è§’è‰²ç½®ä¿¡åº¦å¿…é¡»åœ¨0-1ä¹‹é—´');
                        return;
                    }
                }
                if (characterImportanceInput && characterImportanceInput.value.trim()) {
                    const importance = parseFloat(characterImportanceInput.value.trim());
                    if (!isNaN(importance) && importance >= 0 && importance <= 1) {
                        modifiedProperties['importance'] = importance;
                    } else if (characterImportanceInput.value.trim() !== '') {
                        alert('è§’è‰²é‡è¦æ€§å¿…é¡»åœ¨0-1ä¹‹é—´');
                        return;
                    }
                }
                if (characterContextInput && characterContextInput.value.trim()) {
                    modifiedProperties['context'] = characterContextInput.value.trim();
                }
            } else if (newNodeType === 'Location') {
                // æ”¶é›†åœ°ç‚¹å±æ€§
                const locationNameInput = document.getElementById('edit-location-name');
                const locationContextInput = document.getElementById('edit-location-context');
                
                if (locationNameInput && locationNameInput.value.trim()) {
                    modifiedProperties['name'] = locationNameInput.value.trim();
                }
                if (locationContextInput && locationContextInput.value.trim()) {
                    modifiedProperties['context'] = locationContextInput.value.trim();
                }
            }
            
            // æ”¶é›†å…¶ä»–å±æ€§çš„ä¿®æ”¹å€¼
            for (const [key, value] of Object.entries(selectedItem.data.properties)) {
                if (!EXCLUDED_PROPERTIES.includes(key)) {
                    const inputElement = document.getElementById(`edit-property-${key}`);
                    if (inputElement) {
                        const newValue = inputElement.value.trim();
                        if (newValue !== '') {
                            // å°è¯•è§£æä¸ºåŸå§‹ç±»å‹ï¼Œå¦‚æœå¤±è´¥åˆ™ä½œä¸ºå­—ç¬¦ä¸²
                            try {
                                modifiedProperties[key] = JSON.parse(newValue);
                            } catch {
                                modifiedProperties[key] = newValue;
                            }
                        }
                    }
                }
            }
            
            
            // å®ç°èŠ‚ç‚¹ä¿®æ”¹é€»è¾‘
            try {
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                const confirmBtn = document.querySelector('.primary-btn');
                const originalText = confirmBtn.textContent;
                confirmBtn.textContent = 'ä¿®æ”¹ä¸­...';
                confirmBtn.disabled = true;
                
                // å‡†å¤‡APIè°ƒç”¨æ•°æ®
                const updateData = {
                    element_id: selectedItem.data.neo4j_id,
                    updates: modifiedProperties
                };
                
                console.log('èŠ‚ç‚¹ä¿®æ”¹å‚æ•°:', {
                    nodeId: selectedItem.data.neo4j_id,
                    originalType: selectedItem.data.labels.join(', '),
                    originalName: selectedItem.data.label,
                    newType: newNodeType,
                    modifiedProperties: modifiedProperties
                });
                
                // è°ƒç”¨èŠ‚ç‚¹ä¿®æ”¹API
                const response = await fetch('/api/modify_node', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(updateData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // éšè—ç¼–è¾‘è¡¨å•
                    hideEditForms();
                    // éšè—è¯¦æƒ…é¢æ¿
                    document.getElementById("node-details").style.display = "none";
                    // ä½¿ç”¨åŠ¨æ€æ›´æ–°ä»£æ›¿é¡µé¢åˆ·æ–°
                    const updateSuccess = await updateGraphData();
                    if (updateSuccess) {
                        alert(`èŠ‚ç‚¹ä¿®æ”¹æˆåŠŸï¼\n\nèŠ‚ç‚¹IDï¼š${result.element_id}\nèŠ‚ç‚¹ç±»å‹ï¼š${newNodeType}\n\nå›¾è°±å·²è‡ªåŠ¨æ›´æ–°æ˜¾ç¤ºæœ€æ–°æ•°æ®ã€‚`);
                    } else {
                        alert(`èŠ‚ç‚¹ä¿®æ”¹æˆåŠŸï¼\n\nå›¾è°±æ•°æ®æ›´æ–°å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨åˆ·æ–°é¡µé¢ã€‚`);
                    }
                } else {
                    alert(`èŠ‚ç‚¹ä¿®æ”¹å¤±è´¥ï¼š${result.error || 'æœªçŸ¥é”™è¯¯'}`);
                }
                
            } catch (error) {
                console.error('èŠ‚ç‚¹ä¿®æ”¹æ“ä½œå¤±è´¥:', error);
                alert(`èŠ‚ç‚¹ä¿®æ”¹æ“ä½œå¤±è´¥ï¼š${error.message}`);
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                const confirmBtn = document.querySelector('.primary-btn');
                if (confirmBtn) {
                    confirmBtn.textContent = originalText;
                    confirmBtn.disabled = false;
                }
            }
        }
        
        // ç¡®è®¤é“¾æ¥å‡½æ•°
        async function confirmLink() {
            if (recentSelectedNodes.length < 2) {
                alert('è¯·å…ˆé€‰æ‹©ä¸¤ä¸ªèŠ‚ç‚¹è¿›è¡Œé“¾æ¥');
                return;
            }
            
            // è·å–è¡¨å•æ•°æ®
            const predicate = document.getElementById('link-predicate').value.trim();
            const confidence = parseFloat(document.getElementById('link-confidence').value);
            const evidenceInput = document.getElementById('link-evidence');
            const evidence = evidenceInput ? evidenceInput.value.trim() || 'user manual input' : 'user manual input';
            const directionSelect = document.getElementById('link-direction');
            const direction = directionSelect.value;
            
            if (!predicate) {
                alert('è¯·è¾“å…¥å…³ç³»ç±»å‹');
                return;
            }
            
            if (isNaN(confidence) || confidence < 0 || confidence > 1) {
                alert('ç½®ä¿¡åº¦å¿…é¡»åœ¨0-1ä¹‹é—´');
                return;
            }
            
            const node1 = recentSelectedNodes[1].data;
            const node2 = recentSelectedNodes[0].data;
            
            // æ„å»ºç¡®è®¤é“¾æ¥æ¶ˆæ¯
            let directionText = '';
            if (direction === 'to_startNode') {
                directionText = `${node2.label} â†’ ${node1.label}`;
            } else if (direction === 'bidirectional') {
                directionText = `${node1.label} â†” ${node2.label}`;
            } else {
                directionText = `${node1.label} â†’ ${node2.label}`;
            }
            
            const confirmMessage = `ç¡®è®¤åˆ›å»ºä»¥ä¸‹é“¾æ¥ï¼Ÿ\n\nå…³ç³»ï¼š${predicate}\næ–¹å‘ï¼š${directionText}\nç½®ä¿¡åº¦ï¼š${confidence}\n\næ­¤æ“ä½œå°†åœ¨Neo4jæ•°æ®åº“ä¸­åˆ›å»ºæ–°çš„å…³ç³»ã€‚`;
            
            if (!confirm(confirmMessage)) {
                return;
            }
            
            try {
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                const confirmBtn = document.querySelector('.primary-btn');
                const originalText = confirmBtn.textContent;
                confirmBtn.textContent = 'é“¾æ¥ä¸­...';
                confirmBtn.disabled = true;
                
                // è°ƒç”¨åç«¯API
                const response = await fetch('/api/create_relation', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        startNode_id: node1.neo4j_id,
                        endNode_id: node2.neo4j_id,
                        predicate: predicate,
                        source: 'manual_input',
                        confidence: confidence,
                        directivity: direction,
                        evidence: evidence
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // æ¸…ç©ºé€‰æ‹©çš„èŠ‚ç‚¹
                    recentSelectedNodes = [];
                    // éšè—ç¼–è¾‘è¡¨å•
                    hideEditForms();
                    // ä½¿ç”¨åŠ¨æ€æ›´æ–°ä»£æ›¿é¡µé¢åˆ·æ–°
                    const updateSuccess = await updateGraphData();
                    if (updateSuccess) {
                        alert(`é“¾æ¥åˆ›å»ºæˆåŠŸï¼\n\nå…³ç³»IDï¼š${result.relationship_id}\nå›¾è°±å·²è‡ªåŠ¨æ›´æ–°æ˜¾ç¤ºæœ€æ–°æ•°æ®ã€‚`);
                    } else {
                        alert(`é“¾æ¥åˆ›å»ºæˆåŠŸï¼\n\nå…³ç³»IDï¼š${result.relationship_id}\nå›¾è°±æ•°æ®æ›´æ–°å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨åˆ·æ–°é¡µé¢ã€‚`);
                    }
                } else {
                    alert(`é“¾æ¥åˆ›å»ºå¤±è´¥ï¼š${result.error || 'æœªçŸ¥é”™è¯¯'}`);
                }
                
            } catch (error) {
                console.error('é“¾æ¥æ“ä½œå¤±è´¥:', error);
                alert(`é“¾æ¥æ“ä½œå¤±è´¥ï¼š${error.message}`);
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                const confirmBtn = document.querySelector('.primary-btn');
                if (confirmBtn) {
                    confirmBtn.textContent = originalText;
                    confirmBtn.disabled = false;
                }
            }
        }
        
        // å…³é—­èŠ‚ç‚¹è¯¦æƒ…é¢æ¿
        function closeNodeDetails() {
            const detailsDiv = document.getElementById("node-details");
            detailsDiv.style.display = "none";
            clearSelection();
        }
        
        // æ¸…ç©ºé€‰ä¸­é¡¹ç›®ï¼ˆå½“è¯¦æƒ…é¢æ¿å…³é—­æ—¶ï¼‰
        function clearSelection() {
            selectedItem = null;
            // å¦‚æœåˆ é™¤ç•Œé¢å·²æ‰“å¼€ï¼Œå®æ—¶æ›´æ–°åˆ é™¤å†…å®¹
            updateDeleteFormIfVisible();
            // å¦‚æœä¿®æ”¹ç•Œé¢å·²æ‰“å¼€ï¼Œå®æ—¶æ›´æ–°ä¿®æ”¹å†…å®¹
            updateModifyFormIfVisible();
        }
        
        function resetButtonStates() {
            document.querySelectorAll('.edit-function-button').forEach(btn => {
                btn.classList.remove('active');
            });
        }
        
        // æ·»åŠ å…¨å±€å˜é‡ç”¨äºè·Ÿè¸ªèŠ‚ç‚¹åˆ›å»ºçŠ¶æ€
        let isCreatingNode = false;
        let newNodeData = null;
        let ghostNode = null;
        
        // é€‰æ‹©èŠ‚ç‚¹ç±»å‹
        function selectNodeType(nodeType) {
            // å…ˆé‡ç½®æ‰€æœ‰æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.node-type-button').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            // è®¾ç½®å½“å‰é€‰ä¸­æŒ‰é’®çš„çŠ¶æ€
            event.target.closest('.node-type-button').classList.add('selected');
            
            if (nodeType === 'Time') {
                showTimeNodeForm();
            } else if (nodeType === 'Entity') {
                showEntityNodeForm();
            } else if (nodeType === 'Character') {
                showCharacterNodeForm();
            } else if (nodeType === 'Location') {
                showLocationNodeForm();
            }
        }
        
        // æ˜¾ç¤ºæ—¶é—´èŠ‚ç‚¹åˆ›å»ºè¡¨å•
        function showTimeNodeForm() {
            const userInputForm = document.getElementById('user-input-form');
            userInputForm.style.display = 'block';
            userInputForm.innerHTML = `
                <div class="time-node-form">
                    <h4>åˆ›å»ºæ—¶é—´èŠ‚ç‚¹</h4>
                    <div class="form-group">
                        <label for="time-input">è¯·è¾“å…¥æ—¶é—´ï¼š</label>
                        <input type="text" id="time-input" placeholder="ä¾‹å¦‚ï¼š2024å¹´12æœˆ5æ—¥14ç‚¹30åˆ†" class="time-input" />
                        <div class="time-format-help">
                            æ”¯æŒæ ¼å¼ï¼š
                            <ul>
                                <li>å®Œæ•´æ ¼å¼ï¼š2024å¹´12æœˆ5æ—¥14ç‚¹30åˆ†45ç§’</li>
                                <li>æ—¥æœŸæ ¼å¼ï¼š2024å¹´12æœˆ5æ—¥</li>
                                <li>æ—¶é—´æ ¼å¼ï¼š14ç‚¹30åˆ†</li>
                                <li>å‘¨æ¬¡æ ¼å¼ï¼šç¬¬3ä¸ªæ˜ŸæœŸä¸€</li>
                                <li>ç›¸å¯¹æ ¼å¼ï¼šä¸‰ç‚¹åŠ</li>
                            </ul>
                        </div>
                    </div>
                    <div class="form-buttons">
                        <button class="create-btn" onclick="createTimeNode()">åˆ›å»ºæ—¶é—´èŠ‚ç‚¹</button>
                        <button class="cancel-btn" onclick="hideUserInputForm()">å–æ¶ˆ</button>
                    </div>
                </div>
            `;
            
            // èšç„¦åˆ°è¾“å…¥æ¡†
            setTimeout(() => {
                document.getElementById('time-input').focus();
            }, 100);
            
            // æ·»åŠ å›è½¦é”®ç›‘å¬
            document.getElementById('time-input').addEventListener('keypress', function(event) {
                if (event.key === 'Enter') {
                    createTimeNode();
                }
            });
        }
        
        // æ˜¾ç¤ºå®ä½“èŠ‚ç‚¹åˆ›å»ºè¡¨å•
        function showEntityNodeForm() {
            const userInputForm = document.getElementById('user-input-form');
            userInputForm.style.display = 'block';
            userInputForm.innerHTML = `
                <div class="entity-node-form">
                    <h4>åˆ›å»ºå®ä½“èŠ‚ç‚¹</h4>
                    <div class="form-group">
                        <label for="entity-name-input">å®ä½“åç§°ï¼š</label>
                        <input type="text" id="entity-name-input" placeholder="è¯·è¾“å…¥å®ä½“åç§°" class="time-input" />
                    </div>
                    <div class="form-group">
                        <label for="entity-importance-input">å®ä½“é‡è¦æ€§ï¼š</label>
                        <input type="text" id="entity-importance-input" placeholder="å–å€¼èŒƒå›´0-1ï¼ˆé»˜è®¤0.75ï¼‰" class="time-input" />
                    </div>
                    <div class="form-group">
                        <label for="entity-description-input">å®ä½“æè¿°ï¼š</label>
                        <textarea id="entity-description-input" placeholder="å¤‡æ³¨ä¿¡æ¯ï¼ˆé€‰å¡«ï¼‰" class="time-input" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="entity-context-input">ä¸Šä¸‹æ–‡ç¯å¢ƒï¼š</label>
                        <input type="text" id="entity-context-input" value="realityç°å®" placeholder="è¾“å…¥ä¸Šä¸‹æ–‡ç¯å¢ƒ" class="time-input" />
                    </div>
                    <div class="form-buttons">
                        <button class="create-btn" onclick="createEntityNode()">åˆ›å»ºå®ä½“èŠ‚ç‚¹</button>
                        <button class="cancel-btn" onclick="hideUserInputForm()">å–æ¶ˆ</button>
                    </div>
                </div>
            `;
            
            // èšç„¦åˆ°è¾“å…¥æ¡†
            setTimeout(() => {
                document.getElementById('entity-name-input').focus();
            }, 100);
        }
        
        // æ˜¾ç¤ºè§’è‰²èŠ‚ç‚¹åˆ›å»ºè¡¨å•
        function showCharacterNodeForm() {
            const userInputForm = document.getElementById('user-input-form');
            userInputForm.style.display = 'block';
            userInputForm.innerHTML = `
                <div class="character-node-form">
                    <h4>åˆ›å»ºè§’è‰²èŠ‚ç‚¹</h4>
                    <div class="form-group">
                        <label for="character-name-input">è§’è‰²åç§°ï¼š</label>
                        <input type="text" id="character-name-input" placeholder="è¯·è¾“å…¥è§’è‰²åç§°" class="time-input" />
                    </div>
                    <div class="form-group">
                        <label for="character-trust-input">è§’è‰²ç½®ä¿¡åº¦ï¼š</label>
                        <input type="text" id="character-trust-input" placeholder="å–å€¼èŒƒå›´0-1ï¼ˆé»˜è®¤0.75ï¼‰" class="time-input" />
                    </div>
                    <div class="form-group">
                        <label for="character-importance-input">è§’è‰²é‡è¦æ€§ï¼š</label>
                        <input type="text" id="character-importance-input" placeholder="å–å€¼èŒƒå›´0-1ï¼ˆé»˜è®¤0.75ï¼‰" class="time-input" />
                    </div>
                    <div class="form-group">
                        <label for="character-context-input">ä¸Šä¸‹æ–‡ç¯å¢ƒï¼š</label>
                        <input type="text" id="character-context-input" value="realityç°å®" placeholder="è¾“å…¥ä¸Šä¸‹æ–‡ç¯å¢ƒ" class="time-input" />
                    </div>
                    <div class="form-buttons">
                        <button class="create-btn" onclick="createCharacterNode()">åˆ›å»ºè§’è‰²èŠ‚ç‚¹</button>
                        <button class="cancel-btn" onclick="hideUserInputForm()">å–æ¶ˆ</button>
                    </div>
                </div>
            `;
            
            // èšç„¦åˆ°è¾“å…¥æ¡†
            setTimeout(() => {
                document.getElementById('character-name-input').focus();
            }, 100);
        }
        
        // æ˜¾ç¤ºåœ°ç‚¹èŠ‚ç‚¹åˆ›å»ºè¡¨å•
        function showLocationNodeForm() {
            const userInputForm = document.getElementById('user-input-form');
            userInputForm.style.display = 'block';
            userInputForm.innerHTML = `
                <div class="location-node-form">
                    <h4>åˆ›å»ºåœ°ç‚¹èŠ‚ç‚¹</h4>
                    <div class="form-group">
                        <label for="location-name-input">åœ°ç‚¹åç§°ï¼š</label>
                        <input type="text" id="location-name-input" placeholder="è¯·è¾“å…¥åœ°ç‚¹åç§°" class="time-input" />
                    </div>
                    <div class="form-group">
                        <label for="location-context-input">ä¸Šä¸‹æ–‡ç¯å¢ƒï¼š</label>
                        <input type="text" id="location-context-input" value="realityç°å®" placeholder="è¾“å…¥ä¸Šä¸‹æ–‡ç¯å¢ƒ" class="time-input" />
                    </div>
                    <div class="form-buttons">
                        <button class="create-btn" onclick="createLocationNode()">åˆ›å»ºåœ°ç‚¹èŠ‚ç‚¹</button>
                        <button class="cancel-btn" onclick="hideUserInputForm()">å–æ¶ˆ</button>
                    </div>
                </div>
            `;
            
            // èšç„¦åˆ°è¾“å…¥æ¡†
            setTimeout(() => {
                document.getElementById('location-name-input').focus();
            }, 100);
        }
        
        // éšè—ç”¨æˆ·è¾“å…¥è¡¨å•
        function hideUserInputForm() {
            const userInputForm = document.getElementById('user-input-form');
            userInputForm.style.display = 'none';
            userInputForm.innerHTML = '';
            
            // é‡ç½®æŒ‰é’®é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.node-type-button').forEach(btn => {
                btn.classList.remove('selected');
            });
        }
        
        // åˆ›å»ºæ—¶é—´èŠ‚ç‚¹
        function createTimeNode() {
            const timeInput = document.getElementById('time-input');
            const timeStr = timeInput.value.trim();
            
            if (!timeStr) {
                alert('è¯·è¾“å…¥æ—¶é—´ä¿¡æ¯');
                timeInput.focus();
                return;
            }
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const createBtn = document.querySelector('.create-btn');
            const originalText = createBtn.textContent;
            createBtn.textContent = 'åˆ›å»ºä¸­...';
            createBtn.disabled = true;
            
            // è°ƒç”¨APIåˆ›å»ºæ—¶é—´èŠ‚ç‚¹
            fetch('/api/create_time_node', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    time_str: timeStr
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    hideUserInputForm();
                    hideEditForms();
                    // ä½¿ç”¨åŠ¨æ€æ›´æ–°ä»£æ›¿é¡µé¢åˆ·æ–°
                    updateGraphData().then(updateSuccess => {
                        if (updateSuccess) {
                            alert(`æ—¶é—´èŠ‚ç‚¹åˆ›å»ºæˆåŠŸ: ${data.message}\n\nå›¾è°±å·²è‡ªåŠ¨æ›´æ–°æ˜¾ç¤ºæœ€æ–°æ•°æ®ã€‚`);
                        } else {
                            alert(`æ—¶é—´èŠ‚ç‚¹åˆ›å»ºæˆåŠŸ: ${data.message}\n\nå›¾è°±æ•°æ®æ›´æ–°å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨åˆ·æ–°é¡µé¢ã€‚`);
                        }
                    });
                } else {
                    alert(`æ—¶é—´èŠ‚ç‚¹åˆ›å»ºå¤±è´¥: ${data.error}`);
                }
            })
            .catch(error => {
                console.error('åˆ›å»ºæ—¶é—´èŠ‚ç‚¹æ—¶å‡ºé”™:', error);
                alert('åˆ›å»ºæ—¶é—´èŠ‚ç‚¹æ—¶å‡ºé”™: ' + error.message);
            })
            .finally(() => {
                createBtn.textContent = originalText;
                createBtn.disabled = false;
            });
        }
        
        // åˆ›å»ºå®ä½“èŠ‚ç‚¹
        function createEntityNode() {
            const nameInput = document.getElementById('entity-name-input');
            const importanceInput = document.getElementById('entity-importance-input');
            const descriptionInput = document.getElementById('entity-description-input');
            const contextInput = document.getElementById('entity-context-input');
            const entityName = nameInput.value.trim();
            const importance = parseFloat(importanceInput.value.trim()) || 0.5;
            const entityDescription = descriptionInput.value.trim() || 'æ— ';
            const context = contextInput.value.trim() || 'realityç°å®';
            
            if (!entityName) {
                alert('è¯·è¾“å…¥å®ä½“åç§°');
                nameInput.focus();
                return;
            }
            
            // éªŒè¯é‡è¦æ€§èŒƒå›´
            if (importance < 0 || importance > 1) {
                alert('å®ä½“é‡è¦æ€§å¿…é¡»åœ¨0-1ä¹‹é—´');
                importanceInput.focus();
                return;
            }
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const createBtn = document.querySelector('.create-btn');
            const originalText = createBtn.textContent;
            createBtn.textContent = 'åˆ›å»ºä¸­...';
            createBtn.disabled = true;
            
            // è°ƒç”¨APIåˆ›å»ºå®ä½“èŠ‚ç‚¹
            fetch('/api/create_entity_node', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    entity_name: entityName,
                    importance: importance,
                    context: context,
                    note: entityDescription
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    hideUserInputForm();
                    hideEditForms();
                    // ä½¿ç”¨åŠ¨æ€æ›´æ–°ä»£æ›¿é¡µé¢åˆ·æ–°
                    updateGraphData().then(updateSuccess => {
                        if (updateSuccess) {
                            alert(`å®ä½“èŠ‚ç‚¹åˆ›å»ºæˆåŠŸ: ${data.message}\n\nå›¾è°±å·²è‡ªåŠ¨æ›´æ–°æ˜¾ç¤ºæœ€æ–°æ•°æ®ã€‚`);
                        } else {
                            alert(`å®ä½“èŠ‚ç‚¹åˆ›å»ºæˆåŠŸ: ${data.message}\n\nå›¾è°±æ•°æ®æ›´æ–°å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨åˆ·æ–°é¡µé¢ã€‚`);
                        }
                    });
                } else {
                    alert(`å®ä½“èŠ‚ç‚¹åˆ›å»ºå¤±è´¥: ${data.error}`);
                }
            })
            .catch(error => {
                console.error('åˆ›å»ºå®ä½“èŠ‚ç‚¹æ—¶å‡ºé”™:', error);
                alert('åˆ›å»ºå®ä½“èŠ‚ç‚¹æ—¶å‡ºé”™: ' + error.message);
            })
            .finally(() => {
                createBtn.textContent = originalText;
                createBtn.disabled = false;
            });
        }
        
        // åˆ›å»ºè§’è‰²èŠ‚ç‚¹
        function createCharacterNode() {
            const nameInput = document.getElementById('character-name-input');
            const trustInput = document.getElementById('character-trust-input');
            const importanceInput = document.getElementById('character-importance-input');
            const contextInput = document.getElementById('character-context-input');
            const characterName = nameInput.value.trim();
            const trust = parseFloat(trustInput.value.trim()) || 0.5;
            const importance = parseFloat(importanceInput.value.trim()) || 0.5;
            const context = contextInput.value.trim() || 'realityç°å®';
            
            if (!characterName) {
                alert('è¯·è¾“å…¥è§’è‰²åç§°');
                nameInput.focus();
                return;
            }
            
            // éªŒè¯ç½®ä¿¡åº¦å’Œé‡è¦æ€§èŒƒå›´
            if (trust < 0 || trust > 1) {
                alert('è§’è‰²ç½®ä¿¡åº¦å¿…é¡»åœ¨0-1ä¹‹é—´');
                trustInput.focus();
                return;
            }
            
            if (importance < 0 || importance > 1) {
                alert('è§’è‰²é‡è¦æ€§å¿…é¡»åœ¨0-1ä¹‹é—´');
                importanceInput.focus();
                return;
            }
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const createBtn = document.querySelector('.create-btn');
            const originalText = createBtn.textContent;
            createBtn.textContent = 'åˆ›å»ºä¸­...';
            createBtn.disabled = true;
            
            // è°ƒç”¨APIåˆ›å»ºè§’è‰²èŠ‚ç‚¹
            fetch('/api/create_character_node', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    character_name: characterName,
                    trust: trust,
                    importance: importance,
                    context: context
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    hideUserInputForm();
                    hideEditForms();
                    // ä½¿ç”¨åŠ¨æ€æ›´æ–°ä»£æ›¿é¡µé¢åˆ·æ–°
                    updateGraphData().then(updateSuccess => {
                        if (updateSuccess) {
                            alert(`è§’è‰²èŠ‚ç‚¹åˆ›å»ºæˆåŠŸ: ${data.message}\n\nå›¾è°±å·²è‡ªåŠ¨æ›´æ–°æ˜¾ç¤ºæœ€æ–°æ•°æ®ã€‚`);
                        } else {
                            alert(`è§’è‰²èŠ‚ç‚¹åˆ›å»ºæˆåŠŸ: ${data.message}\n\nå›¾è°±æ•°æ®æ›´æ–°å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨åˆ·æ–°é¡µé¢ã€‚`);
                        }
                    });
                } else {
                    alert(`è§’è‰²èŠ‚ç‚¹åˆ›å»ºå¤±è´¥: ${data.error}`);
                }
            })
            .catch(error => {
                console.error('åˆ›å»ºè§’è‰²èŠ‚ç‚¹æ—¶å‡ºé”™:', error);
                alert('åˆ›å»ºè§’è‰²èŠ‚ç‚¹æ—¶å‡ºé”™: ' + error.message);
            })
            .finally(() => {
                createBtn.textContent = originalText;
                createBtn.disabled = false;
            });
        }
        
        // åˆ›å»ºåœ°ç‚¹èŠ‚ç‚¹
        function createLocationNode() {
            const nameInput = document.getElementById('location-name-input');
            const contextInput = document.getElementById('location-context-input');
            const locationName = nameInput.value.trim();
            const context = contextInput.value.trim() || 'realityç°å®';
            
            if (!locationName) {
                alert('è¯·è¾“å…¥åœ°ç‚¹åç§°');
                nameInput.focus();
                return;
            }
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const createBtn = document.querySelector('.create-btn');
            const originalText = createBtn.textContent;
            createBtn.textContent = 'åˆ›å»ºä¸­...';
            createBtn.disabled = true;
            
            // è°ƒç”¨APIåˆ›å»ºåœ°ç‚¹èŠ‚ç‚¹
            fetch('/api/create_location_node', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    location_name: locationName,
                    context: context
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    hideUserInputForm();
                    hideEditForms();
                    // ä½¿ç”¨åŠ¨æ€æ›´æ–°ä»£æ›¿é¡µé¢åˆ·æ–°
                    updateGraphData().then(updateSuccess => {
                        if (updateSuccess) {
                            alert(`åœ°ç‚¹èŠ‚ç‚¹åˆ›å»ºæˆåŠŸ: ${data.message}\n\nå›¾è°±å·²è‡ªåŠ¨æ›´æ–°æ˜¾ç¤ºæœ€æ–°æ•°æ®ã€‚`);
                        } else {
                            alert(`åœ°ç‚¹èŠ‚ç‚¹åˆ›å»ºæˆåŠŸ: ${data.message}\n\nå›¾è°±æ•°æ®æ›´æ–°å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨åˆ·æ–°é¡µé¢ã€‚`);
                        }
                    });
                } else {
                    alert(`åœ°ç‚¹èŠ‚ç‚¹åˆ›å»ºå¤±è´¥: ${data.error}`);
                }
            })
            .catch(error => {
                console.error('åˆ›å»ºåœ°ç‚¹èŠ‚ç‚¹æ—¶å‡ºé”™:', error);
                alert('åˆ›å»ºåœ°ç‚¹èŠ‚ç‚¹æ—¶å‡ºé”™: ' + error.message);
            })
            .finally(() => {
                createBtn.textContent = originalText;
                createBtn.disabled = false;
            });
        }
        
        function saveNodeToLocalMemory(nodeData) {
            // åŠŸèƒ½å·²ç¦ç”¨
        }
        
        function cleanupNodeCreation() {
            // åŠŸèƒ½å·²ç¦ç”¨
        }
        
        function deleteNode() {
            // åŠŸèƒ½å·²ç¦ç”¨
        }
        
        function updateVisualization() {
            // æ›´æ–°èŠ‚ç‚¹é€‰æ‹©åˆ—è¡¨
            updateNodeSelectionLists();
            
            // å¤„ç†åŒå‘å…³ç³»
            detectBidirectionalLinks(graphData.links);
            
            // æ›´æ–°åŠ›å¯¼å‘å›¾æ•°æ®
            simulation.nodes(graphData.nodes);
            simulation.force("link").links(graphData.links);
            
            // é‡æ–°ç»‘å®šå¹¶æ›´æ–°èŠ‚ç‚¹
            node = node.data(graphData.nodes, d => d.id);
            node.exit().remove();
            node = node.enter().append("circle")
                .attr("class", "node")
                .attr("r", d => d.size)
                .attr("fill", d => d.color)
                .attr("stroke", d => d.strokeColor)
                .attr("stroke-width", d => d.strokeWidth)
                .on("click", showNodeDetails)
                .call(d3.drag()
                    .on("start", dragstarted)
                    .on("drag", dragged)
                    .on("end", dragended))
                .merge(node);
            
            // æ›´æ–°æ‰€æœ‰èŠ‚ç‚¹çš„å±æ€§ï¼ˆåŒ…æ‹¬ç°æœ‰çš„ï¼‰
            node.attr("r", d => d.size)
                .attr("fill", d => d.color)
                .attr("stroke", d => d.strokeColor)
                .attr("stroke-width", d => d.strokeWidth);
            
            // é‡æ–°ç»‘å®šå¹¶æ›´æ–°é“¾æ¥
            link = link.data(graphData.links, d => d.neo4j_id || d.id);
            link.exit().remove();
            link = link.enter().append("line")
                .attr("class", "link")
                .attr("marker-end", d => getStorageTypeArrow(d.source_type))
                .attr("stroke", d => getStorageTypeColor(d.source_type))
                .attr("stroke-width", "2")
                .on("click", showLinkDetails)
                .merge(link);
            
            // æ›´æ–°æ‰€æœ‰é“¾æ¥çš„é¢œè‰²ï¼ˆåŒ…æ‹¬ç°æœ‰çš„ï¼‰
            link.attr("stroke", d => {
                    // è°ƒè¯•ï¼šæ‰“å°å…³ç³»çš„source_type
                    console.log('æ›´æ–°å…³ç³»é¢œè‰² - ID:', d.neo4j_id, 'Type:', d.type, 'Source_type:', d.source_type);
                    
                    // æ ¹æ®å­˜å‚¨ä½ç½®è®¾ç½®é¢œè‰²
                    if (!d.source_type || !STORAGE_TYPE_COLORS[d.source_type]) {
                        console.warn('æ›´æ–°æ—¶å…³ç³»æœªçŸ¥å­˜å‚¨ä½ç½®:', d.source_type, 'å…³ç³»:', d);
                    }
                    return getStorageTypeColor(d.source_type);
                })
                .attr("marker-end", d => getStorageTypeArrow(d.source_type));
            
            // é‡æ–°ç»‘å®šå¹¶æ›´æ–°èŠ‚ç‚¹æ ‡ç­¾
            nodeLabels = nodeLabels.data(graphData.nodes, d => d.id);
            nodeLabels.exit().remove();
            nodeLabels = nodeLabels.enter().append("text")
                .attr("class", "node-label")
                .text(d => d.label.length > 8 ? d.label.substring(0, 8) + "..." : d.label)
                .style("display", "block")
                .merge(nodeLabels);
            
            // æ›´æ–°æ‰€æœ‰èŠ‚ç‚¹æ ‡ç­¾çš„æ–‡æœ¬å†…å®¹ï¼ˆåŒ…æ‹¬ç°æœ‰çš„ï¼‰
            nodeLabels.text(d => d.label.length > 8 ? d.label.substring(0, 8) + "..." : d.label);
            
            // é‡æ–°ç»‘å®šå¹¶æ›´æ–°é“¾æ¥æ ‡ç­¾
            linkLabels = linkLabels.data(graphData.links, d => d.neo4j_id || d.id);
            linkLabels.exit().remove();
            linkLabels = linkLabels.enter().append("text")
                .attr("class", "link-label")
                .text(d => {
                    // æ˜¾ç¤ºå…³ç³»ç±»å‹ï¼šä¼˜å…ˆæ˜¾ç¤ºpredicate > action > type
                    if (d.properties && d.properties.predicate) {
                        return d.properties.predicate;
                    } else if (d.properties && d.properties.action) {
                        return d.properties.action;
                    } else {
                        return d.type;
                    }
                })
                .style("display", "block")
                .merge(linkLabels);
            
            // æ›´æ–°ç°æœ‰æ ‡ç­¾çš„æ–‡æœ¬å†…å®¹
            linkLabels.text(d => {
                // æ˜¾ç¤ºå…³ç³»ç±»å‹ï¼šä¼˜å…ˆæ˜¾ç¤ºpredicate > action > type
                if (d.properties && d.properties.predicate) {
                    return d.properties.predicate;
                } else if (d.properties && d.properties.action) {
                    return d.properties.action;
                } else {
                    return d.type;
                }
            });
            
            // é‡æ–°ç»‘å®šå¹¶æ›´æ–°é“¾æ¥æ ‡ç­¾èƒŒæ™¯
            linkLabelBgs = linkLabelBgs.data(graphData.links, d => d.neo4j_id || d.id);
            linkLabelBgs.exit().remove();
            linkLabelBgs = linkLabelBgs.enter().append("rect")
                .attr("class", "link-label-bg")
                .attr("fill", "rgba(255,255,255,0.8)")
                .attr("stroke", "rgba(200,200,200,0.5)")
                .attr("stroke-width", 0.5)
                .attr("rx", 3)
                .attr("ry", 3)
                .merge(linkLabelBgs);
            
            // åº”ç”¨å½“å‰çš„æ ‡ç­¾å¯è§æ€§çŠ¶æ€
            nodeLabels.style("display", nodeLabelsVisible ? "block" : "none");
            linkLabels.style("display", linkLabelsVisible ? "block" : "none");
            linkLabelBgs.style("display", linkLabelsVisible ? "block" : "none");
            
            // é‡æ–°å¯åŠ¨ä»¿çœŸ
            simulation.alpha(1).restart();
        }
        
        // åˆå§‹åŒ–
        initStats();
        initEditButtonState();
        
        // åˆå§‹åŒ–ç¼–è¾‘æŒ‰é’®çŠ¶æ€
        function initEditButtonState() {
            const editButton = document.getElementById('edit-button');
            const neo4jConnected = graphData.neo4j_connected;
            
            console.log('ğŸ” Neo4jè¿æ¥çŠ¶æ€æ£€æŸ¥:', neo4jConnected);
            console.log('ğŸ” å®Œæ•´graphData:', graphData);
            console.log('ğŸ” ç¼–è¾‘æŒ‰é’®å…ƒç´ :', editButton);
            
            if (!editButton) {
                console.error('âŒ æ— æ³•æ‰¾åˆ°ç¼–è¾‘æŒ‰é’®å…ƒç´ ');
                return;
            }
            
            if (!neo4jConnected) {
                console.log('âŒ Neo4jæœªè¿æ¥ï¼Œç¦ç”¨ç¼–è¾‘æŒ‰é’®');
                editButton.disabled = true;
                editButton.className = 'control-button edit-controls';
                editButton.title = 'Neo4jæ•°æ®åº“æœªè¿æ¥ï¼Œæ— æ³•ç¼–è¾‘èŠ‚ç‚¹';
                editButton.onclick = function(event) {
                    event.preventDefault();
                    alert('Neo4jæ•°æ®åº“æœªè¿æ¥ï¼Œæ— æ³•è¿›è¡ŒèŠ‚ç‚¹ç¼–è¾‘æ“ä½œã€‚\\n\\nè¯·æ£€æŸ¥ï¼š\\n1. Neo4jæœåŠ¡æ˜¯å¦å¯åŠ¨\\n2. ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸\\n3. é…ç½®æ–‡ä»¶ä¸­çš„è¿æ¥ä¿¡æ¯æ˜¯å¦æ­£ç¡®');
                };
            } else {
                console.log('âœ… Neo4jå·²è¿æ¥ï¼Œå¯ç”¨ç¼–è¾‘æŒ‰é’®');
                editButton.disabled = false;
                editButton.className = 'control-button edit-controls';
                editButton.title = 'ç¼–è¾‘è®°å¿†å›¾è°±èŠ‚ç‚¹';
                editButton.onclick = function(event) {
                    event.preventDefault();
                    toggleEditPanel();
                };
            }
        }
        
        // ä¿®æ”¹toggleEditPanelå‡½æ•°ï¼Œå¢åŠ è¿æ¥çŠ¶æ€æ£€æŸ¥
        function toggleEditPanel() {
            console.log('ğŸ”„ toggleEditPanelè¢«è°ƒç”¨');
            console.log('ğŸ” å½“å‰Neo4jè¿æ¥çŠ¶æ€:', graphData.neo4j_connected);
            
            if (!graphData.neo4j_connected) {
                console.log('âŒ Neo4jæœªè¿æ¥ï¼Œé˜»æ­¢é¢æ¿æ‰“å¼€');
                alert('Neo4jæ•°æ®åº“æœªè¿æ¥ï¼Œæ— æ³•è¿›è¡ŒèŠ‚ç‚¹ç¼–è¾‘æ“ä½œã€‚');
                return;
            }
            
            console.log('âœ… Neo4jå·²è¿æ¥ï¼Œåˆ‡æ¢ç¼–è¾‘é¢æ¿');
            const panel = document.getElementById('edit-panel');
            panel.classList.toggle('show');
            
            // å¦‚æœæ‰“å¼€é¢æ¿ï¼Œæ›´æ–°èŠ‚ç‚¹é€‰æ‹©åˆ—è¡¨
            if (panel.classList.contains('show')) {
                console.log('ğŸ“‹ æ›´æ–°èŠ‚ç‚¹é€‰æ‹©åˆ—è¡¨');
                updateNodeSelectionLists();
            }
        }
        
        // æµ‹è¯•APIè¿æ¥çš„å‡½æ•°
        window.testApiConnection = function() {
            console.log('ğŸ§ª æµ‹è¯•APIè¿æ¥');
            fetch('/api/create_time_node', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    time_str: 'æµ‹è¯•æ—¶é—´'
                })
            })
            .then(response => {
                console.log('APIå“åº”çŠ¶æ€:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('APIå“åº”æ•°æ®:', data);
                alert('APIè¿æ¥æµ‹è¯•å®Œæˆï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°');
            })
            .catch(error => {
                console.error('APIè¿æ¥æµ‹è¯•å¤±è´¥:', error);
                alert('APIè¿æ¥å¤±è´¥: ' + error.message);
            });
        };
        
        // æ·»åŠ ESCé”®ç›‘å¬æ¥å–æ¶ˆèŠ‚ç‚¹åˆ›å»º
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape' && isCreatingNode) {
                cleanupNodeCreation();
            }
        });
        
        // å®¢æˆ·ç«¯ç”Ÿå‘½å‘¨æœŸç®¡ç†
        let heartbeatInterval = null;
        let disconnectSent = false; // é˜²æ­¢é‡å¤å‘é€æ–­å¼€è¿æ¥é€šçŸ¥
        
        // å¯åŠ¨å¿ƒè·³
        function startHeartbeat() {
            // ç«‹å³å‘é€ä¸€æ¬¡å¿ƒè·³
            sendHeartbeat();
            
            // æ¯60ç§’å‘é€ä¸€æ¬¡å¿ƒè·³
            heartbeatInterval = setInterval(sendHeartbeat, 60000);
        }
        
        // å‘é€å¿ƒè·³
        function sendHeartbeat() {
            fetch('/api/heartbeat', {
                method: 'GET'
            }).catch(error => {
                console.log('å¿ƒè·³å‘é€å¤±è´¥:', error);
            });
        }
        

        
        // é€šçŸ¥æœåŠ¡å™¨å®¢æˆ·ç«¯æ–­å¼€è¿æ¥
        function notifyDisconnect() {
            // é˜²æ­¢é‡å¤å‘é€æ–­å¼€è¿æ¥é€šçŸ¥
            if (disconnectSent) {
                return;
            }
            disconnectSent = true;
            
            console.log('å‘é€æ–­å¼€è¿æ¥é€šçŸ¥');
            
            // åœæ­¢å¿ƒè·³ï¼ˆå¦‚æœæ­£åœ¨è¿è¡Œï¼‰
            if (heartbeatInterval) {
                clearInterval(heartbeatInterval);
                heartbeatInterval = null;
            }
            
            const payload = JSON.stringify({
                action: 'disconnect',
                timestamp: Date.now()
            });
            
            // ä¼˜å…ˆä½¿ç”¨åŒæ­¥è¯·æ±‚ï¼ˆæ›´å¯é ï¼Œå°¤å…¶åœ¨æµè§ˆå™¨å…³é—­æ—¶ï¼‰
            try {
                console.log('ä½¿ç”¨åŒæ­¥XMLHttpRequestå‘é€æ–­å¼€è¿æ¥é€šçŸ¥');
                const xhr = new XMLHttpRequest();
                xhr.open('POST', '/api/disconnect', false); // åŒæ­¥è¯·æ±‚
                xhr.setRequestHeader('Content-Type', 'application/json');
                xhr.timeout = 1000; // 1ç§’è¶…æ—¶
                xhr.send(payload);
                console.log('åŒæ­¥è¯·æ±‚å‘é€å®Œæˆï¼ŒçŠ¶æ€:', xhr.status);
            } catch (error) {
                console.warn('åŒæ­¥è¯·æ±‚å¤±è´¥ï¼Œå°è¯•sendBeacon:', error);
                // å¤‡ç”¨æ–¹æ¡ˆï¼šsendBeacon
                if (navigator.sendBeacon) {
                    const blob = new Blob([payload], { type: 'application/json' });
                    const success = navigator.sendBeacon('/api/disconnect', blob);
                    console.log('sendBeaconå¤‡ç”¨ç»“æœ:', success);
                }
            }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆåå¯åŠ¨å¿ƒè·³
        document.addEventListener('DOMContentLoaded', function() {
            startHeartbeat();
        });
        
        // é¡µé¢å…³é—­æ£€æµ‹æœºåˆ¶ï¼ˆé’ˆå¯¹Chromeæµè§ˆå™¨ç›´æ¥å…³é—­çš„é—®é¢˜ï¼‰
        
        // 1. beforeunload - ä¸»è¦æ–¹æ³•
        window.addEventListener('beforeunload', function(event) {
            console.log('beforeunloadäº‹ä»¶è§¦å‘');
            notifyDisconnect();
        });
        
        // 2. unload - å¤‡ç”¨æ–¹æ³•
        window.addEventListener('unload', function(event) {
            console.log('unloadäº‹ä»¶è§¦å‘');
            notifyDisconnect();
        });
        
        // 3. pagehide - ä»…åœ¨é¡µé¢çœŸæ­£è¢«å¸è½½æ—¶è§¦å‘ï¼ˆä¸æ˜¯è¢«ç¼“å­˜ï¼‰
        window.addEventListener('pagehide', function(event) {
            console.log('pagehideäº‹ä»¶è§¦å‘ï¼Œpersisted:', event.persisted);
            // åªæœ‰åœ¨é¡µé¢çœŸæ­£è¢«å¸è½½ï¼ˆä¸æ˜¯è¢«ç¼“å­˜ï¼‰æ—¶æ‰å‘é€æ–­å¼€è¿æ¥é€šçŸ¥
            if (!event.persisted) {
                notifyDisconnect();
            }
        });
        
    </script>
</body>
</html>